var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.arrayIteratorImpl=function(z){var M=0;return function(){return M<z.length?{done:!1,value:z[M++]}:{done:!0}}};$jscomp.arrayIterator=function(z){return{next:$jscomp.arrayIteratorImpl(z)}};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.SIMPLE_FROUND_POLYFILL=!1;$jscomp.ISOLATE_POLYFILLS=!1;$jscomp.FORCE_POLYFILL_PROMISE=!1;$jscomp.FORCE_POLYFILL_PROMISE_WHEN_NO_UNHANDLED_REJECTION=!1;
$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(z,M,q){if(z==Array.prototype||z==Object.prototype)return z;z[M]=q.value;return z};$jscomp.getGlobal=function(z){z=["object"==typeof globalThis&&globalThis,z,"object"==typeof window&&window,"object"==typeof self&&self,"object"==typeof global&&global];for(var M=0;M<z.length;++M){var q=z[M];if(q&&q.Math==Math)return q}throw Error("Cannot find global object");};$jscomp.global=$jscomp.getGlobal(this);
$jscomp.IS_SYMBOL_NATIVE="function"===typeof Symbol&&"symbol"===typeof Symbol("x");$jscomp.TRUST_ES6_POLYFILLS=!$jscomp.ISOLATE_POLYFILLS||$jscomp.IS_SYMBOL_NATIVE;$jscomp.polyfills={};$jscomp.propertyToPolyfillSymbol={};$jscomp.POLYFILL_PREFIX="$jscp$";var $jscomp$lookupPolyfilledValue=function(z,M){var q=$jscomp.propertyToPolyfillSymbol[M];if(null==q)return z[M];q=z[q];return void 0!==q?q:z[M]};
$jscomp.polyfill=function(z,M,q,S){M&&($jscomp.ISOLATE_POLYFILLS?$jscomp.polyfillIsolated(z,M,q,S):$jscomp.polyfillUnisolated(z,M,q,S))};$jscomp.polyfillUnisolated=function(z,M,q,S){q=$jscomp.global;z=z.split(".");for(S=0;S<z.length-1;S++){var P=z[S];if(!(P in q))return;q=q[P]}z=z[z.length-1];S=q[z];M=M(S);M!=S&&null!=M&&$jscomp.defineProperty(q,z,{configurable:!0,writable:!0,value:M})};
$jscomp.polyfillIsolated=function(z,M,q,S){var P=z.split(".");z=1===P.length;S=P[0];S=!z&&S in $jscomp.polyfills?$jscomp.polyfills:$jscomp.global;for(var U=0;U<P.length-1;U++){var V=P[U];if(!(V in S))return;S=S[V]}P=P[P.length-1];q=$jscomp.IS_SYMBOL_NATIVE&&"es6"===q?S[P]:null;M=M(q);null!=M&&(z?$jscomp.defineProperty($jscomp.polyfills,P,{configurable:!0,writable:!0,value:M}):M!==q&&(void 0===$jscomp.propertyToPolyfillSymbol[P]&&(q=1E9*Math.random()>>>0,$jscomp.propertyToPolyfillSymbol[P]=$jscomp.IS_SYMBOL_NATIVE?
$jscomp.global.Symbol(P):$jscomp.POLYFILL_PREFIX+q+"$"+P),$jscomp.defineProperty(S,$jscomp.propertyToPolyfillSymbol[P],{configurable:!0,writable:!0,value:M})))};$jscomp.initSymbol=function(){};
$jscomp.polyfill("Symbol",function(z){if(z)return z;var M=function(U,V){this.$jscomp$symbol$id_=U;$jscomp.defineProperty(this,"description",{configurable:!0,writable:!0,value:V})};M.prototype.toString=function(){return this.$jscomp$symbol$id_};var q="jscomp_symbol_"+(1E9*Math.random()>>>0)+"_",S=0,P=function(U){if(this instanceof P)throw new TypeError("Symbol is not a constructor");return new M(q+(U||"")+"_"+S++,U)};return P},"es6","es3");
$jscomp.polyfill("Symbol.iterator",function(z){if(z)return z;z=Symbol("Symbol.iterator");for(var M="Array Int8Array Uint8Array Uint8ClampedArray Int16Array Uint16Array Int32Array Uint32Array Float32Array Float64Array".split(" "),q=0;q<M.length;q++){var S=$jscomp.global[M[q]];"function"===typeof S&&"function"!=typeof S.prototype[z]&&$jscomp.defineProperty(S.prototype,z,{configurable:!0,writable:!0,value:function(){return $jscomp.iteratorPrototype($jscomp.arrayIteratorImpl(this))}})}return z},"es6",
"es3");$jscomp.iteratorPrototype=function(z){z={next:z};z[Symbol.iterator]=function(){return this};return z};$jscomp.iteratorFromArray=function(z,M){z instanceof String&&(z+="");var q=0,S=!1,P={next:function(){if(!S&&q<z.length){var U=q++;return{value:M(U,z[U]),done:!1}}S=!0;return{done:!0,value:void 0}}};P[Symbol.iterator]=function(){return P};return P};$jscomp.polyfill("Array.prototype.keys",function(z){return z?z:function(){return $jscomp.iteratorFromArray(this,function(M){return M})}},"es6","es3");
(function(z){var M;"undefined"==typeof exports?"function"==typeof define&&"object"==typeof define.amd&&define.amd?(M={},define(function(){return M})):M="undefined"!=typeof window?window:z:M=exports;(function(q){if(!S)var S=1E-6;if(!P)var P="undefined"!=typeof Float32Array?Float32Array:Array;if(!U)var U=Math.random;var V={setMatrixArrayType:function(a){P=a}};"undefined"!=typeof q&&(q.glMatrix=V);var Y=Math.PI/180;V.toRadian=function(a){return a*Y};var L={create:function(){var a=new P(2);return a[0]=
0,a[1]=0,a},clone:function(a){var b=new P(2);return b[0]=a[0],b[1]=a[1],b},fromValues:function(a,b){var d=new P(2);return d[0]=a,d[1]=b,d},copy:function(a,b){return a[0]=b[0],a[1]=b[1],a},set:function(a,b,d){return a[0]=b,a[1]=d,a},add:function(a,b,d){return a[0]=b[0]+d[0],a[1]=b[1]+d[1],a},subtract:function(a,b,d){return a[0]=b[0]-d[0],a[1]=b[1]-d[1],a}};L.sub=L.subtract;L.multiply=function(a,b,d){return a[0]=b[0]*d[0],a[1]=b[1]*d[1],a};L.mul=L.multiply;L.divide=function(a,b,d){return a[0]=b[0]/
d[0],a[1]=b[1]/d[1],a};L.div=L.divide;L.min=function(a,b,d){return a[0]=Math.min(b[0],d[0]),a[1]=Math.min(b[1],d[1]),a};L.max=function(a,b,d){return a[0]=Math.max(b[0],d[0]),a[1]=Math.max(b[1],d[1]),a};L.scale=function(a,b,d){return a[0]=b[0]*d,a[1]=b[1]*d,a};L.scaleAndAdd=function(a,b,d,f){return a[0]=b[0]+d[0]*f,a[1]=b[1]+d[1]*f,a};L.distance=function(a,b){var d=b[0]-a[0];a=b[1]-a[1];return Math.sqrt(d*d+a*a)};L.dist=L.distance;L.squaredDistance=function(a,b){var d=b[0]-a[0];a=b[1]-a[1];return d*
d+a*a};L.sqrDist=L.squaredDistance;L.length=function(a){var b=a[0];a=a[1];return Math.sqrt(b*b+a*a)};L.len=L.length;L.squaredLength=function(a){var b=a[0];a=a[1];return b*b+a*a};L.sqrLen=L.squaredLength;L.negate=function(a,b){return a[0]=-b[0],a[1]=-b[1],a};L.normalize=function(a,b){var d=b[0],f=b[1];d=d*d+f*f;return 0<d&&(d=1/Math.sqrt(d),a[0]=b[0]*d,a[1]=b[1]*d),a};L.dot=function(a,b){return a[0]*b[0]+a[1]*b[1]};L.cross=function(a,b,d){b=b[0]*d[1]-b[1]*d[0];return a[0]=a[1]=0,a[2]=b,a};L._lerp=
function(a,b,d,f){var k=b[0];b=b[1];return a[0]=k+f*(d[0]-k),a[1]=b+f*(d[1]-b),a};L.random=function(a,b){b=b||1;var d=2*U()*Math.PI;return a[0]=Math.cos(d)*b,a[1]=Math.sin(d)*b,a};L.transformMat2=function(a,b,d){var f=b[0];b=b[1];return a[0]=d[0]*f+d[2]*b,a[1]=d[1]*f+d[3]*b,a};L.transformMat2d=function(a,b,d){var f=b[0];b=b[1];return a[0]=d[0]*f+d[2]*b+d[4],a[1]=d[1]*f+d[3]*b+d[5],a};L.transformMat3=function(a,b,d){var f=b[0];b=b[1];return a[0]=d[0]*f+d[3]*b+d[6],a[1]=d[1]*f+d[4]*b+d[7],a};L.transformMat4=
function(a,b,d){var f=b[0];b=b[1];return a[0]=d[0]*f+d[4]*b+d[12],a[1]=d[1]*f+d[5]*b+d[13],a};L.forEach=function(){var a=L.create();return function(b,d,f,k,l,m){var r;d||(d=2);f||(f=0);for(k?r=Math.min(k*d+f,b.length):r=b.length;f<r;f+=d)a[0]=b[f],a[1]=b[f+1],l(a,a,m),b[f]=a[0],b[f+1]=a[1];return b}}();L.str=function(a){return"vec2("+a[0]+", "+a[1]+")"};"undefined"!=typeof q&&(q.vec2=L);var N={create:function(){var a=new P(3);return a[0]=0,a[1]=0,a[2]=0,a},clone:function(a){var b=new P(3);return b[0]=
a[0],b[1]=a[1],b[2]=a[2],b},fromValues:function(a,b,d){var f=new P(3);return f[0]=a,f[1]=b,f[2]=d,f},copy:function(a,b){return a[0]=b[0],a[1]=b[1],a[2]=b[2],a},set:function(a,b,d,f){return a[0]=b,a[1]=d,a[2]=f,a},add:function(a,b,d){return a[0]=b[0]+d[0],a[1]=b[1]+d[1],a[2]=b[2]+d[2],a},subtract:function(a,b,d){return a[0]=b[0]-d[0],a[1]=b[1]-d[1],a[2]=b[2]-d[2],a}};N.sub=N.subtract;N.multiply=function(a,b,d){return a[0]=b[0]*d[0],a[1]=b[1]*d[1],a[2]=b[2]*d[2],a};N.mul=N.multiply;N.divide=function(a,
b,d){return a[0]=b[0]/d[0],a[1]=b[1]/d[1],a[2]=b[2]/d[2],a};N.div=N.divide;N.min=function(a,b,d){return a[0]=Math.min(b[0],d[0]),a[1]=Math.min(b[1],d[1]),a[2]=Math.min(b[2],d[2]),a};N.max=function(a,b,d){return a[0]=Math.max(b[0],d[0]),a[1]=Math.max(b[1],d[1]),a[2]=Math.max(b[2],d[2]),a};N.scale=function(a,b,d){return a[0]=b[0]*d,a[1]=b[1]*d,a[2]=b[2]*d,a};N.scaleAndAdd=function(a,b,d,f){return a[0]=b[0]+d[0]*f,a[1]=b[1]+d[1]*f,a[2]=b[2]+d[2]*f,a};N.distance=function(a,b){var d=b[0]-a[0],f=b[1]-a[1];
a=b[2]-a[2];return Math.sqrt(d*d+f*f+a*a)};N.dist=N.distance;N.squaredDistance=function(a,b){var d=b[0]-a[0],f=b[1]-a[1];a=b[2]-a[2];return d*d+f*f+a*a};N.sqrDist=N.squaredDistance;N.length=function(a){var b=a[0],d=a[1];a=a[2];return Math.sqrt(b*b+d*d+a*a)};N.len=N.length;N.squaredLength=function(a){var b=a[0],d=a[1];a=a[2];return b*b+d*d+a*a};N.sqrLen=N.squaredLength;N.negate=function(a,b){return a[0]=-b[0],a[1]=-b[1],a[2]=-b[2],a};N.normalize=function(a,b){var d=b[0],f=b[1],k=b[2];d=d*d+f*f+k*k;
return 0<d&&(d=1/Math.sqrt(d),a[0]=b[0]*d,a[1]=b[1]*d,a[2]=b[2]*d),a};N.dot=function(a,b){return a[0]*b[0]+a[1]*b[1]+a[2]*b[2]};N.cross=function(a,b,d){var f=b[0],k=b[1];b=b[2];var l=d[0],m=d[1];d=d[2];return a[0]=k*d-b*m,a[1]=b*l-f*d,a[2]=f*m-k*l,a};N._lerp=function(a,b,d,f){var k=b[0],l=b[1];b=b[2];return a[0]=k+f*(d[0]-k),a[1]=l+f*(d[1]-l),a[2]=b+f*(d[2]-b),a};N.random=function(a,b){b=b||1;var d=2*U()*Math.PI,f=2*U()-1,k=Math.sqrt(1-f*f)*b;return a[0]=Math.cos(d)*k,a[1]=Math.sin(d)*k,a[2]=f*b,
a};N.transformMat4=function(a,b,d){var f=b[0],k=b[1];b=b[2];return a[0]=d[0]*f+d[4]*k+d[8]*b+d[12],a[1]=d[1]*f+d[5]*k+d[9]*b+d[13],a[2]=d[2]*f+d[6]*k+d[10]*b+d[14],a};N.transformMat3=function(a,b,d){var f=b[0],k=b[1];b=b[2];return a[0]=f*d[0]+k*d[3]+b*d[6],a[1]=f*d[1]+k*d[4]+b*d[7],a[2]=f*d[2]+k*d[5]+b*d[8],a};N.transformQuat=function(a,b,d){var f=b[0],k=b[1],l=b[2];b=d[0];var m=d[1],r=d[2];d=d[3];var n=d*f+m*l-r*k,p=d*k+r*f-b*l,w=d*l+b*k-m*f;f=-b*f-m*k-r*l;return a[0]=n*d+f*-b+p*-r-w*-m,a[1]=p*d+
f*-m+w*-b-n*-r,a[2]=w*d+f*-r+n*-m-p*-b,a};N.rotateX=function(a,b,d,f){var k=[],l=[];return k[0]=b[0]-d[0],k[1]=b[1]-d[1],k[2]=b[2]-d[2],l[0]=k[0],l[1]=k[1]*Math.cos(f)-k[2]*Math.sin(f),l[2]=k[1]*Math.sin(f)+k[2]*Math.cos(f),a[0]=l[0]+d[0],a[1]=l[1]+d[1],a[2]=l[2]+d[2],a};N.rotateY=function(a,b,d,f){var k=[],l=[];return k[0]=b[0]-d[0],k[1]=b[1]-d[1],k[2]=b[2]-d[2],l[0]=k[2]*Math.sin(f)+k[0]*Math.cos(f),l[1]=k[1],l[2]=k[2]*Math.cos(f)-k[0]*Math.sin(f),a[0]=l[0]+d[0],a[1]=l[1]+d[1],a[2]=l[2]+d[2],a};
N.rotateZ=function(a,b,d,f){var k=[],l=[];return k[0]=b[0]-d[0],k[1]=b[1]-d[1],k[2]=b[2]-d[2],l[0]=k[0]*Math.cos(f)-k[1]*Math.sin(f),l[1]=k[0]*Math.sin(f)+k[1]*Math.cos(f),l[2]=k[2],a[0]=l[0]+d[0],a[1]=l[1]+d[1],a[2]=l[2]+d[2],a};N.forEach=function(){var a=N.create();return function(b,d,f,k,l,m){var r;d||(d=3);f||(f=0);for(k?r=Math.min(k*d+f,b.length):r=b.length;f<r;f+=d)a[0]=b[f],a[1]=b[f+1],a[2]=b[f+2],l(a,a,m),b[f]=a[0],b[f+1]=a[1],b[f+2]=a[2];return b}}();N.str=function(a){return"vec3("+a[0]+
", "+a[1]+", "+a[2]+")"};"undefined"!=typeof q&&(q.vec3=N);var h={create:function(){var a=new P(4);return a[0]=0,a[1]=0,a[2]=0,a[3]=0,a},clone:function(a){var b=new P(4);return b[0]=a[0],b[1]=a[1],b[2]=a[2],b[3]=a[3],b},fromValues:function(a,b,d,f){var k=new P(4);return k[0]=a,k[1]=b,k[2]=d,k[3]=f,k},copy:function(a,b){return a[0]=b[0],a[1]=b[1],a[2]=b[2],a[3]=b[3],a},set:function(a,b,d,f,k){return a[0]=b,a[1]=d,a[2]=f,a[3]=k,a},add:function(a,b,d){return a[0]=b[0]+d[0],a[1]=b[1]+d[1],a[2]=b[2]+d[2],
a[3]=b[3]+d[3],a},subtract:function(a,b,d){return a[0]=b[0]-d[0],a[1]=b[1]-d[1],a[2]=b[2]-d[2],a[3]=b[3]-d[3],a}};h.sub=h.subtract;h.multiply=function(a,b,d){return a[0]=b[0]*d[0],a[1]=b[1]*d[1],a[2]=b[2]*d[2],a[3]=b[3]*d[3],a};h.mul=h.multiply;h.divide=function(a,b,d){return a[0]=b[0]/d[0],a[1]=b[1]/d[1],a[2]=b[2]/d[2],a[3]=b[3]/d[3],a};h.div=h.divide;h.min=function(a,b,d){return a[0]=Math.min(b[0],d[0]),a[1]=Math.min(b[1],d[1]),a[2]=Math.min(b[2],d[2]),a[3]=Math.min(b[3],d[3]),a};h.max=function(a,
b,d){return a[0]=Math.max(b[0],d[0]),a[1]=Math.max(b[1],d[1]),a[2]=Math.max(b[2],d[2]),a[3]=Math.max(b[3],d[3]),a};h.scale=function(a,b,d){return a[0]=b[0]*d,a[1]=b[1]*d,a[2]=b[2]*d,a[3]=b[3]*d,a};h.scaleAndAdd=function(a,b,d,f){return a[0]=b[0]+d[0]*f,a[1]=b[1]+d[1]*f,a[2]=b[2]+d[2]*f,a[3]=b[3]+d[3]*f,a};h.distance=function(a,b){var d=b[0]-a[0],f=b[1]-a[1],k=b[2]-a[2];a=b[3]-a[3];return Math.sqrt(d*d+f*f+k*k+a*a)};h.dist=h.distance;h.squaredDistance=function(a,b){var d=b[0]-a[0],f=b[1]-a[1],k=b[2]-
a[2];a=b[3]-a[3];return d*d+f*f+k*k+a*a};h.sqrDist=h.squaredDistance;h.length=function(a){var b=a[0],d=a[1],f=a[2];a=a[3];return Math.sqrt(b*b+d*d+f*f+a*a)};h.len=h.length;h.squaredLength=function(a){var b=a[0],d=a[1],f=a[2];a=a[3];return b*b+d*d+f*f+a*a};h.sqrLen=h.squaredLength;h.negate=function(a,b){return a[0]=-b[0],a[1]=-b[1],a[2]=-b[2],a[3]=-b[3],a};h.normalize=function(a,b){var d=b[0],f=b[1],k=b[2],l=b[3];d=d*d+f*f+k*k+l*l;return 0<d&&(d=1/Math.sqrt(d),a[0]=b[0]*d,a[1]=b[1]*d,a[2]=b[2]*d,a[3]=
b[3]*d),a};h.dot=function(a,b){return a[0]*b[0]+a[1]*b[1]+a[2]*b[2]+a[3]*b[3]};h._lerp=function(a,b,d,f){var k=b[0],l=b[1],m=b[2];b=b[3];return a[0]=k+f*(d[0]-k),a[1]=l+f*(d[1]-l),a[2]=m+f*(d[2]-m),a[3]=b+f*(d[3]-b),a};h.random=function(a,b){return b=b||1,a[0]=U(),a[1]=U(),a[2]=U(),a[3]=U(),h.normalize(a,a),h.scale(a,a,b),a};h.transformMat4=function(a,b,d){var f=b[0],k=b[1],l=b[2];b=b[3];return a[0]=d[0]*f+d[4]*k+d[8]*l+d[12]*b,a[1]=d[1]*f+d[5]*k+d[9]*l+d[13]*b,a[2]=d[2]*f+d[6]*k+d[10]*l+d[14]*b,
a[3]=d[3]*f+d[7]*k+d[11]*l+d[15]*b,a};h.transformQuat=function(a,b,d){var f=b[0],k=b[1],l=b[2];b=d[0];var m=d[1],r=d[2];d=d[3];var n=d*f+m*l-r*k,p=d*k+r*f-b*l,w=d*l+b*k-m*f;f=-b*f-m*k-r*l;return a[0]=n*d+f*-b+p*-r-w*-m,a[1]=p*d+f*-m+w*-b-n*-r,a[2]=w*d+f*-r+n*-m-p*-b,a};h.forEach=function(){var a=h.create();return function(b,d,f,k,l,m){var r;d||(d=4);f||(f=0);for(k?r=Math.min(k*d+f,b.length):r=b.length;f<r;f+=d)a[0]=b[f],a[1]=b[f+1],a[2]=b[f+2],a[3]=b[f+3],l(a,a,m),b[f]=a[0],b[f+1]=a[1],b[f+2]=a[2],
b[f+3]=a[3];return b}}();h.str=function(a){return"vec4("+a[0]+", "+a[1]+", "+a[2]+", "+a[3]+")"};"undefined"!=typeof q&&(q.vec4=h);V={create:function(){var a=new P(4);return a[0]=1,a[1]=0,a[2]=0,a[3]=1,a},clone:function(a){var b=new P(4);return b[0]=a[0],b[1]=a[1],b[2]=a[2],b[3]=a[3],b},copy:function(a,b){return a[0]=b[0],a[1]=b[1],a[2]=b[2],a[3]=b[3],a},identity:function(a){return a[0]=1,a[1]=0,a[2]=0,a[3]=1,a},transpose:function(a,b){if(a===b){var d=b[1];a[1]=b[2];a[2]=d}else a[0]=b[0],a[1]=b[2],
a[2]=b[1],a[3]=b[3];return a},invert:function(a,b){var d=b[0],f=b[1],k=b[2];b=b[3];var l=d*b-k*f;return l?(l=1/l,a[0]=b*l,a[1]=-f*l,a[2]=-k*l,a[3]=d*l,a):null},adjoint:function(a,b){var d=b[0];return a[0]=b[3],a[1]=-b[1],a[2]=-b[2],a[3]=d,a},determinant:function(a){return a[0]*a[3]-a[2]*a[1]},multiply:function(a,b,d){var f=b[0],k=b[1],l=b[2];b=b[3];var m=d[0],r=d[1],n=d[2];d=d[3];return a[0]=f*m+l*r,a[1]=k*m+b*r,a[2]=f*n+l*d,a[3]=k*n+b*d,a}};V.mul=V.multiply;V.rotate=function(a,b,d){var f=b[0],k=
b[1],l=b[2];b=b[3];var m=Math.sin(d);d=Math.cos(d);return a[0]=f*d+l*m,a[1]=k*d+b*m,a[2]=f*-m+l*d,a[3]=k*-m+b*d,a};V.scale=function(a,b,d){var f=b[1],k=b[2],l=b[3],m=d[0];d=d[1];return a[0]=b[0]*m,a[1]=f*m,a[2]=k*d,a[3]=l*d,a};V.str=function(a){return"mat2("+a[0]+", "+a[1]+", "+a[2]+", "+a[3]+")"};V.frob=function(a){return Math.sqrt(Math.pow(a[0],2)+Math.pow(a[1],2)+Math.pow(a[2],2)+Math.pow(a[3],2))};V.LDU=function(a,b,d,f){return a[2]=f[2]/f[0],d[0]=f[0],d[1]=f[1],d[3]=f[3]-a[2]*d[1],[a,b,d]};"undefined"!=
typeof q&&(q.mat2=V);V={create:function(){var a=new P(6);return a[0]=1,a[1]=0,a[2]=0,a[3]=1,a[4]=0,a[5]=0,a},clone:function(a){var b=new P(6);return b[0]=a[0],b[1]=a[1],b[2]=a[2],b[3]=a[3],b[4]=a[4],b[5]=a[5],b},copy:function(a,b){return a[0]=b[0],a[1]=b[1],a[2]=b[2],a[3]=b[3],a[4]=b[4],a[5]=b[5],a},identity:function(a){return a[0]=1,a[1]=0,a[2]=0,a[3]=1,a[4]=0,a[5]=0,a},invert:function(a,b){var d=b[0],f=b[1],k=b[2],l=b[3],m=b[4];b=b[5];var r=d*l-f*k;return r?(r=1/r,a[0]=l*r,a[1]=-f*r,a[2]=-k*r,a[3]=
d*r,a[4]=(k*b-l*m)*r,a[5]=(f*m-d*b)*r,a):null},determinant:function(a){return a[0]*a[3]-a[1]*a[2]},multiply:function(a,b,d){var f=b[0],k=b[1],l=b[2],m=b[3],r=b[4];b=b[5];var n=d[0],p=d[1],w=d[2],v=d[3],t=d[4];d=d[5];return a[0]=f*n+l*p,a[1]=k*n+m*p,a[2]=f*w+l*v,a[3]=k*w+m*v,a[4]=f*t+l*d+r,a[5]=k*t+m*d+b,a}};V.mul=V.multiply;V.rotate=function(a,b,d){var f=b[0],k=b[1],l=b[2],m=b[3],r=b[4];b=b[5];var n=Math.sin(d);d=Math.cos(d);return a[0]=f*d+l*n,a[1]=k*d+m*n,a[2]=f*-n+l*d,a[3]=k*-n+m*d,a[4]=r,a[5]=
b,a};V.scale=function(a,b,d){var f=b[1],k=b[2],l=b[3],m=b[4],r=b[5],n=d[0];d=d[1];return a[0]=b[0]*n,a[1]=f*n,a[2]=k*d,a[3]=l*d,a[4]=m,a[5]=r,a};V.translate=function(a,b,d){var f=b[0],k=b[1],l=b[2],m=b[3],r=b[4];b=b[5];var n=d[0];d=d[1];return a[0]=f,a[1]=k,a[2]=l,a[3]=m,a[4]=f*n+l*d+r,a[5]=k*n+m*d+b,a};V.str=function(a){return"mat2d("+a[0]+", "+a[1]+", "+a[2]+", "+a[3]+", "+a[4]+", "+a[5]+")"};V.frob=function(a){return Math.sqrt(Math.pow(a[0],2)+Math.pow(a[1],2)+Math.pow(a[2],2)+Math.pow(a[3],2)+
Math.pow(a[4],2)+Math.pow(a[5],2)+1)};"undefined"!=typeof q&&(q.mat2d=V);var g={create:function(){var a=new P(9);return a[0]=1,a[1]=0,a[2]=0,a[3]=0,a[4]=1,a[5]=0,a[6]=0,a[7]=0,a[8]=1,a},fromMat4:function(a,b){return a[0]=b[0],a[1]=b[1],a[2]=b[2],a[3]=b[4],a[4]=b[5],a[5]=b[6],a[6]=b[8],a[7]=b[9],a[8]=b[10],a},clone:function(a){var b=new P(9);return b[0]=a[0],b[1]=a[1],b[2]=a[2],b[3]=a[3],b[4]=a[4],b[5]=a[5],b[6]=a[6],b[7]=a[7],b[8]=a[8],b},copy:function(a,b){return a[0]=b[0],a[1]=b[1],a[2]=b[2],a[3]=
b[3],a[4]=b[4],a[5]=b[5],a[6]=b[6],a[7]=b[7],a[8]=b[8],a},identity:function(a){return a[0]=1,a[1]=0,a[2]=0,a[3]=0,a[4]=1,a[5]=0,a[6]=0,a[7]=0,a[8]=1,a},transpose:function(a,b){if(a===b){var d=b[1],f=b[2],k=b[5];a[1]=b[3];a[2]=b[6];a[3]=d;a[5]=b[7];a[6]=f;a[7]=k}else a[0]=b[0],a[1]=b[3],a[2]=b[6],a[3]=b[1],a[4]=b[4],a[5]=b[7],a[6]=b[2],a[7]=b[5],a[8]=b[8];return a},invert:function(a,b){var d=b[0],f=b[1],k=b[2],l=b[3],m=b[4],r=b[5],n=b[6],p=b[7];b=b[8];var w=b*m-r*p,v=-b*l+r*n,t=p*l-m*n,u=d*w+f*v+k*
t;return u?(u=1/u,a[0]=w*u,a[1]=(-b*f+k*p)*u,a[2]=(r*f-k*m)*u,a[3]=v*u,a[4]=(b*d-k*n)*u,a[5]=(-r*d+k*l)*u,a[6]=t*u,a[7]=(-p*d+f*n)*u,a[8]=(m*d-f*l)*u,a):null},adjoint:function(a,b){var d=b[0],f=b[1],k=b[2],l=b[3],m=b[4],r=b[5],n=b[6],p=b[7];b=b[8];return a[0]=m*b-r*p,a[1]=k*p-f*b,a[2]=f*r-k*m,a[3]=r*n-l*b,a[4]=d*b-k*n,a[5]=k*l-d*r,a[6]=l*p-m*n,a[7]=f*n-d*p,a[8]=d*m-f*l,a},determinant:function(a){var b=a[3],d=a[4],f=a[5],k=a[6],l=a[7],m=a[8];return a[0]*(m*d-f*l)+a[1]*(-m*b+f*k)+a[2]*(l*b-d*k)},multiply:function(a,
b,d){var f=b[0],k=b[1],l=b[2],m=b[3],r=b[4],n=b[5],p=b[6],w=b[7];b=b[8];var v=d[0],t=d[1],u=d[2],x=d[3],y=d[4],B=d[5],J=d[6],I=d[7];d=d[8];return a[0]=v*f+t*m+u*p,a[1]=v*k+t*r+u*w,a[2]=v*l+t*n+u*b,a[3]=x*f+y*m+B*p,a[4]=x*k+y*r+B*w,a[5]=x*l+y*n+B*b,a[6]=J*f+I*m+d*p,a[7]=J*k+I*r+d*w,a[8]=J*l+I*n+d*b,a}};g.mul=g.multiply;g.translate=function(a,b,d){var f=b[0],k=b[1],l=b[2],m=b[3],r=b[4],n=b[5],p=b[6],w=b[7];b=b[8];var v=d[0];d=d[1];return a[0]=f,a[1]=k,a[2]=l,a[3]=m,a[4]=r,a[5]=n,a[6]=v*f+d*m+p,a[7]=
v*k+d*r+w,a[8]=v*l+d*n+b,a};g.rotate=function(a,b,d){var f=b[0],k=b[1],l=b[2],m=b[3],r=b[4],n=b[5],p=b[6],w=b[7];b=b[8];var v=Math.sin(d);d=Math.cos(d);return a[0]=d*f+v*m,a[1]=d*k+v*r,a[2]=d*l+v*n,a[3]=d*m-v*f,a[4]=d*r-v*k,a[5]=d*n-v*l,a[6]=p,a[7]=w,a[8]=b,a};g.scale=function(a,b,d){var f=d[0];d=d[1];return a[0]=f*b[0],a[1]=f*b[1],a[2]=f*b[2],a[3]=d*b[3],a[4]=d*b[4],a[5]=d*b[5],a[6]=b[6],a[7]=b[7],a[8]=b[8],a};g.fromMat2d=function(a,b){return a[0]=b[0],a[1]=b[1],a[2]=0,a[3]=b[2],a[4]=b[3],a[5]=0,
a[6]=b[4],a[7]=b[5],a[8]=1,a};g.fromQuat=function(a,b){var d=b[0],f=b[1],k=b[2];b=b[3];var l=d+d,m=f+f,r=k+k;d*=l;var n=f*l;f*=m;var p=k*l,w=k*m;k*=r;l*=b;m*=b;b*=r;return a[0]=1-f-k,a[3]=n-b,a[6]=p+m,a[1]=n+b,a[4]=1-d-k,a[7]=w-l,a[2]=p-m,a[5]=w+l,a[8]=1-d-f,a};g.normalFromMat4=function(a,b){var d=b[0],f=b[1],k=b[2],l=b[3],m=b[4],r=b[5],n=b[6],p=b[7],w=b[8],v=b[9],t=b[10],u=b[11],x=b[12],y=b[13],B=b[14];b=b[15];var J=d*r-f*m,I=d*n-k*m,A=d*p-l*m,C=f*n-k*r,D=f*p-l*r,E=k*p-l*n,G=w*y-v*x,F=w*B-t*x;w=
w*b-u*x;var O=v*B-t*y;v=v*b-u*y;t=t*b-u*B;return(u=J*t-I*v+A*O+C*w-D*F+E*G)?(u=1/u,a[0]=(r*t-n*v+p*O)*u,a[1]=(n*w-m*t-p*F)*u,a[2]=(m*v-r*w+p*G)*u,a[3]=(k*v-f*t-l*O)*u,a[4]=(d*t-k*w+l*F)*u,a[5]=(f*w-d*v-l*G)*u,a[6]=(y*E-B*D+b*C)*u,a[7]=(B*A-x*E-b*I)*u,a[8]=(x*D-y*A+b*J)*u,a):null};g.str=function(a){return"mat3("+a[0]+", "+a[1]+", "+a[2]+", "+a[3]+", "+a[4]+", "+a[5]+", "+a[6]+", "+a[7]+", "+a[8]+")"};g.frob=function(a){return Math.sqrt(Math.pow(a[0],2)+Math.pow(a[1],2)+Math.pow(a[2],2)+Math.pow(a[3],
2)+Math.pow(a[4],2)+Math.pow(a[5],2)+Math.pow(a[6],2)+Math.pow(a[7],2)+Math.pow(a[8],2))};"undefined"!=typeof q&&(q.mat3=g);var c={create:function(){var a=new P(16);return a[0]=1,a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[5]=1,a[6]=0,a[7]=0,a[8]=0,a[9]=0,a[10]=1,a[11]=0,a[12]=0,a[13]=0,a[14]=0,a[15]=1,a},clone:function(a){var b=new P(16);return b[0]=a[0],b[1]=a[1],b[2]=a[2],b[3]=a[3],b[4]=a[4],b[5]=a[5],b[6]=a[6],b[7]=a[7],b[8]=a[8],b[9]=a[9],b[10]=a[10],b[11]=a[11],b[12]=a[12],b[13]=a[13],b[14]=a[14],b[15]=a[15],
b},copy:function(a,b){return a[0]=b[0],a[1]=b[1],a[2]=b[2],a[3]=b[3],a[4]=b[4],a[5]=b[5],a[6]=b[6],a[7]=b[7],a[8]=b[8],a[9]=b[9],a[10]=b[10],a[11]=b[11],a[12]=b[12],a[13]=b[13],a[14]=b[14],a[15]=b[15],a},identity:function(a){return a[0]=1,a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[5]=1,a[6]=0,a[7]=0,a[8]=0,a[9]=0,a[10]=1,a[11]=0,a[12]=0,a[13]=0,a[14]=0,a[15]=1,a},transpose:function(a,b){if(a===b){var d=b[1],f=b[2],k=b[3],l=b[6],m=b[7],r=b[11];a[1]=b[4];a[2]=b[8];a[3]=b[12];a[4]=d;a[6]=b[9];a[7]=b[13];a[8]=f;a[9]=
l;a[11]=b[14];a[12]=k;a[13]=m;a[14]=r}else a[0]=b[0],a[1]=b[4],a[2]=b[8],a[3]=b[12],a[4]=b[1],a[5]=b[5],a[6]=b[9],a[7]=b[13],a[8]=b[2],a[9]=b[6],a[10]=b[10],a[11]=b[14],a[12]=b[3],a[13]=b[7],a[14]=b[11],a[15]=b[15];return a},invert:function(a,b){var d=b[0],f=b[1],k=b[2],l=b[3],m=b[4],r=b[5],n=b[6],p=b[7],w=b[8],v=b[9],t=b[10],u=b[11],x=b[12],y=b[13],B=b[14];b=b[15];var J=d*r-f*m,I=d*n-k*m,A=d*p-l*m,C=f*n-k*r,D=f*p-l*r,E=k*p-l*n,G=w*y-v*x,F=w*B-t*x,O=w*b-u*x,Q=v*B-t*y,R=v*b-u*y,T=t*b-u*B,H=J*T-I*R+
A*Q+C*O-D*F+E*G;return H?(H=1/H,a[0]=(r*T-n*R+p*Q)*H,a[1]=(k*R-f*T-l*Q)*H,a[2]=(y*E-B*D+b*C)*H,a[3]=(t*D-v*E-u*C)*H,a[4]=(n*O-m*T-p*F)*H,a[5]=(d*T-k*O+l*F)*H,a[6]=(B*A-x*E-b*I)*H,a[7]=(w*E-t*A+u*I)*H,a[8]=(m*R-r*O+p*G)*H,a[9]=(f*O-d*R-l*G)*H,a[10]=(x*D-y*A+b*J)*H,a[11]=(v*A-w*D-u*J)*H,a[12]=(r*F-m*Q-n*G)*H,a[13]=(d*Q-f*F+k*G)*H,a[14]=(y*I-x*C-B*J)*H,a[15]=(w*C-v*I+t*J)*H,a):null},adjoint:function(a,b){var d=b[0],f=b[1],k=b[2],l=b[3],m=b[4],r=b[5],n=b[6],p=b[7],w=b[8],v=b[9],t=b[10],u=b[11],x=b[12],
y=b[13],B=b[14];b=b[15];return a[0]=r*(t*b-u*B)-v*(n*b-p*B)+y*(n*u-p*t),a[1]=-(f*(t*b-u*B)-v*(k*b-l*B)+y*(k*u-l*t)),a[2]=f*(n*b-p*B)-r*(k*b-l*B)+y*(k*p-l*n),a[3]=-(f*(n*u-p*t)-r*(k*u-l*t)+v*(k*p-l*n)),a[4]=-(m*(t*b-u*B)-w*(n*b-p*B)+x*(n*u-p*t)),a[5]=d*(t*b-u*B)-w*(k*b-l*B)+x*(k*u-l*t),a[6]=-(d*(n*b-p*B)-m*(k*b-l*B)+x*(k*p-l*n)),a[7]=d*(n*u-p*t)-m*(k*u-l*t)+w*(k*p-l*n),a[8]=m*(v*b-u*y)-w*(r*b-p*y)+x*(r*u-p*v),a[9]=-(d*(v*b-u*y)-w*(f*b-l*y)+x*(f*u-l*v)),a[10]=d*(r*b-p*y)-m*(f*b-l*y)+x*(f*p-l*r),a[11]=
-(d*(r*u-p*v)-m*(f*u-l*v)+w*(f*p-l*r)),a[12]=-(m*(v*B-t*y)-w*(r*B-n*y)+x*(r*t-n*v)),a[13]=d*(v*B-t*y)-w*(f*B-k*y)+x*(f*t-k*v),a[14]=-(d*(r*B-n*y)-m*(f*B-k*y)+x*(f*n-k*r)),a[15]=d*(r*t-n*v)-m*(f*t-k*v)+w*(f*n-k*r),a},determinant:function(a){var b=a[0],d=a[1],f=a[2],k=a[3],l=a[4],m=a[5],r=a[6],n=a[7],p=a[8],w=a[9],v=a[10],t=a[11],u=a[12],x=a[13],y=a[14];a=a[15];return(b*m-d*l)*(v*a-t*y)-(b*r-f*l)*(w*a-t*x)+(b*n-k*l)*(w*y-v*x)+(d*r-f*m)*(p*a-t*u)-(d*n-k*m)*(p*y-v*u)+(f*n-k*r)*(p*x-w*u)},multiply:function(a,
b,d){var f=b[0],k=b[1],l=b[2],m=b[3],r=b[4],n=b[5],p=b[6],w=b[7],v=b[8],t=b[9],u=b[10],x=b[11],y=b[12],B=b[13],J=b[14];b=b[15];var I=d[0],A=d[1],C=d[2],D=d[3];return a[0]=I*f+A*r+C*v+D*y,a[1]=I*k+A*n+C*t+D*B,a[2]=I*l+A*p+C*u+D*J,a[3]=I*m+A*w+C*x+D*b,I=d[4],A=d[5],C=d[6],D=d[7],a[4]=I*f+A*r+C*v+D*y,a[5]=I*k+A*n+C*t+D*B,a[6]=I*l+A*p+C*u+D*J,a[7]=I*m+A*w+C*x+D*b,I=d[8],A=d[9],C=d[10],D=d[11],a[8]=I*f+A*r+C*v+D*y,a[9]=I*k+A*n+C*t+D*B,a[10]=I*l+A*p+C*u+D*J,a[11]=I*m+A*w+C*x+D*b,I=d[12],A=d[13],C=d[14],
D=d[15],a[12]=I*f+A*r+C*v+D*y,a[13]=I*k+A*n+C*t+D*B,a[14]=I*l+A*p+C*u+D*J,a[15]=I*m+A*w+C*x+D*b,a}};c.mul=c.multiply;c.translate=function(a,b,d){var f=d[0],k=d[1];d=d[2];var l,m,r,n,p,w,v,t,u,x,y,B;return b===a?(a[12]=b[0]*f+b[4]*k+b[8]*d+b[12],a[13]=b[1]*f+b[5]*k+b[9]*d+b[13],a[14]=b[2]*f+b[6]*k+b[10]*d+b[14],a[15]=b[3]*f+b[7]*k+b[11]*d+b[15]):(l=b[0],m=b[1],r=b[2],n=b[3],p=b[4],w=b[5],v=b[6],t=b[7],u=b[8],x=b[9],y=b[10],B=b[11],a[0]=l,a[1]=m,a[2]=r,a[3]=n,a[4]=p,a[5]=w,a[6]=v,a[7]=t,a[8]=u,a[9]=
x,a[10]=y,a[11]=B,a[12]=l*f+p*k+u*d+b[12],a[13]=m*f+w*k+x*d+b[13],a[14]=r*f+v*k+y*d+b[14],a[15]=n*f+t*k+B*d+b[15]),a};c.scale=function(a,b,d){var f=d[0],k=d[1];d=d[2];return a[0]=b[0]*f,a[1]=b[1]*f,a[2]=b[2]*f,a[3]=b[3]*f,a[4]=b[4]*k,a[5]=b[5]*k,a[6]=b[6]*k,a[7]=b[7]*k,a[8]=b[8]*d,a[9]=b[9]*d,a[10]=b[10]*d,a[11]=b[11]*d,a[12]=b[12],a[13]=b[13],a[14]=b[14],a[15]=b[15],a};c.rotate=function(a,b,d,f){var k=f[0],l=f[1];f=f[2];var m=Math.sqrt(k*k+l*l+f*f),r,n,p,w,v,t,u,x,y,B,J,I,A,C,D,E,G,F,O,Q,R,T,H,K;
return Math.abs(m)<S?null:(m=1/m,k*=m,l*=m,f*=m,r=Math.sin(d),n=Math.cos(d),p=1-n,w=b[0],v=b[1],t=b[2],u=b[3],x=b[4],y=b[5],B=b[6],J=b[7],I=b[8],A=b[9],C=b[10],D=b[11],E=k*k*p+n,G=l*k*p+f*r,F=f*k*p-l*r,O=k*l*p-f*r,Q=l*l*p+n,R=f*l*p+k*r,T=k*f*p+l*r,H=l*f*p-k*r,K=f*f*p+n,a[0]=w*E+x*G+I*F,a[1]=v*E+y*G+A*F,a[2]=t*E+B*G+C*F,a[3]=u*E+J*G+D*F,a[4]=w*O+x*Q+I*R,a[5]=v*O+y*Q+A*R,a[6]=t*O+B*Q+C*R,a[7]=u*O+J*Q+D*R,a[8]=w*T+x*H+I*K,a[9]=v*T+y*H+A*K,a[10]=t*T+B*H+C*K,a[11]=u*T+J*H+D*K,b!==a&&(a[12]=b[12],a[13]=
b[13],a[14]=b[14],a[15]=b[15]),a)};c.rotateX=function(a,b,d){var f=Math.sin(d);d=Math.cos(d);var k=b[4],l=b[5],m=b[6],r=b[7],n=b[8],p=b[9],w=b[10],v=b[11];return b!==a&&(a[0]=b[0],a[1]=b[1],a[2]=b[2],a[3]=b[3],a[12]=b[12],a[13]=b[13],a[14]=b[14],a[15]=b[15]),a[4]=k*d+n*f,a[5]=l*d+p*f,a[6]=m*d+w*f,a[7]=r*d+v*f,a[8]=n*d-k*f,a[9]=p*d-l*f,a[10]=w*d-m*f,a[11]=v*d-r*f,a};c.rotateY=function(a,b,d){var f=Math.sin(d);d=Math.cos(d);var k=b[0],l=b[1],m=b[2],r=b[3],n=b[8],p=b[9],w=b[10],v=b[11];return b!==a&&
(a[4]=b[4],a[5]=b[5],a[6]=b[6],a[7]=b[7],a[12]=b[12],a[13]=b[13],a[14]=b[14],a[15]=b[15]),a[0]=k*d-n*f,a[1]=l*d-p*f,a[2]=m*d-w*f,a[3]=r*d-v*f,a[8]=k*f+n*d,a[9]=l*f+p*d,a[10]=m*f+w*d,a[11]=r*f+v*d,a};c.rotateZ=function(a,b,d){var f=Math.sin(d);d=Math.cos(d);var k=b[0],l=b[1],m=b[2],r=b[3],n=b[4],p=b[5],w=b[6],v=b[7];return b!==a&&(a[8]=b[8],a[9]=b[9],a[10]=b[10],a[11]=b[11],a[12]=b[12],a[13]=b[13],a[14]=b[14],a[15]=b[15]),a[0]=k*d+n*f,a[1]=l*d+p*f,a[2]=m*d+w*f,a[3]=r*d+v*f,a[4]=n*d-k*f,a[5]=p*d-l*
f,a[6]=w*d-m*f,a[7]=v*d-r*f,a};c.fromRotationTranslation=function(a,b,d){var f=b[0],k=b[1],l=b[2],m=b[3],r=f+f,n=k+k,p=l+l;b=f*r;var w=f*n;f*=p;var v=k*n;k*=p;l*=p;r*=m;n*=m;m*=p;return a[0]=1-(v+l),a[1]=w+m,a[2]=f-n,a[3]=0,a[4]=w-m,a[5]=1-(b+l),a[6]=k+r,a[7]=0,a[8]=f+n,a[9]=k-r,a[10]=1-(b+v),a[11]=0,a[12]=d[0],a[13]=d[1],a[14]=d[2],a[15]=1,a};c.fromQuat=function(a,b){var d=b[0],f=b[1],k=b[2];b=b[3];var l=d+d,m=f+f,r=k+k;d*=l;var n=f*l;f*=m;var p=k*l,w=k*m;k*=r;l*=b;m*=b;b*=r;return a[0]=1-f-k,a[1]=
n+b,a[2]=p-m,a[3]=0,a[4]=n-b,a[5]=1-d-k,a[6]=w+l,a[7]=0,a[8]=p+m,a[9]=w-l,a[10]=1-d-f,a[11]=0,a[12]=0,a[13]=0,a[14]=0,a[15]=1,a};c.frustum=function(a,b,d,f,k,l,m){var r=1/(d-b),n=1/(k-f),p=1/(l-m);return a[0]=2*l*r,a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[5]=2*l*n,a[6]=0,a[7]=0,a[8]=(d+b)*r,a[9]=(k+f)*n,a[10]=(m+l)*p,a[11]=-1,a[12]=0,a[13]=0,a[14]=m*l*2*p,a[15]=0,a};c.perspective=function(a,b,d,f,k){b=1/Math.tan(b/2);var l=1/(f-k);return a[0]=b/d,a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[5]=b,a[6]=0,a[7]=0,a[8]=0,a[9]=
0,a[10]=(k+f)*l,a[11]=-1,a[12]=0,a[13]=0,a[14]=2*k*f*l,a[15]=0,a};c.ortho=function(a,b,d,f,k,l,m){var r=1/(b-d),n=1/(f-k),p=1/(l-m);return a[0]=-2*r,a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[5]=-2*n,a[6]=0,a[7]=0,a[8]=0,a[9]=0,a[10]=2*p,a[11]=0,a[12]=(b+d)*r,a[13]=(k+f)*n,a[14]=(m+l)*p,a[15]=1,a};c.lookAt=function(a,b,d,f){var k,l,m,r,n,p,w,v,t,u,x=b[0],y=b[1];b=b[2];var B=f[0],J=f[1];f=f[2];var I=d[0],A=d[1];d=d[2];return Math.abs(x-I)<S&&Math.abs(y-A)<S&&Math.abs(b-d)<S?c.identity(a):(w=x-I,v=y-A,t=b-d,u=1/
Math.sqrt(w*w+v*v+t*t),w*=u,v*=u,t*=u,k=J*t-f*v,l=f*w-B*t,m=B*v-J*w,u=Math.sqrt(k*k+l*l+m*m),u?(u=1/u,k*=u,l*=u,m*=u):(k=0,l=0,m=0),r=v*m-t*l,n=t*k-w*m,p=w*l-v*k,u=Math.sqrt(r*r+n*n+p*p),u?(u=1/u,r*=u,n*=u,p*=u):(r=0,n=0,p=0),a[0]=k,a[1]=r,a[2]=w,a[3]=0,a[4]=l,a[5]=n,a[6]=v,a[7]=0,a[8]=m,a[9]=p,a[10]=t,a[11]=0,a[12]=-(k*x+l*y+m*b),a[13]=-(r*x+n*y+p*b),a[14]=-(w*x+v*y+t*b),a[15]=1,a)};c.str=function(a){return"mat4("+a[0]+", "+a[1]+", "+a[2]+", "+a[3]+", "+a[4]+", "+a[5]+", "+a[6]+", "+a[7]+", "+a[8]+
", "+a[9]+", "+a[10]+", "+a[11]+", "+a[12]+", "+a[13]+", "+a[14]+", "+a[15]+")"};c.frob=function(a){return Math.sqrt(Math.pow(a[0],2)+Math.pow(a[1],2)+Math.pow(a[2],2)+Math.pow(a[3],2)+Math.pow(a[4],2)+Math.pow(a[5],2)+Math.pow(a[6],2)+Math.pow(a[6],2)+Math.pow(a[7],2)+Math.pow(a[8],2)+Math.pow(a[9],2)+Math.pow(a[10],2)+Math.pow(a[11],2)+Math.pow(a[12],2)+Math.pow(a[13],2)+Math.pow(a[14],2)+Math.pow(a[15],2))};"undefined"!=typeof q&&(q.mat4=c);var e={create:function(){var a=new P(4);return a[0]=0,
a[1]=0,a[2]=0,a[3]=1,a}};e.rotationTo=function(){var a=N.create(),b=N.fromValues(1,0,0),d=N.fromValues(0,1,0);return function(f,k,l){var m=N.dot(k,l);return-.999999>m?(N.cross(a,b,k),1E-6>N.length(a)&&N.cross(a,d,k),N.normalize(a,a),e.setAxisAngle(f,a,Math.PI),f):.999999<m?(f[0]=0,f[1]=0,f[2]=0,f[3]=1,f):(N.cross(a,k,l),f[0]=a[0],f[1]=a[1],f[2]=a[2],f[3]=1+m,e.normalize(f,f))}}();e.setAxes=function(){var a=g.create();return function(b,d,f,k){return a[0]=f[0],a[3]=f[1],a[6]=f[2],a[1]=k[0],a[4]=k[1],
a[7]=k[2],a[2]=-d[0],a[5]=-d[1],a[8]=-d[2],e.normalize(b,e.fromMat3(b,a))}}();e.clone=h.clone;e.fromValues=h.fromValues;e.copy=h.copy;e.set=h.set;e.identity=function(a){return a[0]=0,a[1]=0,a[2]=0,a[3]=1,a};e.setAxisAngle=function(a,b,d){d*=.5;var f=Math.sin(d);return a[0]=f*b[0],a[1]=f*b[1],a[2]=f*b[2],a[3]=Math.cos(d),a};e.add=h.add;e.multiply=function(a,b,d){var f=b[0],k=b[1],l=b[2];b=b[3];var m=d[0],r=d[1],n=d[2];d=d[3];return a[0]=f*d+b*m+k*n-l*r,a[1]=k*d+b*r+l*m-f*n,a[2]=l*d+b*n+f*r-k*m,a[3]=
b*d-f*m-k*r-l*n,a};e.mul=e.multiply;e.scale=h.scale;e.rotateX=function(a,b,d){d*=.5;var f=b[0],k=b[1],l=b[2];b=b[3];var m=Math.sin(d);d=Math.cos(d);return a[0]=f*d+b*m,a[1]=k*d+l*m,a[2]=l*d-k*m,a[3]=b*d-f*m,a};e.rotateY=function(a,b,d){d*=.5;var f=b[0],k=b[1],l=b[2];b=b[3];var m=Math.sin(d);d=Math.cos(d);return a[0]=f*d-l*m,a[1]=k*d+b*m,a[2]=l*d+f*m,a[3]=b*d-k*m,a};e.rotateZ=function(a,b,d){d*=.5;var f=b[0],k=b[1],l=b[2];b=b[3];var m=Math.sin(d);d=Math.cos(d);return a[0]=f*d+k*m,a[1]=k*d-f*m,a[2]=
l*d+b*m,a[3]=b*d-l*m,a};e.calculateW=function(a,b){var d=b[0],f=b[1];b=b[2];return a[0]=d,a[1]=f,a[2]=b,a[3]=-Math.sqrt(Math.abs(1-d*d-f*f-b*b)),a};e.dot=h.dot;e._lerp=h._lerp;e.s_lerp=function(a,b,d,f){var k=b[0],l=b[1],m=b[2];b=b[3];var r=d[0],n=d[1],p=d[2];d=d[3];var w,v,t,u,x;return v=k*r+l*n+m*p+b*d,0>v&&(v=-v,r=-r,n=-n,p=-p,d=-d),1E-6<1-v?(w=Math.acos(v),t=Math.sin(w),u=Math.sin((1-f)*w)/t,x=Math.sin(f*w)/t):(u=1-f,x=f),a[0]=u*k+x*r,a[1]=u*l+x*n,a[2]=u*m+x*p,a[3]=u*b+x*d,a};e.invert=function(a,
b){var d=b[0],f=b[1],k=b[2];b=b[3];var l=d*d+f*f+k*k+b*b;l=l?1/l:0;return a[0]=-d*l,a[1]=-f*l,a[2]=-k*l,a[3]=b*l,a};e.conjugate=function(a,b){return a[0]=-b[0],a[1]=-b[1],a[2]=-b[2],a[3]=b[3],a};e.length=h.length;e.len=e.length;e.squaredLength=h.squaredLength;e.sqrLen=e.squaredLength;e.normalize=h.normalize;e.fromMat3=function(a,b){var d=b[0]+b[4]+b[8];if(0<d)d=Math.sqrt(d+1),a[3]=.5*d,d=.5/d,a[0]=(b[7]-b[5])*d,a[1]=(b[2]-b[6])*d,a[2]=(b[3]-b[1])*d;else{var f=0;b[4]>b[0]&&(f=1);b[8]>b[3*f+f]&&(f=
2);var k=(f+1)%3,l=(f+2)%3;d=Math.sqrt(b[3*f+f]-b[3*k+k]-b[3*l+l]+1);a[f]=.5*d;d=.5/d;a[3]=(b[3*l+k]-b[3*k+l])*d;a[k]=(b[3*k+f]+b[3*f+k])*d;a[l]=(b[3*l+f]+b[3*f+l])*d}return a};e.str=function(a){return"quat("+a[0]+", "+a[1]+", "+a[2]+", "+a[3]+")"};"undefined"!=typeof q&&(q.quat=e)})(M)})(this);"use strict";
(function(z){function M(h,g,c,e){this.gl=e=e||z.gl;this._context_id=e.context_id;if(h&&h.constructor!==Array)throw"FBO textures must be an Array";this.handler=null;this.height=this.width=-1;this.color_textures=[];this.depth_texture=null;this.stencil=!!c;this._stencil_enabled=!1;this._num_binded_textures=0;(h&&h.length||g)&&this.setTextures(h,g);this._old_fbo=null;this._old_viewport=new Float32Array(4)}var q=z.GL={};z.requestAnimationFrame=z.requestAnimationFrame||z.mozRequestAnimationFrame||z.webkitRequestAnimationFrame||
function(h){setTimeout(h,1E3/60)};q.blockable_keys={Up:!0,Down:!0,Left:!0,Right:!0};q.LEFT_MOUSE_BUTTON=1;q.MIDDLE_MOUSE_BUTTON=2;q.RIGHT_MOUSE_BUTTON=3;q.last_context_id=0;q.TEXTURE_2D=3553;q.TEXTURE_CUBE_MAP=34067;q.BYTE=5120;q.UNSIGNED_BYTE=5121;q.SHORT=5122;q.UNSIGNED_SHORT=5123;q.INT=5124;q.UNSIGNED_INT=5125;q.FLOAT=5126;q.HALF_FLOAT_OES=36193;q.DEPTH_COMPONENT16=33189;q.FLOAT_VEC2=35664;q.FLOAT_VEC3=35665;q.FLOAT_VEC4=35666;q.INT_VEC2=35667;q.INT_VEC3=35668;q.INT_VEC4=35669;q.BOOL=35670;q.BOOL_VEC2=
35671;q.BOOL_VEC3=35672;q.BOOL_VEC4=35673;q.FLOAT_MAT2=35674;q.FLOAT_MAT3=35675;q.FLOAT_MAT4=35676;q.DEPTH_COMPONENT=6402;q.ALPHA=6406;q.RGB=6407;q.RGBA=6408;q.LUMINANCE=6409;q.LUMINANCE_ALPHA=6410;q.NEAREST=9728;q.LINEAR=9729;q.NEAREST_MIPMAP_NEAREST=9984;q.LINEAR_MIPMAP_NEAREST=9985;q.NEAREST_MIPMAP_LINEAR=9986;q.LINEAR_MIPMAP_LINEAR=9987;q.REPEAT=10497;q.CLAMP_TO_EDGE=33071;q.MIRRORED_REPEAT=33648;q.ZERO=0;q.ONE=1;q.SRC_COLOR=768;q.ONE_MINUS_SRC_COLOR=769;q.SRC_ALPHA=770;q.ONE_MINUS_SRC_ALPHA=
771;q.DST_ALPHA=772;q.ONE_MINUS_DST_ALPHA=773;q.DST_COLOR=774;q.ONE_MINUS_DST_COLOR=775;q.SRC_ALPHA_SATURATE=776;q.CONSTANT_COLOR=32769;q.ONE_MINUS_CONSTANT_COLOR=32770;q.CONSTANT_ALPHA=32771;q.ONE_MINUS_CONSTANT_ALPHA=32772;q.VERTEX_SHADER=35633;q.FRAGMENT_SHADER=35632;q.CW=2304;q.CCW=2305;q.FRONT=1028;q.BACK=1029;q.FRONT_AND_BACK=1032;q.NEVER=512;q.LESS=513;q.EQUAL=514;q.LEQUAL=515;q.GREATER=516;q.NOTEQUAL=517;q.GEQUAL=518;q.ALWAYS=519;q.temp_vec3=vec3.create();q.temp2_vec3=vec3.create();q.temp_vec4=
vec4.create();q.temp_quat=quat.create();q.temp_mat3=mat3.create();q.temp_mat4=mat4.create();z.DEG2RAD=.0174532925;z.RAD2DEG=57.295779578552306;z.EPSILON=1E-6;z.isPowerOfTwo=q.isPowerOfTwo=function(h){return 0==Math.log(h)/Math.log(2)%1};z.getTime="undefined"!=typeof performance?performance.now.bind(performance):Date.now.bind(Date);q.getTime=z.getTime;z.isFunction=function(h){return!!(h&&h.constructor&&h.call&&h.apply)};z.isArray=function(h){return h&&h.constructor===Array};z.isNumber=function(h){return null!=
h&&h.constructor===Number};z.cloneObject=q.cloneObject=function(h,g){if(h.constructor!==Object)throw"cloneObject only can clone pure javascript objects, not classes";g=g||{};for(var c in h){var e=h[c];if(null===e)g[c]=null;else switch(e.constructor){case Int8Array:case Uint8Array:case Int16Array:case Uint16Array:case Int32Array:case Uint32Array:case Float32Array:case Float64Array:g[c]=new e.constructor(e);break;case Boolean:case Number:case String:g[c]=e;break;case Array:g[c]=e.concat();break;case Object:g[c]=
q.cloneObject(e)}}return g};z.regexMap=function(h,g,c){for(var e;null!=(e=h.exec(g));)c(e)};z.createCanvas=q.createCanvas=function(h,g){var c=document.createElement("canvas");c.width=h;c.height=g;return c};z.cloneCanvas=q.cloneCanvas=function(h){var g=document.createElement("canvas");g.width=h.width;g.height=h.height;g.getContext("2d").drawImage(h,0,0);return g};"undefined"!=typeof Image&&(Image.prototype.getPixels=function(){var h=document.createElement("canvas");h.width=this.width;h.height=this.height;
h=h.getContext("2d");h.drawImage(this,0,0);return h.getImageData(0,0,this.width,this.height).data});String.prototype.hasOwnProperty("replaceAll")||Object.defineProperty(String.prototype,"replaceAll",{value:function(h){var g=this,c;for(c in h)g=g.split(c).join(h[c]);return g},enumerable:!1});String.prototype.hasOwnProperty("hashCode")||Object.defineProperty(String.prototype,"hashCode",{value:function(){var h=0,g;if(0==this.length)return h;var c=0;for(g=this.length;c<g;++c){var e=this.charCodeAt(c);
h=(h<<5)-h+e;h|=0}return h},enumerable:!1});Array.prototype.hasOwnProperty("subarray")||Object.defineProperty(Array.prototype,"subarray",{value:Array.prototype.slice,enumerable:!1});z.wipeObject=function(h){for(var g in h)h.hasOwnProperty(g)&&delete h[g]};z.extendClass=q.extendClass=function(h,g){for(var c in g)h.hasOwnProperty(c)||(h[c]=g[c]);if(g.prototype){var e=Object.getOwnPropertyNames(g.prototype);for(c=0;c<e.length;++c){var a=e[c];h.prototype.hasOwnProperty(a)||(g.prototype.__lookupGetter__(a)?
h.prototype.__defineGetter__(a,g.prototype.__lookupGetter__(a)):h.prototype[a]=g.prototype[a],g.prototype.__lookupSetter__(a)&&h.prototype.__defineSetter__(a,g.prototype.__lookupSetter__(a)))}}h.hasOwnProperty("superclass")||Object.defineProperty(h,"superclass",{get:function(){return g},enumerable:!1})};z.HttpRequest=q.request=function(h,g,c,e,a){var b=!0;a&&void 0!==a.async&&(b=a.async);if(g){var d=null;d=[];for(var f in g)d.push(f+"="+g[f]);d=d.join("&");h=h+"?"+d}var k=new XMLHttpRequest;k.open("GET",
h,b);k.onload=function(l){this.getResponseHeader("Content-Type");200!=this.status?(L.trigger(k,"fail",this.status),e&&e(this.status)):(L.trigger(k,"done",this.response),c&&c(this.response))};k.onerror=function(l){L.trigger(k,"fail",l)};if(a){for(f in a)k[f]=a[f];a.binary&&(k.responseType="arraybuffer")}k.send();return k};XMLHttpRequest.prototype.hasOwnProperty("done")||Object.defineProperty(XMLHttpRequest.prototype,"done",{enumerable:!1,value:function(h){L.bind(this,"done",function(g,c){h(c)});return this}});
XMLHttpRequest.prototype.hasOwnProperty("fail")||Object.defineProperty(XMLHttpRequest.prototype,"fail",{enumerable:!1,value:function(h){L.bind(this,"fail",function(g,c){h(c)});return this}});z.getFileExtension=function(h){var g=h.indexOf("?");-1!=g&&(h=h.substr(0,g));g=h.lastIndexOf(".");return-1==g?"":h.substr(g+1).toLowerCase()};z.loadFileAtlas=q.loadFileAtlas=function(h,g,c){var e=null;HttpRequest(h,null,function(a){a=q.processFileAtlas(a);g&&g(a);e&&e(a)},alert,c);return{done:function(a){e=a}}};
z.processFileAtlas=q.processFileAtlas=function(h,g){h=h.split("\n");for(var c={},e=[],a="",b=0,d=h.length;b<d;b++){var f=g?h[b]:h[b].trim();f.length&&("\\"!=f[0]?e.push(f):(e.length&&(c[a]=e.join("\n")),e.length=0,a=f.substr(1)))}e.length&&(c[a]=e.join("\n"));return c};z.hexColorToRGBA=function(){function h(e,a,b){0>b&&(b+=1);1<b&&--b;return b<1/6?e+6*(a-e)*b:.5>b?a:b<2/3?e+(a-e)*(2/3-b)*6:e}function g(e,a,b,d){d=d||vec3.create();if(0==a)b=a=e=b;else{var f=.5>b?b*(1+a):b+a-b*a,k=2*b-f;b=h(k,f,e+1/
3);a=h(k,f,e);e=h(k,f,e-1/3)}d[0]=b;d[1]=a;d[2]=e;return d}var c={white:[1,1,1],black:[0,0,0],gray:[.501960813999176,.501960813999176,.501960813999176],red:[1,0,0],orange:[1,.6470588445663452,0],pink:[1,.7529411911964417,.7960784435272217],green:[0,.501960813999176,0],lime:[0,1,0],blue:[0,0,1],violet:[.9333333373069763,.5098039507865906,.9333333373069763],magenta:[1,0,1],cyan:[0,1,1],yellow:[1,1,0],brown:[.6470588445663452,.16470588743686676,.16470588743686676],silver:[.7529411911964417,.7529411911964417,
.7529411911964417],gold:[1,.843137264251709,0],transparent:[0,0,0,0]};return function(e,a,b){b=void 0===b?1:b;a=a||new Float32Array(4);a[3]=b;if("string"!=typeof e)return a;var d=c[e];if(void 0!==d)return a.set(d),a[3]=3==a.length?b:a[3]*b,a;d=e.indexOf("rgba(");if(-1!=d)return e=e.substr(5),e=e.split(","),a[0]=parseInt(e[0])/255,a[1]=parseInt(e[1])/255,a[2]=parseInt(e[2])/255,a[3]=parseFloat(e[3])*b,a;d=e.indexOf("hsla(");if(-1!=d)return e=e.substr(5),e=e.split(","),g(parseInt(e[0])/360,parseInt(e[1])/
100,parseInt(e[2])/100,a),a[3]=parseFloat(e[3])*b,a;a[3]=b;d=e.indexOf("rgb(");if(-1!=d)return e=e.substr(3),e=e.split(","),a[0]=parseInt(e[0])/255,a[1]=parseInt(e[1])/255,a[2]=parseInt(e[2])/255,a;d=e.indexOf("hsl(");if(-1!=d)return e=e.substr(5),e=e.split(","),g(parseInt(e[0])/360,parseInt(e[1])/100,parseInt(e[2])/100,a),a;e=e.replace(/^#?([a-f\d])([a-f\d])([a-f\d])$/i,function(f,k,l,m){return k+k+l+l+m+m});b=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(e);if(!b)return a;a[0]=parseInt(b[1],
16)/255;a[1]=parseInt(b[2],16)/255;a[2]=parseInt(b[3],16)/255;return a}}();var S=function(){function h(A){return A.charCodeAt(0)+(A.charCodeAt(1)<<8)+(A.charCodeAt(2)<<16)+(A.charCodeAt(3)<<24)}function g(A,C,D,E){var G=new Uint16Array(4),F=new Uint16Array(D*E),O=D/4;E/=4;for(var Q=0;Q<E;Q++)for(var R=0;R<O;R++){var T=C+4*(Q*O+R);G[0]=A[T];G[1]=A[T+1];var H=G[0]&31;var K=G[0]&2016;var W=G[0]&63488;var X=G[1]&31;var Z=G[1]&2016;var aa=G[1]&63488;G[2]=5*H+3*X>>3|5*K+3*Z>>3&2016|5*W+3*aa>>3&63488;G[3]=
5*X+3*H>>3|5*Z+3*K>>3&2016|5*aa+3*W>>3&63488;H=A[T+2];K=4*Q*D+4*R;F[K]=G[H&3];F[K+1]=G[H>>2&3];F[K+2]=G[H>>4&3];F[K+3]=G[H>>6&3];K+=D;F[K]=G[H>>8&3];F[K+1]=G[H>>10&3];F[K+2]=G[H>>12&3];F[K+3]=G[H>>14];H=A[T+3];K+=D;F[K]=G[H&3];F[K+1]=G[H>>2&3];F[K+2]=G[H>>4&3];F[K+3]=G[H>>6&3];K+=D;F[K]=G[H>>8&3];F[K+1]=G[H>>10&3];F[K+2]=G[H>>12&3];F[K+3]=G[H>>14]}return F}function c(A){for(var C=0,D=A.length,E;C<D;C+=4)E=A[C],A[C]=A[C+2],A[C+2]=E}function e(A,C,D,E){var G=new Int32Array(D,0,p),F,O;if(G[w]!=d)return console.error("Invalid magic number in DDS header"),
0;if(!G[B]&l)return console.error("Unsupported format, must contain a FourCC code"),0;var Q=G[J];switch(Q){case m:var R=8;var T=C?C.COMPRESSED_RGB_S3TC_DXT1_EXT:null;break;case r:R=16;T=C?C.COMPRESSED_RGBA_S3TC_DXT3_EXT:null;break;case n:R=16;T=C?C.COMPRESSED_RGBA_S3TC_DXT5_EXT:null;break;default:R=4,Q=null,T=A.RGBA}var H=1;G[t]&f&&!1!==E&&(H=Math.max(1,G[y]));var K=G[x];var W=G[u];var X=G[v]+4;if(G[I+1]&k)for(O=0;6>O;++O)for(K=G[x],W=G[u],F=0;F<H;++F)Q?(E=Math.max(4,K)/4*Math.max(4,W)/4*R,C=new Uint8Array(D,
X,E),A.compressedTexImage2D(A.TEXTURE_CUBE_MAP_POSITIVE_X+O,F,T,K,W,0,C)):(A.pixelStorei(A.UNPACK_FLIP_Y_WEBGL,!1),E=K*W*R,C=new Uint8Array(D,X,E),c(C),A.texImage2D(A.TEXTURE_CUBE_MAP_POSITIVE_X+O,F,T,K,W,0,A.RGBA,A.UNSIGNED_BYTE,C)),X+=E,K*=.5,W*=.5;else if(C)for(A.pixelStorei(A.UNPACK_FLIP_Y_WEBGL,!0),F=0;F<H;++F)Q?(E=Math.max(4,K)/4*Math.max(4,W)/4*R,C=new Uint8Array(D,X,E),A.compressedTexImage2D(A.TEXTURE_2D,F,T,K,W,0,C)):(E=K*W*R,C=new Uint8Array(D,X,E),c(C),A.texImage2D(A.TEXTURE_2D,F,T,K,W,
0,T,A.UNSIGNED_BYTE,C)),X+=E,K*=.5,W*=.5;else if(Q==m)Math.max(4,K),Math.max(4,W),C=new Uint16Array(D),D=g(C,X/2,K,W),A.texImage2D(A.TEXTURE_2D,0,A.RGB,K,W,0,A.RGB,A.UNSIGNED_SHORT_5_6_5,D),E&&A.generateMipmap(A.TEXTURE_2D);else return console.error("No manual decoder for",String.fromCharCode(Q&255,Q>>8&255,Q>>16&255,Q>>24&255),"and no native support"),0;return H}function a(A,C){var D=new Int32Array(A,0,p),E,G,F;if(D[w]!=d)return console.error("Invalid magic number in DDS header"),0;if(!D[B]&l)return console.error("Unsupported format, must contain a FourCC code"),
0;var O=D[J];switch(O){case m:var Q=8;var R="COMPRESSED_RGB_S3TC_DXT1_EXT";break;case r:Q=16;R="COMPRESSED_RGBA_S3TC_DXT3_EXT";break;case n:Q=16;R="COMPRESSED_RGBA_S3TC_DXT5_EXT";break;default:Q=4,R="RGBA"}var T=1;D[t]&f&&!1!==loadMipmaps&&(T=Math.max(1,D[y]));var H=D[x];var K=D[u];var W=D[v]+4;var X=[];if(D[I+1]&k)for(F=0;6>F;++F)for(H=D[x],K=D[u],C=0;C<T;++C)O?(E=Math.max(4,H)/4*Math.max(4,K)/4*Q,new Uint8Array(A,W,E),X.push({tex:"TEXTURE_CUBE_MAP",face:F,mipmap:C,internalFormat:R,width:H,height:K,
offset:0,dataOffset:W,dataLength:E})):(E=H*K*Q,G=new Uint8Array(A,W,E),c(G),X.push({tex:"TEXTURE_CUBE_MAP",face:F,mipmap:C,internalFormat:R,width:H,height:K,offset:0,type:"UNSIGNED_BYTE",dataOffset:W,dataLength:E})),W+=E,H*=.5,K*=.5;else if(C)if(O==m)Math.max(4,H),Math.max(4,K),G=new Uint16Array(A),D=g(G,W/2,H,K),X.push({tex:"TEXTURE_2D",mipmap:0,internalFormat:"RGB",width:H,height:K,offset:0,format:"RGB",type:"UNSIGNED_SHORT_5_6_5",data:D});else return console.error("No manual decoder for",String.fromCharCode(O&
255,O>>8&255,O>>16&255,O>>24&255),"and no native support"),0;else for(C=0;C<T;++C)E=Math.max(4,H)/4*Math.max(4,K)/4*Q,new Uint8Array(A,W,E),X.push({tex:"TEXTURE_2D",mipmap:C,internalFormat:R,width:H,height:K,offset:0,type:"UNSIGNED_BYTE",dataOffset:W,dataLength:E}),W+=E,H*=.5,K*=.5;return X}function b(A,C,D,E,G,F){var O=new XMLHttpRequest;O.open("GET",D,!0);O.responseType="arraybuffer";O.onload=function(){if(200==this.status){var Q=new Int32Array(this.response,0,p),R=Q[I+1]&k?A.TEXTURE_CUBE_MAP:A.TEXTURE_2D;
A.bindTexture(R,E);var T=e(A,C,this.response,G);A.texParameteri(R,A.TEXTURE_MAG_FILTER,A.LINEAR);A.texParameteri(R,A.TEXTURE_MIN_FILTER,1<T?A.LINEAR_MIPMAP_LINEAR:A.LINEAR);A.bindTexture(R,null);E.texture_type=R;E.width=Q[x];E.height=Q[u]}F&&F(E)};O.send(null);return E}var d=542327876,f=131072,k=512,l=4,m=h("DXT1"),r=h("DXT3"),n=h("DXT5"),p=31,w=0,v=1,t=2,u=3,x=4,y=7,B=20,J=21,I=27;return{dxtToRgb565:g,uploadDDSLevels:e,loadDDSTextureEx:b,loadDDSTexture:function(A,C,D,E){var G=A.createTexture();C=
A.getExtension("WEBGL_compressed_texture_s3tc");b(A,C,D,G,!0,E);return G},loadDDSTextureFromMemoryEx:function(A,C,D,E,G){var F=new Int32Array(D,0,p),O=!!(F[I+1]&k),Q=O?A.TEXTURE_CUBE_MAP:A.TEXTURE_2D;A.bindTexture(Q,E.handler);C=e(A,C,D,G);A.texParameteri(Q,A.TEXTURE_MAG_FILTER,A.LINEAR);A.texParameteri(Q,A.TEXTURE_MIN_FILTER,1<C?A.LINEAR_MIPMAP_LINEAR:A.LINEAR);O&&(A.texParameteri(Q,A.TEXTURE_WRAP_S,A.CLAMP_TO_EDGE),A.texParameteri(Q,A.TEXTURE_WRAP_T,A.CLAMP_TO_EDGE));A.bindTexture(Q,null);E.handler&&
(E.texture_type=Q,E.width=F[x],E.height=F[u]);return E},getDDSTextureFromMemoryEx:function(A){var C=new Int32Array(A,0,p),D=C[I+1]&k?"TEXTURE_CUBE_MAP":"TEXTURE_2D",E=a(A);return{type:D,buffers:E,data:A,width:C[x],height:C[u]}}}}();"undefined"!=typeof z&&(z.DDS=S);if("undefined"==typeof glMatrix)throw"You must include glMatrix on your project";Math.clamp=function(h,g,c){return g>h?g:c<h?c:h};vec3.ZERO=vec3.fromValues(0,0,0);vec3.FRONT=vec3.fromValues(0,0,-1);vec3.UP=vec3.fromValues(0,1,0);vec3.RIGHT=
vec3.fromValues(1,0,0);vec2.rotate=function(h,g,c){var e=g[0];g=g[1];var a=Math.cos(c);c=Math.sin(c);h[0]=e*a-g*c;h[1]=e*c+g*a;return h};vec3.zero=function(h){h[0]=h[1]=0;return h};vec2.perpdot=function(h,g){return h[1]*g[0]+-h[0]*g[1]};vec2.computeSignedAngle=function(h,g){return Math.atan2(vec2.perpdot(h,g),vec2.dot(h,g))};vec2.random=function(h){h[0]=Math.random();h[1]=Math.random();return h};vec3.zero=function(h){h[0]=h[1]=h[2]=0;return h};vec3.minValue=function(h){return h[0]<h[1]&&h[0]<h[2]?
h[0]:h[1]<h[2]?h[1]:h[2]};vec3.maxValue=function(h){return h[0]>h[1]&&h[0]>h[2]?h[0]:h[1]>h[2]?h[1]:h[2]};vec3.minValue=function(h){return h[0]<h[1]&&h[0]<h[2]?h[0]:h[1]<h[2]?h[1]:h[2]};vec3.addValue=function(h,g,c){h[0]=g[0]+c;h[1]=g[1]+c;h[2]=g[2]+c};vec3.subValue=function(h,g,c){h[0]=g[0]-c;h[1]=g[1]-c;h[2]=g[2]-c};vec3.toArray=function(h){return[h[0],h[1],h[2]]};vec3.rotateX=function(h,g,c){var e=g[1],a=g[2],b=Math.cos(c);c=Math.sin(c);h[0]=g[0];h[1]=e*b-a*c;h[2]=e*c+a*b;return h};vec3.rotateY=
function(h,g,c){var e=g[0],a=g[2],b=Math.cos(c);c=Math.sin(c);h[0]=e*b-a*c;h[1]=g[1];h[2]=e*c+a*b;return h};vec3.rotateZ=function(h,g,c){var e=g[0],a=g[1],b=Math.cos(c);c=Math.sin(c);h[0]=e*b-a*c;h[1]=e*c+a*b;h[2]=g[2];return h};vec3.angle=function(h,g){return Math.acos(vec3.dot(h,g))};vec3.random=function(h){h[0]=Math.random();h[1]=Math.random();h[2]=Math.random();return h};vec3.polarToCartesian=function(h,g){var c=g[0],e=g[1];g=g[2];h[0]=c*Math.cos(e)*Math.sin(g);h[1]=c*Math.sin(e);h[2]=c*Math.cos(e)*
Math.cos(g);return h};vec4.random=function(h){h[0]=Math.random();h[1]=Math.random();h[2]=Math.random();h[3]=Math.random();return h};vec4.toArray=function(h){return[h[0],h[1],h[2],h[3]]};mat3.IDENTITY=mat3.create();mat4.IDENTITY=mat4.create();mat4.toArray=function(h){return[h[0],h[1],h[2],h[3],h[4],h[5],h[6],h[7],h[8],h[9],h[10],h[11],h[12],h[13],h[14],h[15]]};mat4.setUpAndOrthonormalize=function(h,g,c){g!=h&&mat4.copy(h,g);g=h.subarray(0,3);vec3.normalize(h.subarray(4,7),c);h=h.subarray(8,11);vec3.cross(g,
c,h);vec3.normalize(g,g);vec3.cross(h,g,c);vec3.normalize(h,h)};mat4.multiplyVec3=function(h,g,c){var e=c[0],a=c[1];c=c[2];h[0]=g[0]*e+g[4]*a+g[8]*c+g[12];h[1]=g[1]*e+g[5]*a+g[9]*c+g[13];h[2]=g[2]*e+g[6]*a+g[10]*c+g[14];return h};mat4.projectVec3=function(h,g,c){var e=c[0],a=c[1];c=c[2];var b=g[1]*e+g[5]*a+g[9]*c+g[13],d=g[2]*e+g[6]*a+g[10]*c+g[14],f=g[3]*e+g[7]*a+g[11]*c+g[15];h[0]=((g[0]*e+g[4]*a+g[8]*c+g[12])/f+1)/2;h[1]=(b/f+1)/2;h[2]=(d/f+1)/2;return h};vec3.project=function(h,g,c,e){e=e||gl.viewport_data;
var a=g[0],b=g[1];g=g[2];var d=c[3]*a+c[7]*b+c[11]*g+c[15],f=1-((c[1]*a+c[5]*b+c[9]*g+c[13])/d+1)/2;h[0]=((c[0]*a+c[4]*b+c[8]*g+c[12])/d+1)/2*e[2]+e[0];h[1]=f*e[3]+e[1];h[2]=d;return h};var P=mat4.create(),U=vec4.create();vec3.unproject=function(h,g,c,e){U[0]=2*(g[0]-e[0])/e[2]-1;U[1]=2*(g[1]-e[1])/e[3]-1;U[2]=2*g[2]-1;U[3]=1;if(!mat4.invert(P,c))return null;vec4.transformMat4(U,U,P);if(0===U[3])return null;h[0]=U[0]/U[3];h[1]=U[1]/U[3];h[2]=U[2]/U[3];return h};mat4.rotateVec3=function(h,g,c){var e=
c[0],a=c[1];c=c[2];h[0]=g[0]*e+g[4]*a+g[8]*c;h[1]=g[1]*e+g[5]*a+g[9]*c;h[2]=g[2]*e+g[6]*a+g[10]*c;return h};mat4.fromTranslationFrontTop=function(h,g,c,e){vec3.cross(h.subarray(0,3),c,e);h.set(e,4);h.set(c,8);h.set(g,12);return h};mat4.translationMatrix=function(h){var g=mat4.create();g[12]=h[0];g[13]=h[1];g[14]=h[2];return g};mat4.setTranslation=function(h,g){h[12]=g[0];h[13]=g[1];h[14]=g[2];return h};mat4.getTranslation=function(h,g){h[0]=g[12];h[1]=g[13];h[2]=g[14];return h};mat4.toRotationMat4=
function(h,g){mat4.copy(h,g);h[12]=h[13]=h[14]=0;return h};mat4.swapRows=function(h,g,c,e){if(h!=g)return mat4.copy(h,g),h[4*c]=g[4*e],h[4*c+1]=g[4*e+1],h[4*c+2]=g[4*e+2],h[4*c+3]=g[4*e+3],h[4*e]=g[4*c],h[4*e+1]=g[4*c+1],h[4*e+2]=g[4*c+2],h[4*e+3]=g[4*c+3],h;g=new Float32Array(matrix.subarray(4*c,5*c));matrix.set(matrix.subarray(4*e,5*e),4*c);matrix.set(g,4*e);return h};mat4.scaleAndAdd=function(h,g,c,e){h[0]=g[0]+c[0]*e;h[1]=g[1]+c[1]*e;h[2]=g[2]+c[2]*e;h[3]=g[3]+c[3]*e;h[4]=g[4]+c[4]*e;h[5]=g[5]+
c[5]*e;h[6]=g[6]+c[6]*e;h[7]=g[7]+c[7]*e;h[8]=g[8]+c[8]*e;h[9]=g[9]+c[9]*e;h[10]=g[10]+c[10]*e;h[11]=g[11]+c[11]*e;h[12]=g[12]+c[12]*e;h[13]=g[13]+c[13]*e;h[14]=g[14]+c[14]*e;h[15]=g[15]+c[15]*e;return h};quat.fromAxisAngle=function(h,g){var c=quat.create();g*=.5;var e=Math.sin(g);c[0]=e*h[0];c[1]=e*h[1];c[2]=e*h[2];c[3]=Math.cos(g);return c};quat.toEuler=function(h,g){var c=Math.atan2(2*g[1]*g[3]-2*g[0]*g[2],1-2*g[1]*g[1]-2*g[2]*g[2]),e=Math.asin(2*g[0]*g[1]+2*g[2]*g[3]);g=Math.atan2(2*g[0]*g[3]-
2*g[1]*g[2],1-2*g[0]*g[0]-2*g[2]*g[2]);h||(h=vec3.create());vec3.set(h,c,e,g);return h};quat.fromEuler=function(h,g){var c=g[0],e=g[1];g=g[2];var a=Math.cos(c),b=Math.cos(e),d=Math.cos(g);c=Math.sin(c);e=Math.sin(e);g=Math.sin(g);var f=.5*Math.sqrt(1+a*b+a*d-c*e*g+b*d);0==f&&(f=1E-6);quat.set(h,(b*g+a*g+c*e*d)/(4*f),(c*b+c*d+a*e*g)/(4*f),(-c*g+a*e*d+e)/(4*f),f);quat.normalize(h,h);return h};quat.fromMat4=function(h,g){var c=g[0]+g[5]+g[10];if(0<c){var e=Math.sqrt(c+1);h[3]=.5*e;e=.5/e;h[0]=(g[9]-
g[6])*e;h[1]=(g[2]-g[8])*e;h[2]=(g[4]-g[1])*e}else{c=0;g[5]>g[0]&&(c=1);g[10]>g[4*c+c]&&(c=2);var a=(c+1)%3,b=(a+1)%3;e=Math.sqrt(g[4*c+c]-g[4*a+a]-g[4*b+b]+1);h[c]=.5*e;e=.5/e;h[3]=(g[4*b+a]-g[4*a+b])*e;h[a]=(g[4*a+c]+g[4*c+a])*e;h[b]=(g[4*b+c]+g[4*c+b])*e}quat.normalize(h,h)};quat.fromMat4.lookAt=function(){var h=vec3.create();return function(g,c,e){e=vec3.dot(vec3.FRONT,c);if(1E-6>Math.abs(e- -1))return g.set(vec3.UP),g[3]=Math.PI,g;if(1E-6>Math.abs(e-1))return quat.identity(g);e=Math.acos(e);
vec3.cross(h,vec3.FRONT,c);vec3.normalize(h,h);quat.setAxisAngle(g,h,e);return g}}();q.Indexer=function(){this.unique=[];this.indices=[];this.map={}};q.Indexer.prototype={add:function(h){var g=JSON.stringify(h);g in this.map||(this.map[g]=this.unique.length,this.unique.push(h));return this.map[g]}};q.Buffer=function(h,g,c,e,a){q.debug&&console.log("GL.Buffer created");null!==a&&(a=a||z.gl);this.buffer=null;this.target=h;this.gl=a;this.data=g;this.spacing=c||3;this.data&&this.gl&&this.upload(e)};q.Buffer.prototype.forEach=
function(h){for(var g=this.data,c=0,e=this.spacing,a=g.length;c<a;c+=e)h(g.subarray(c,c+e),c);return this};q.Buffer.prototype.applyTransform=function(h){for(var g=this.data,c=0,e=this.spacing,a=g.length;c<a;c+=e)e=g.subarray(c,c+e),vec3.transformMat4(e,e,h);return this};q.Buffer.prototype.upload=function(h){var g=this.spacing||3,c=this.gl;if(c){if(!this.data)throw"No data supplied";var e=this.data;if(!e.buffer)throw"Buffers must be typed arrays";if(this.buffer=this.buffer||c.createBuffer()){this.buffer.length=
e.length;this.buffer.spacing=g;switch(e.constructor){case Int8Array:this.buffer.gl_type=c.BYTE;break;case Uint8ClampedArray:case Uint8Array:this.buffer.gl_type=c.UNSIGNED_BYTE;break;case Int16Array:this.buffer.gl_type=c.SHORT;break;case Uint16Array:this.buffer.gl_type=c.UNSIGNED_SHORT;break;case Int32Array:this.buffer.gl_type=c.INT;break;case Uint32Array:this.buffer.gl_type=c.UNSIGNED_INT;break;case Float32Array:this.buffer.gl_type=c.FLOAT;break;default:throw"unsupported buffer type";}c.bindBuffer(this.target,
this.buffer);c.bufferData(this.target,e,h||this.stream_type||c.STATIC_DRAW)}}};q.Buffer.prototype.compile=q.Buffer.prototype.upload;q.Buffer.prototype.setData=function(h,g){if(!h.buffer)throw"Data must be typed array";g=g||0;if(this.data){if(this.data.length<h.length)throw"buffer is not big enough, you cannot set data to a smaller buffer";this.data!=h&&(this.data.length==h.length?(this.data.set(h),this.upload()):(h=new Uint8Array(h.buffer,h.buffer.byteOffset,h.buffer.byteLength),(new Uint8Array(this.data.buffer)).set(h,
g),this.uploadRange(g,h.length)))}else this.data=h,this.upload()};q.Buffer.prototype.uploadRange=function(h,g){if(!this.data)throw"No data stored in this buffer";if(!this.data.buffer)throw"Buffers must be typed arrays";g=new Uint8Array(this.data.buffer,h,g);var c=this.gl;c.bindBuffer(this.target,this.buffer);c.bufferSubData(this.target,h,g)};q.Buffer.prototype.clone=function(h){var g=new q.Buffer;if(h)for(var c in this)g[c]=this[c];else this.target&&(g.target=this.target),this.gl&&(g.gl=this.gl),
this.spacing&&(g.spacing=this.spacing),this.data&&(g.data=new z[this.data.constructor](this.data),g.upload());return g};z.Mesh=q.Mesh=function(h,g,c,e){q.debug&&console.log("GL.Mesh created");null!==e&&(this.gl=e=e||z.gl);this._context_id=e.context_id;this.vertexBuffers={};this.indexBuffers={};this.bounding=this.info=null;(h||g)&&this.addBuffers(h,g,c?c.stream_type:null);if(c)for(var a in c)this[a]=c[a]};Mesh.common_buffers={vertices:{spacing:3,attribute:"a_vertex"},vertices2D:{spacing:2,attribute:"a_vertex2D"},
normals:{spacing:3,attribute:"a_normal"},coords:{spacing:2,attribute:"a_coord"},coords1:{spacing:2,attribute:"a_coord1"},coords2:{spacing:2,attribute:"a_coord2"},colors:{spacing:4,attribute:"a_color"},tangents:{spacing:3,attribute:"a_tangent"},bone_indices:{spacing:4,attribute:"a_bone_indices",type:Uint8Array},weights:{spacing:4,attribute:"a_weights"},extra:{spacing:1,attribute:"a_extra"},extra2:{spacing:2,attribute:"a_extra2"},extra3:{spacing:3,attribute:"a_extra3"},extra4:{spacing:4,attribute:"a_extra4"}};
Mesh.default_datatype=Float32Array;Mesh.prototype.addBuffer=function(h,g){g.target==gl.ARRAY_BUFFER?this.vertexBuffers[h]=g:this.indexBuffers[h]=g;g.attribute||(g.attribute=q.Mesh.common_buffers[h].attribute)};Mesh.prototype.addBuffers=function(h,g,c){var e=0;this.vertexBuffers.vertices&&(e=this.vertexBuffers.vertices.data.length/3);for(var a in h){var b=h[a];if(b){if(b.constructor==q.Buffer)b=b.data;else if("number"!=typeof b[0]){for(var d=[],f=0,k=1E4;f<b.length;f+=k)d=Array.prototype.concat.apply(d,
b.slice(f,f+k));b=d}d=q.Mesh.common_buffers[a];b.constructor===Array&&(f=q.Mesh.default_datatype,d&&d.type&&(f=d.type),b=new f(b));"vertices"==a&&(e=b.length/3);f=b.length/e;d&&d.spacing&&(f=d.spacing);k="a_"+a;d&&d.attribute&&(k=d.attribute);this.createVertexBuffer(a,k,f,b,c)}}if(g)for(a in g)if(b=g[a]){b.constructor==q.Buffer&&(b=b.data);if("number"!=typeof b[0]){d=[];a=0;for(k=1E4;a<b.length;a+=k)d=Array.prototype.concat.apply(d,b.slice(a,a+k));b=d}b.constructor===Array&&(f=Uint16Array,65536<e&&
(f=Uint32Array),b=new f(b));this.createIndexBuffer(a,b)}};Mesh.prototype.createVertexBuffer=function(h,g,c,e,a){var b=q.Mesh.common_buffers[h];!g&&b&&(g=b.attribute);if(!g)throw"Buffer added to mesh without attribute name";!c&&b&&(c=b&&b.spacing?b.spacing:3);if(!e){e=this.getNumVertices();if(!e)throw"Cannot create an empty buffer in a mesh without vertices (vertices are needed to know the size)";e=new q.Mesh.default_datatype(e*c)}if(!e.buffer)throw"Buffer data MUST be typed array";c=this.vertexBuffers[h]=
new q.Buffer(gl.ARRAY_BUFFER,e,c,a,this.gl);c.name=h;c.attribute=g;return c};Mesh.prototype.removeVertexBuffer=function(h){this.vertexBuffers[h]&&delete this.vertexBuffers[h]};Mesh.prototype.getVertexBuffer=function(h){return this.vertexBuffers[h]};Mesh.prototype.createIndexBuffer=function(h,g,c){if(g.constructor===Array){var e=Uint16Array,a=this.vertexBuffers.vertices;a&&(65536<a.data.length/3&&(e=Uint32Array),g=new e(g))}return this.indexBuffers[h]=new q.Buffer(gl.ELEMENT_ARRAY_BUFFER,g,0,c,this.gl)};
Mesh.prototype.getBuffer=function(h){return this.vertexBuffers[h]};Mesh.prototype.getIndexBuffer=function(h){return this.indexBuffers[h]};Mesh.prototype.upload=function(h){for(var g in this.vertexBuffers){var c=this.vertexBuffers[g];c.upload(h)}for(var e in this.indexBuffers)c=this.indexBuffers[e],c.upload()};Mesh.prototype.compile=Mesh.prototype.upload;Mesh.prototype.deleteBuffers=function(){for(var h in this.vertexBuffers){var g=this.vertexBuffers[h];this.gl.deleteBuffer(g.buffer)}this.vertexBuffers=
{};for(h in this.indexBuffers)g=this.indexBuffers[h],this.gl.deleteBuffer(g.buffer);this.indexBuffers[h]={}};Mesh.prototype.bindBuffers=function(h){for(var g in this.vertexBuffers){var c=this.vertexBuffers[g],e=h.attributes[c.attribute||g];null!=e&&c.buffer&&(gl.bindBuffer(gl.ARRAY_BUFFER,c.buffer),gl.enableVertexAttribArray(e),gl.vertexAttribPointer(e,c.buffer.spacing,c.buffer.gl_type,!1,0,0))}};Mesh.prototype.unbindBuffers=function(h){for(var g in this.vertexBuffers){var c=this.vertexBuffers[g],
e=c.attribute||g;null!=h.attributes[e]&&c.buffer&&gl.disableVertexAttribArray(h.attributes[e])}};Mesh.prototype.clone=function(h){h=h||z.gl;var g={},c={},e;for(e in this.vertexBuffers){var a=this.vertexBuffers[e];g[e]=new a.data.constructor(a.data)}for(e in this.indexBuffers)a=this.indexBuffers[e],c[e]=new a.data.constructor(a.data);return new q.Mesh(g,c,void 0,h)};Mesh.prototype.cloneShared=function(h){h=h||z.gl;return new q.Mesh(this.vertexBuffers,this.indexBuffers,void 0,h)};Mesh.prototype.toObject=
function(){var h={},g={},c;for(c in this.vertexBuffers){var e=this.vertexBuffers[c];h[c]={spacing:e.spacing,data:new e.data.constructor(e.data)}}for(c in this.indexBuffers)e=this.indexBuffers[c],g[c]={data:new e.data.constructor(e.data)};return{vertexBuffers:h,indexBuffers:g}};Mesh.prototype.generateMetadata=function(){var h={},g=this.vertexBuffers.vertices.data,c=this.indexBuffers.triangles.data;h.vertices=g.length/3;h.faces=c?c.length/3:g.length/9;h.indexed=!!this.metadata.faces;this.metadata=h};
Mesh.prototype.toJSON=function(){return""};Mesh.prototype.computeWireframe=function(){var h=this.indexBuffers.triangles,g=this.vertexBuffers.vertices.data.length/3;if(h){var c=h.data,e=new q.Indexer;for(h=0;h<c.length;h+=3)for(var a=c.subarray(h,h+3),b=0;b<a.length;b++){var d=a[b],f=a[(b+1)%a.length];e.add([Math.min(d,f),Math.max(d,f)])}c=e.unique;e=65536<g?new Uint32Array(2*c.length):new Uint16Array(2*c.length);h=0;for(g=c.length;h<g;++h)e.set(c[h],2*h)}else for(h=g/3,e=65536<g?new Uint32Array(6*
h):new Uint16Array(6*h),h=0;h<g;h+=3)e[2*h]=h,e[2*h+1]=h+1,e[2*h+2]=h+1,e[2*h+3]=h+2,e[2*h+4]=h+2,e[2*h+5]=h;this.createIndexBuffer("wireframe",e);return this};Mesh.prototype.flipNormals=function(h){var g=this.vertexBuffers.normals;if(g){for(var c=g.data,e=c.length,a=0;a<e;++a)c[a]*=-1;g.upload(h);this.indexBuffers.triangles&&this.computeIndices();g=this.indexBuffers.triangles;c=g.data;e=c.length;for(a=0;a<e;a+=3){var b=c[a];c[a]=c[a+1];c[a+1]=b}g.upload(h)}};Mesh.prototype.computeIndices=function(){var h=
[],g=[],c=[],e=[],a=this.vertexBuffers.normals,b=this.vertexBuffers.coords,d=this.vertexBuffers.vertices.data,f=null;a&&(f=a.data);a=null;b&&(a=b.data);b={};for(var k=d.length/3,l=0;l<k;++l){var m=d.subarray(3*l,3*(l+1)),r=1E3*m[0]|0,n=0,p=b[r];if(p)for(var w=p.length;n<w;n++)if(.01>vec3.sqrDist(m,h[p[n]])){e.push(n);break}p&&n!=w||(h.push(m),b[r]?b[r].push(n):b[r]=[n],f&&g.push(f.subarray(3*l,3*(l+1))),a&&c.push(a.subarray(2*l,2*(l+1))),e.push(n))}this.vertexBuffers={};this.createVertexBuffer("vertices",
q.Mesh.common_buffers.vertices.attribute,3,linearizeArray(h));f&&this.createVertexBuffer("normals",q.Mesh.common_buffers.normals.attribute,3,linearizeArray(g));a&&this.createVertexBuffer("coords",q.Mesh.common_buffers.coords.attribute,2,linearizeArray(c));this.createIndexBuffer("triangles",e)};Mesh.prototype.computeNormals=function(h){var g=this.vertexBuffers.vertices.data,c=new Float32Array(g.length),e=null;this.indexBuffers.triangles&&(e=this.indexBuffers.triangles.data);for(var a=q.temp_vec3,b=
q.temp2_vec3,d,f,k,l,m,r,n=e?e.length:g.length,p=0;p<n;p+=3)e?(d=e[p],f=e[p+1],k=e[p+2],l=g.subarray(3*d,3*d+3),m=g.subarray(3*f,3*f+3),r=g.subarray(3*k,3*k+3),d=c.subarray(3*d,3*d+3),f=c.subarray(3*f,3*f+3),k=c.subarray(3*k,3*k+3)):(l=g.subarray(3*p,3*p+3),m=g.subarray(3*p+3,3*p+6),r=g.subarray(3*p+6,3*p+9),d=c.subarray(3*p,3*p+3),f=c.subarray(3*p+3,3*p+6),k=c.subarray(3*p+6,3*p+9)),vec3.sub(a,m,l),vec3.sub(b,r,l),vec3.cross(a,a,b),vec3.normalize(a,a),vec3.add(d,d,a),vec3.add(f,f,a),vec3.add(k,k,
a);if(e)for(p=0,n=c.length;p<n;p+=3)g=c.subarray(p,p+3),vec3.normalize(g,g);if(n=this.vertexBuffers.normals)n.data=c,n.upload(h);else return this.createVertexBuffer("normals",q.Mesh.common_buffers.normals.attribute,3,c);return n};Mesh.prototype.computeTangents=function(){var h=this.vertexBuffers.vertices.data,g=this.vertexBuffers.normals.data,c=this.vertexBuffers.coords.data,e=this.indexBuffers.triangles.data;if(h&&g&&c){var a=h.length/3,b=new Float32Array(4*a),d=new Float32Array(6*a);a=d.subarray(3*
a);var f,k=vec3.create(),l=vec3.create(),m=vec3.create(),r=vec3.create();var n=0;for(f=e.length;n<f;n+=3){var p=e[n],w=e[n+1],v=e[n+2],t=h.subarray(3*p,3*p+3),u=h.subarray(3*w,3*w+3),x=h.subarray(3*v,3*v+3),y=c.subarray(2*p,2*p+2),B=c.subarray(2*w,2*w+2),J=c.subarray(2*v,2*v+2),I=u[0]-t[0],A=x[0]-t[0],C=u[1]-t[1],D=x[1]-t[1];u=u[2]-t[2];t=x[2]-t[2];x=B[0]-y[0];var E=J[0]-y[0];B=B[1]-y[1];y=J[1]-y[1];J=x*y-E*B;J=1E-9>Math.abs(J)?0:1/J;vec3.copy(k,[(y*I-B*A)*J,(y*C-B*D)*J,(y*u-B*t)*J]);vec3.copy(l,
[(x*A-E*I)*J,(x*D-E*C)*J,(x*t-E*u)*J]);vec3.add(d.subarray(3*p,3*p+3),d.subarray(3*p,3*p+3),k);vec3.add(d.subarray(3*w,3*w+3),d.subarray(3*w,3*w+3),k);vec3.add(d.subarray(3*v,3*v+3),d.subarray(3*v,3*v+3),k);vec3.add(a.subarray(3*p,3*p+3),a.subarray(3*p,3*p+3),l);vec3.add(a.subarray(3*w,3*w+3),a.subarray(3*w,3*w+3),l);vec3.add(a.subarray(3*v,3*v+3),a.subarray(3*v,3*v+3),l)}n=0;for(f=h.length;n<f;n+=3)h=g.subarray(n,n+3),c=d.subarray(n,n+3),vec3.subtract(m,c,vec3.scale(m,h,vec3.dot(h,c))),vec3.normalize(m,
m),h=0>vec3.dot(vec3.cross(r,h,c),a.subarray(n,n+3))?-1:1,b.set([m[0],m[1],m[2],h],n/3*4);this.createVertexBuffer("tangents",Mesh.common_buffers.tangents.attribute,4,b)}};Mesh.prototype.getNumVertices=function(){var h=this.vertexBuffers.vertices;return h?h.data.length/h.spacing:0};Mesh.computeBounding=function(h,g){if(h){for(var c=vec3.clone(h.subarray(0,3)),e=vec3.clone(h.subarray(0,3)),a,b=3;b<h.length;b+=3)a=h.subarray(b,b+3),vec3.min(c,a,c),vec3.max(e,a,e);if(isNaN(c[0])||isNaN(c[1])||isNaN(c[2])||
isNaN(e[0])||isNaN(e[1])||isNaN(e[2]))c[0]=c[1]=c[2]=0,e[0]=e[1]=e[2]=0,console.warn("Warning: GL.Mesh has NaN values in vertices");c=vec3.add(vec3.create(),c,e);vec3.scale(c,c,.5);e=vec3.subtract(vec3.create(),e,c);return BBox.setCenterHalfsize(g||BBox.create(),c,e)}};Mesh.prototype.getBoundingBox=function(){this.bounding||this.updateBounding();return this.bounding};Mesh.prototype.updateBounding=function(){var h=this.vertexBuffers.vertices.data;h&&(this.bounding=q.Mesh.computeBounding(h,this.bounding))};
Mesh.prototype.setBounding=function(h,g){this.bounding=BBox.setCenterHalfsize(this.bounding||BBox.create(),h,g)};Mesh.prototype.freeData=function(){for(var h in this.vertexBuffers)this.vertexBuffers[h].data=null,delete this[this.vertexBuffers[h].name];for(var g in this.indexBuffers)this.indexBuffers[g].data=null,delete this[this.indexBuffers[g].name]};Mesh.prototype.configure=function(h,g){var c={},e={};g=g||{};for(var a in h)h[a]&&("indices"==a||"lines"==a||"wireframe"==a||"triangles"==a?e[a]=h[a]:
q.Mesh.common_buffers[a]?c[a]=h[a]:g[a]=h[a]);this.addBuffers(c,e,g.stream_type);for(e in g)this[e]=g[e]};Mesh.prototype.totalMemory=function(){var h=0,g;for(g in this.vertexBuffers)h+=this.vertexBuffers[g].data.buffer.byteLength;for(g in this.indexBuffers)h+=this.indexBuffers[g].data.buffer.byteLength;return h};Mesh.prototype.simplify=function(){var h=this.getBoundingBox(),g=BBox.getMin(h);h=BBox.getHalfsize(h);h=vec3.scale(vec3.create(),h,2);var c=new q.Mesh,e=vec3.create(),a;for(a in this.vertexBuffers){var b=
this.vertexBuffers[a].data,d=new Float32Array(b.length);if("vertices"==a)for(var f=0,k=b.length;f<k;f+=3){var l=b.subarray(f,f+3);vec3.sub(e,l,g);vec3.div(e,e,h);e[0]=Math.round(256*e[0])/256;e[1]=Math.round(256*e[1])/256;e[2]=Math.round(256*e[2])/256;vec3.mul(e,e,h);vec3.add(e,e,g);d.set(e,f)}c.addBuffer()}};Mesh.load=function(h,g,c,e){g=g||{};g.no_gl&&(e=null);c=c||new q.Mesh(null,null,null,e);c.configure(h,g);return c};Mesh.mergeMeshes=function(h,g){function c(u,x,y,B){for(y=x+y;x<y;x+=3){var J=
u.subarray(x,x+3);vec3.transformMat4(J,J,B)}}function e(u,x,y,B){for(y=x+y;x<y;x+=2){var J=u.subarray(x,x+2);vec2.transformMat3(J,J,B)}}function a(u,x,y,B){for(y=x+y;x<y;++x)u[x]+=B}g=g||{};for(var b={},d={},f={},k=[],l=0,m=[],r=0;r<h.length;++r){var n=h[r],p=n.mesh,w=l;k.push(w);var v=p.vertexBuffers.vertices.data.length/3;l+=v;for(var t in p.vertexBuffers)b[t]=b[t]?b[t]+p.vertexBuffers[t].data.length:p.vertexBuffers[t].data.length;for(t in p.indexBuffers)d[t]=d[t]?d[t]+p.indexBuffers[t].data.length:
p.indexBuffers[t].data.length;m.push({name:"mesh_"+r,start:w,length:v,material:""})}for(t in b)r=g[t],null===r?delete b[t]:(r||(r=Float32Array),b[t]=new r(b[t]),f[t]=0);for(t in d)d[t]=new Uint32Array(d[t]),f[t]=0;for(r=0;r<h.length;++r){n=h[r];p=n.mesh;v=w=0;for(t in p.vertexBuffers)b[t]&&("vertices"==t&&(v=p.vertexBuffers[t].data.length/3),b[t].set(p.vertexBuffers[t].data,f[t]),n[t+"_matrix"]&&(l=n[t+"_matrix"],16==l.length?c(b[t],f[t],p.vertexBuffers[t].data.length,l):9==l.length&&e(b[t],f[t],
p.vertexBuffers[t].data.length,l)),f[t]+=p.vertexBuffers[t].data.length);for(t in p.indexBuffers)d[t].set(p.indexBuffers[t].data,f[t]),a(d[t],f[t],p.indexBuffers[t].data.length,k[r]),f[t]+=p.indexBuffers[t].data.length}f={info:{groups:m}};return"undefined"!=typeof gl?new q.Mesh(b,d,f):{vertexBuffers:b,indexBuffers:d,info:{groups:m}}};Mesh.parsers={};Mesh.encoders={};Mesh.fromURL=function(h,g,c,e){e=e||{};c=c||z.gl;var a=new q.Mesh(void 0,void 0,void 0,c);a.ready=!1;HttpRequest(h,null,function(b){var d=
h.lastIndexOf(".");d=h.substr(d+1);a.parse(b,d);delete a.ready;g&&g.call(a,a,h)},function(b){g&&g(null)},e);return a};Mesh.prototype.parse=function(h,g){g=g.toLowerCase();var c=q.Mesh.parsers[g];if(c)return c.call(null,h,{mesh:this});throw"GL.Mesh.parse: no parser found for format "+g;};Mesh.prototype.encode=function(h,g){h=h.toLowerCase();var c=q.Mesh.encoders[h];if(c)return c.call(null,this,g);throw"GL.Mesh.encode: no encoder found for format "+h;};Mesh.getScreenQuad=function(h){h=h||z.gl;var g=
h.meshes[":screen_quad"];if(g)return g;g=new Float32Array([0,0,0,1,1,0,0,1,0,0,0,0,1,0,0,1,1,0]);var c=new Float32Array([0,0,1,1,0,1,0,0,1,0,1,1]);g=new q.Mesh({vertices:g,coords:c},void 0,void 0,h);return h.meshes[":screen_quad"]=g};Mesh.plane=function(h,g){h=h||{};h.triangles=[];var c=h.detailX||h.detail||1,e=h.detailY||h.detail||1,a=h.width||h.size||1,b=h.height||h.size||1;h=h.xz;a*=.5;b*=.5;var d=[],f=[],k=[],l=[],m=vec3.fromValues(0,0,1);h&&m.set([0,1,0]);for(var r=0;r<=e;r++)for(var n=r/e,p=
0;p<=c;p++){var w=p/c;h?f.push((2*w-1)*a,0,-(2*n-1)*b):f.push((2*w-1)*a,(2*n-1)*b,0);k&&k.push(w,n);l&&l.push(m[0],m[1],m[2]);p<c&&r<e&&(w=p+r*(c+1),h?(d.push(w+1,w+c+1,w),d.push(w+1,w+c+2,w+c+1)):(d.push(w,w+1,w+c+1),d.push(w+c+1,w+1,w+c+2)))}c=BBox.fromCenterHalfsize([0,0,0],h?[a,0,b]:[a,b,0]);return q.Mesh.load({vertices:f,normals:l,coords:k,triangles:d},{bounding:c},g)};Mesh.plane2D=function(h,g){var c=new Float32Array([-1,1,1,-1,1,1,-1,1,-1,-1,1,-1]),e=new Float32Array([0,1,1,0,1,1,0,1,0,0,1,
0]);if(h&&h.size){h=.5*h.size;for(var a=0;a<c.length;++a)c[a]*=h}return new q.Mesh({vertices2D:c,coords:e},null,g)};Mesh.point=function(h){return new q.Mesh({vertices:[0,0,0]})};Mesh.cube=function(h,g){h=h||{};var c=.5*(h.size||1),e={};e.vertices=new Float32Array([-1,1,-1,-1,-1,1,-1,1,1,-1,1,-1,-1,-1,-1,-1,-1,1,1,1,-1,1,1,1,1,-1,1,1,1,-1,1,-1,1,1,-1,-1,-1,1,1,1,-1,1,1,1,1,-1,1,1,-1,-1,1,1,-1,1,-1,1,-1,1,1,-1,1,-1,-1,-1,1,-1,1,-1,-1,-1,-1,-1,-1,1,-1,1,1,1,1,1,-1,-1,1,-1,-1,1,1,1,1,1,-1,-1,-1,1,-1,
-1,1,-1,1,-1,-1,-1,1,-1,1,-1,-1,1]);for(var a=0,b=e.vertices.length;a<b;++a)e.vertices[a]*=c;e.normals=new Float32Array([-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0]);e.coords=new Float32Array([0,1,1,0,1,1,0,1,0,0,1,0,1,1,0,1,0,0,1,1,0,0,1,0,0,1,1,0,1,1,0,1,0,0,1,0,1,1,0,1,0,0,1,1,0,0,1,0,0,1,1,0,1,1,0,1,0,0,1,
0,1,1,0,1,0,0,1,1,0,0,1,0]);h.wireframe&&(e.wireframe=new Uint16Array([0,2,2,5,5,4,4,0,6,7,7,10,10,11,11,6,0,6,2,7,5,10,4,11]));h.bounding=BBox.fromCenterHalfsize([0,0,0],[c,c,c]);return q.Mesh.load(e,h,g)};Mesh.box=function(h,g){h=h||{};var c=h.sizex||1,e=h.sizey||1,a=h.sizez||1;c*=.5;e*=.5;a*=.5;var b={};b.vertices=new Float32Array([-1,1,-1,-1,-1,1,-1,1,1,-1,1,-1,-1,-1,-1,-1,-1,1,1,1,-1,1,1,1,1,-1,1,1,1,-1,1,-1,1,1,-1,-1,-1,1,1,1,-1,1,1,1,1,-1,1,1,-1,-1,1,1,-1,1,-1,1,-1,1,1,-1,1,-1,-1,-1,1,-1,1,
-1,-1,-1,-1,-1,-1,1,-1,1,1,1,1,1,-1,-1,1,-1,-1,1,1,1,1,1,-1,-1,-1,1,-1,-1,1,-1,1,-1,-1,-1,1,-1,1,-1,-1,1]);for(var d=0,f=b.vertices.length;d<f;d+=3)b.vertices[d]*=c,b.vertices[d+1]*=e,b.vertices[d+2]*=a;b.normals=new Float32Array([-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0]);b.coords=new Float32Array([0,1,1,0,
1,1,0,1,0,0,1,0,1,1,0,1,0,0,1,1,0,0,1,0,0,1,1,0,1,1,0,1,0,0,1,0,1,1,0,1,0,0,1,1,0,0,1,0,0,1,1,0,1,1,0,1,0,0,1,0,1,1,0,1,0,0,1,1,0,0,1,0]);h.wireframe&&(b.wireframe=new Uint16Array([0,2,2,5,5,4,4,0,6,7,7,10,10,11,11,6,0,6,2,7,5,10,4,11]));h.bounding=BBox.fromCenterHalfsize([0,0,0],[c,e,a]);return q.Mesh.load(b,h,g)};Mesh.circle=function(h,g){h=h||{};var c=h.size||h.radius||1,e=Math.ceil(h.slices||24),a=h.xz||!1,b=h.empty||!1;3>e&&(e=3);var d=2*Math.PI/e,f=vec3.create(),k=vec3.create(),l=vec3.fromValues(0,
0,1),m=vec2.fromValues(.5,.5),r=vec2.create();a&&l.set([0,1,0]);var n=a?2:1,p=new Float32Array(3*(e+1)),w=new Float32Array(3*(e+1)),v=new Float32Array(2*(e+1));p.set(f,0);w.set(l,0);v.set(m,0);for(f=0;f<e;++f){var t=Math.sin(d*f);m=Math.cos(d*f);k[0]=t*c;k[n]=m*c;r[0]=.5*t+.5;r[1]=.5*m+.5;p.set(k,3*f+3);w.set(l,3*f+3);v.set(r,2*f+2)}if(b)p=p.subarray(3),w=p.subarray(3),v=p.subarray(2),t=null;else{t=new Uint16Array(3*e);b=2;d=1;a&&(b=1,d=2);for(f=0;f<e-1;++f)t[3*f]=0,t[3*f+1]=f+b,t[3*f+2]=f+d;t[3*
f]=0;a?(t[3*f+1]=f+1,t[3*f+2]=1):(t[3*f+1]=1,t[3*f+2]=f+1)}h.bounding=BBox.fromCenterHalfsize([0,0,0],a?[c,0,c]:[c,c,0]);c={vertices:p,normals:w,coords:v,triangles:t};if(h.wireframe){a=new Uint16Array(2*e);for(f=0;f<e;f++)a[2*f]=f,a[2*f+1]=f+1;a[0]=e;c.wireframe=a}return q.Mesh.load(c,h,g)};Mesh.cylinder=function(h,g){h=h||{};for(var c=h.radius||h.size||1,e=h.height||h.size||2,a=h.subdivisions||64,b=new Float32Array(36*a),d=new Float32Array(36*a),f=new Float32Array(24*a),k=2*Math.PI/a,l,m=0;m<a;++m){var r=
m*k;l=[Math.sin(r),0,Math.cos(r)];b.set([l[0]*c,.5*e,l[2]*c],18*m);d.set(l,18*m);f.set([m/a,1],12*m);l=[Math.sin(r),0,Math.cos(r)];b.set([l[0]*c,-.5*e,l[2]*c],18*m+3);d.set(l,18*m+3);f.set([m/a,0],12*m+2);l=[Math.sin(r+k),0,Math.cos(r+k)];b.set([l[0]*c,-.5*e,l[2]*c],18*m+6);d.set(l,18*m+6);f.set([(m+1)/a,0],12*m+4);l=[Math.sin(r+k),0,Math.cos(r+k)];b.set([l[0]*c,.5*e,l[2]*c],18*m+9);d.set(l,18*m+9);f.set([(m+1)/a,1],12*m+6);l=[Math.sin(r),0,Math.cos(r)];b.set([l[0]*c,.5*e,l[2]*c],18*m+12);d.set(l,
18*m+12);f.set([m/a,1],12*m+8);l=[Math.sin(r+k),0,Math.cos(r+k)];b.set([l[0]*c,-.5*e,l[2]*c],18*m+15);d.set(l,18*m+15);f.set([(m+1)/a,0],12*m+10)}l=18*m;var n=12*m;if(!1===h.caps)b=b.subarray(0,l),d=d.subarray(0,l),f=f.subarray(0,n);else{var p=vec3.fromValues(0,.5*e,0),w=vec3.fromValues(0,-.5*e,0),v=vec3.fromValues(0,1,0),t=vec3.fromValues(0,-1,0);for(m=0;m<a;++m){r=m*k;var u=vec3.fromValues(Math.sin(r),0,Math.cos(r));r=vec3.fromValues(Math.sin(r+k),0,Math.cos(r+k));b.set([u[0]*c,.5*e,u[2]*c],l+18*
m);d.set(v,l+18*m);f.set([.5*-u[0]+.5,.5*u[2]+.5],n+12*m);b.set([r[0]*c,.5*e,r[2]*c],l+18*m+3);d.set(v,l+18*m+3);f.set([.5*-r[0]+.5,.5*r[2]+.5],n+12*m+2);b.set(p,l+18*m+6);d.set(v,l+18*m+6);f.set([.5,.5],n+12*m+4);b.set([r[0]*c,-.5*e,r[2]*c],l+18*m+9);d.set(t,l+18*m+9);f.set([.5*r[0]+.5,.5*r[2]+.5],n+12*m+6);b.set([u[0]*c,-.5*e,u[2]*c],l+18*m+12);d.set(t,l+18*m+12);f.set([.5*u[0]+.5,.5*u[2]+.5],n+12*m+8);b.set(w,l+18*m+15);d.set(t,l+18*m+15);f.set([.5,.5],n+12*m+10)}}a={vertices:b,normals:d,coords:f};
h.bounding=BBox.fromCenterHalfsize([0,0,0],[c,.5*e,c]);return Mesh.load(a,h,g)};Mesh.sphere=function(h,g){h=h||{};for(var c=h.radius||h.size||1,e=h.lat||h.subdivisions||16,a=h["long"]||h.subdivisions||16,b=new Float32Array((e+1)*(a+1)*3),d=new Float32Array((e+1)*(a+1)*3),f=new Float32Array((e+1)*(a+1)*2),k=new Uint16Array(e*a*6),l=h.hemi?.5*Math.PI:Math.PI,m=0,r=0,n=0;n<=e;n++){var p=n*l/e,w=Math.sin(p),v=Math.cos(p);for(p=0;p<=a;p++){var t=2*p*Math.PI/a,u=Math.sin(t);t=Math.cos(t)*w;var x=v;u*=w;
var y=1-p/a,B=1-n/e;b.set([c*t,c*x,c*u],m);d.set([t,x,u],m);f.set([y,B],r);m+=3;r+=2}}for(n=m=0;n<e;n++)for(p=0;p<a;p++)l=n*(a+1)+p,r=l+a+1,k.set([r,l,l+1],m),k.set([r+1,r,l+1],m+3),m+=6;b={vertices:b,normals:d,coords:f,triangles:k};if(h.wireframe){d=new Uint16Array(a*e*4);for(m=f=0;m<e;m++){for(k=0;k<a;k++)d[f]=m*(a+1)+k,d[f+1]=m*(a+1)+k+1,f+=2;d[f-2*a]=m*(a+1)+k}for(m=0;m<a;m++)for(k=0;k<e;k++)d[f]=k*(a+1)+m,d[f+1]=(k+1)*(a+1)+m,f+=2;b.wireframe=d}h.bounding=h.hemi?BBox.fromCenterHalfsize([0,.5*
c,0],[c,.5*c,c],c):BBox.fromCenterHalfsize([0,0,0],[c,c,c],c);return q.Mesh.load(b,h,g)};Mesh.grid=function(h,g){h=h||{};var c=h.lines||11;0>c&&(c=1);var e=h.size||10,a=new Float32Array(12*c),b=.5*e,d=0,f=-b;e/=c-1;for(var k=0;k<c;k++)a[d]=f,a[d+2]=-b,a[d+3]=f,a[d+5]=b,a[d+6]=b,a[d+8]=f,a[d+9]=-b,a[d+11]=f,f+=e,d+=12;return new q.Mesh({vertices:a},h,g)};Mesh.icosahedron=function(h,g){function c(u,x){var y=l[u]<l[x]?l[u]+":"+l[x]:l[x]+":"+l[u],B=v[y];if(B)return B;B=d.length/3;d.push(.5*(d[3*l[u]]+
d[3*l[x]]),.5*(d[3*l[u]+1]+d[3*l[x]+1]),.5*(d[3*l[u]+2]+d[3*l[x]+2]));u=Math.sqrt(d[3*B]*d[3*B]+d[3*B+1]*d[3*B+1]+d[3*B+2]*d[3*B+2]);x=d[3*B]/u;var J=d[3*B+1]/u,I=d[3*B+2]/u;f.push(x,J,I);k.push(Math.atan2(x,I)/Math.PI*.5,Math.acos(J)/Math.PI);d[3*B]*=e/u;d[3*B+1]*=e/u;d[3*B+2]*=e/u;return v[y]=B}h=h||{};var e=h.radius||h.size||1,a=void 0===h.subdivisions?0:h.subdivisions;6<a&&(a=6);var b=(1+Math.sqrt(5))/2,d=[-1,b,0,1,b,0,-1,-b,0,1,-b,0,0,-1,b,0,1,b,0,-1,-b,0,1,-b,b,0,-1,b,0,1,-b,0,-1,-b,0,1],f=
[],k=[],l=[0,11,5,0,5,1,0,1,7,0,7,10,0,10,11,1,5,9,5,11,4,11,10,2,10,7,6,7,1,8,3,9,4,3,4,2,3,2,6,3,6,8,3,8,9,4,9,5,2,4,11,6,2,10,8,6,7,9,8,1];b=d.length;for(var m=0;m<b;m+=3){var r=Math.sqrt(d[m]*d[m]+d[m+1]*d[m+1]+d[m+2]*d[m+2]),n=d[m]/r,p=d[m+1]/r,w=d[m+2]/r;f.push(n,p,w);k.push(Math.atan2(n,w),Math.acos(p));d[m]*=e/r;d[m+1]*=e/r;d[m+2]*=e/r}var v={};for(r=0;r<a;++r){n=[];b=l.length;for(m=0;m<b;m+=3){p=c(m,m+1);w=c(m+1,m+2);var t=c(m+2,m);n.push(l[m],p,t);n.push(l[m+1],w,p);n.push(l[m+2],t,w);n.push(p,
w,t)}l=n}h.bounding=BBox.fromCenterHalfsize([0,0,0],[e,e,e],e);return new q.Mesh.load({vertices:d,coords:k,normals:f,triangles:l},h,g)};z.Texture=q.Texture=function b(g,c,e,a){e=e||{};this.gl=a=a||z.gl;this._context_id=a.context_id;g=parseInt(g);c=parseInt(c);q.debug&&console.log("GL.Texture created: ",g,c);this.handler=a.createTexture();this.width=g;this.height=c;this.texture_type=e.texture_type||a.TEXTURE_2D;this.format=e.format||b.DEFAULT_FORMAT;this.type=e.type||b.DEFAULT_TYPE;this.magFilter=
e.magFilter||e.filter||b.DEFAULT_MAG_FILTER;this.minFilter=e.minFilter||e.filter||b.DEFAULT_MIN_FILTER;this.wrapS=e.wrap||e.wrapS||b.DEFAULT_WRAP_S;this.wrapT=e.wrap||e.wrapT||b.DEFAULT_WRAP_T;this.data=null;b.MAX_TEXTURE_IMAGE_UNITS||(b.MAX_TEXTURE_IMAGE_UNITS=a.getParameter(a.MAX_TEXTURE_IMAGE_UNITS));this.has_mipmaps=!1;if(this.format==a.DEPTH_COMPONENT&&!a.extensions.WEBGL_depth_texture)throw"Depth Texture not supported";if(this.type==a.FLOAT&&!a.extensions.OES_texture_float)throw"Float Texture not supported";
if(this.type==a.HALF_FLOAT_OES&&!a.extensions.OES_texture_half_float)throw"Half Float Texture not supported";if(!(isPowerOfTwo(this.width)&&isPowerOfTwo(this.height)||(this.minFilter==a.NEAREST||this.minFilter==a.LINEAR)&&this.wrapS==a.CLAMP_TO_EDGE&&this.wrapT==a.CLAMP_TO_EDGE))if(e.ignore_pot)this.minFilter=this.magFilter=a.LINEAR,this.wrapS=this.wrapT=a.CLAMP_TO_EDGE;else throw"Cannot use texture-wrap or mipmaps in Non-Power-of-Two textures";if(g&&c){a.activeTexture(a.TEXTURE0+b.MAX_TEXTURE_IMAGE_UNITS-
1);a.bindTexture(this.texture_type,this.handler);a.texParameteri(this.texture_type,a.TEXTURE_MAG_FILTER,this.magFilter);a.texParameteri(this.texture_type,a.TEXTURE_MIN_FILTER,this.minFilter);a.texParameteri(this.texture_type,a.TEXTURE_WRAP_S,this.wrapS);a.texParameteri(this.texture_type,a.TEXTURE_WRAP_T,this.wrapT);e.anisotropic&&a.extensions.EXT_texture_filter_anisotropic&&a.texParameterf(a.TEXTURE_2D,a.extensions.EXT_texture_filter_anisotropic.TEXTURE_MAX_ANISOTROPY_EXT,e.anisotropic);var d=e.pixel_data;
d&&!d.buffer&&(this.data=d=new (this.type==a.FLOAT?Float32Array:Uint8Array)(d));this.texture_type==a.TEXTURE_2D?(a.texImage2D(a.TEXTURE_2D,0,this.format,g,c,0,this.format,this.type,d||null),q.isPowerOfTwo(g)&&q.isPowerOfTwo(c)&&e.minFilter&&e.minFilter!=a.NEAREST&&e.minFilter!=a.LINEAR&&(a.generateMipmap(this.texture_type),this.has_mipmaps=!0)):this.texture_type==a.TEXTURE_CUBE_MAP&&(a.texImage2D(a.TEXTURE_CUBE_MAP_POSITIVE_X,0,this.format,this.width,this.height,0,this.format,this.type,d||null),a.texImage2D(a.TEXTURE_CUBE_MAP_POSITIVE_Y,
0,this.format,this.width,this.height,0,this.format,this.type,d||null),a.texImage2D(a.TEXTURE_CUBE_MAP_POSITIVE_Z,0,this.format,this.width,this.height,0,this.format,this.type,d||null),a.texImage2D(a.TEXTURE_CUBE_MAP_NEGATIVE_X,0,this.format,this.width,this.height,0,this.format,this.type,d||null),a.texImage2D(a.TEXTURE_CUBE_MAP_NEGATIVE_Y,0,this.format,this.width,this.height,0,this.format,this.type,d||null),a.texImage2D(a.TEXTURE_CUBE_MAP_NEGATIVE_Z,0,this.format,this.width,this.height,0,this.format,
this.type,d||null));a.bindTexture(this.texture_type,null);a.activeTexture(a.TEXTURE0)}};Texture.DEFAULT_TYPE=q.UNSIGNED_BYTE;Texture.DEFAULT_FORMAT=q.RGBA;Texture.DEFAULT_MAG_FILTER=q.LINEAR;Texture.DEFAULT_MIN_FILTER=q.LINEAR;Texture.DEFAULT_WRAP_S=q.CLAMP_TO_EDGE;Texture.DEFAULT_WRAP_T=q.CLAMP_TO_EDGE;Texture.framebuffer=null;Texture.renderbuffer=null;Texture.loading_color=new Uint8Array([0,0,0,0]);Texture.use_renderbuffer_pool=!0;Texture.prototype.delete=function(){gl.deleteBuffer(this.handler);
this.handler=null};Texture.prototype.getProperties=function(){return{width:this.width,height:this.height,type:this.type,format:this.format,texture_type:this.texture_type,magFilter:this.magFilter,minFilter:this.minFilter,wrapS:this.wrapS,wrapT:this.wrapT}};Texture.prototype.toJSON=function(){return""};Texture.isDepthSupported=function(){return null!=gl.extensions.WEBGL_depth_texture};Texture.prototype.bind=function(g){void 0==g&&(g=0);var c=this.gl;c.activeTexture(c.TEXTURE0+g);c.bindTexture(this.texture_type,
this.handler);return g};Texture.prototype.unbind=function(g){void 0===g&&(g=0);var c=this.gl;c.activeTexture(c.TEXTURE0+g);c.bindTexture(this.texture_type,null)};Texture.prototype.setParameter=function(g,c){this.bind(0);this.gl.texParameteri(this.texture_type,g,c);switch(g){case this.gl.TEXTURE_MAG_FILTER:this.magFilter=c;break;case this.gl.TEXTURE_MIN_FILTER:this.minFilter=c;break;case this.gl.TEXTURE_WRAP_S:this.wrapS=c;break;case this.gl.TEXTURE_WRAP_T:this.wrapT=c}};Texture.setUploadOptions=function(g,
c){c=c||z.gl;g?(c.pixelStorei(c.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!!g.premultiply_alpha),c.pixelStorei(c.UNPACK_FLIP_Y_WEBGL,!g.no_flip)):(c.pixelStorei(c.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),c.pixelStorei(c.UNPACK_FLIP_Y_WEBGL,!0));c.pixelStorei(c.UNPACK_ALIGNMENT,1)};Texture.prototype.uploadImage=function(g,c){this.bind();var e=this.gl;Texture.setUploadOptions(c,e);try{e.texImage2D(e.TEXTURE_2D,0,this.format,this.format,this.type,g),this.width=g.videoWidth||g.width,this.height=g.videoHeight||g.height,
this.data=g}catch(a){if("file:"==location.protocol)throw'image not loaded for security reasons (serve this page over "http://" instead)';throw"image not loaded for security reasons (image must originate from the same domain as this page or use Cross-Origin Resource Sharing)";}this.minFilter&&this.minFilter!=e.NEAREST&&this.minFilter!=e.LINEAR&&(e.generateMipmap(this.texture_type),this.has_mipmaps=!0);e.bindTexture(this.texture_type,null)};Texture.prototype.uploadData=function(g,c){var e=this.gl;this.bind();
Texture.setUploadOptions(c,e);e.texImage2D(this.texture_type,0,this.format,this.width,this.height,0,this.format,this.type,g);this.data=g;this.minFilter&&this.minFilter!=e.NEAREST&&this.minFilter!=e.LINEAR&&(e.generateMipmap(texture.texture_type),this.has_mipmaps=!0);e.bindTexture(this.texture_type,null)};Texture.cubemap_camera_parameters=[{type:"posX",dir:vec3.fromValues(1,0,0),up:vec3.fromValues(0,1,0),right:vec3.fromValues(0,0,-1)},{type:"negX",dir:vec3.fromValues(-1,0,0),up:vec3.fromValues(0,1,
0),right:vec3.fromValues(0,0,1)},{type:"posY",dir:vec3.fromValues(0,1,0),up:vec3.fromValues(0,0,-1),right:vec3.fromValues(1,0,0)},{type:"negY",dir:vec3.fromValues(0,-1,0),up:vec3.fromValues(0,0,1),right:vec3.fromValues(1,0,0)},{type:"posZ",dir:vec3.fromValues(0,0,1),up:vec3.fromValues(0,1,0),right:vec3.fromValues(1,0,0)},{type:"negZ",dir:vec3.fromValues(0,0,-1),up:vec3.fromValues(0,1,0),right:vec3.fromValues(-1,0,0)}];Texture.prototype.drawTo=function(g,c){function e(){6E4<=q.getTime()-this.time?
(console.log("Buffer cleared"),a.deleteRenderbuffer(a._renderbuffers_pool[m]),delete a._renderbuffers_pool[m]):setTimeout(e.bind(this),6E4)}var a=this.gl,b=a.getViewport(),d=q.getTime(),f=a.getParameter(a.FRAMEBUFFER_BINDING),k=a._framebuffer=a._framebuffer||a.createFramebuffer();a.bindFramebuffer(a.FRAMEBUFFER,k);var l=null;if(Texture.use_renderbuffer_pool){a._renderbuffers_pool||(a._renderbuffers_pool={});var m=this.width+":"+this.height;a._renderbuffers_pool[m]?(l=a._renderbuffers_pool[m],l.time=
d,a.bindRenderbuffer(a.RENDERBUFFER,l)):(a._renderbuffers_pool[m]=l=a.createRenderbuffer(),l.time=d,l.width=this.width,l.height=this.height,a.bindRenderbuffer(a.RENDERBUFFER,l),setTimeout(e.bind(l),6E4))}else l=a._renderbuffer=a._renderbuffer||a.createRenderbuffer(),l.width=this.width,l.height=this.height,a.bindRenderbuffer(a.RENDERBUFFER,l);this.format===a.DEPTH_COMPONENT?a.renderbufferStorage(a.RENDERBUFFER,a.RGBA4,this.width,this.height):a.renderbufferStorage(a.RENDERBUFFER,a.DEPTH_COMPONENT16,
this.width,this.height);a.viewport(0,0,this.width,this.height);a._current_texture_drawto=this;a._current_fbo_color=k;a._current_fbo_depth=l;if(this.texture_type==a.TEXTURE_2D)this.format!==a.DEPTH_COMPONENT?(a.framebufferTexture2D(a.FRAMEBUFFER,a.COLOR_ATTACHMENT0,a.TEXTURE_2D,this.handler,0),a.framebufferRenderbuffer(a.FRAMEBUFFER,a.DEPTH_ATTACHMENT,a.RENDERBUFFER,l)):(a.framebufferRenderbuffer(a.FRAMEBUFFER,a.COLOR_ATTACHMENT0,a.RENDERBUFFER,l),a.framebufferTexture2D(a.FRAMEBUFFER,a.DEPTH_ATTACHMENT,
a.TEXTURE_2D,this.handler,0)),g(this,c);else if(this.texture_type==a.TEXTURE_CUBE_MAP)for(this.format!==a.DEPTH_COMPONENT?a.framebufferRenderbuffer(a.FRAMEBUFFER,a.DEPTH_ATTACHMENT,a.RENDERBUFFER,l):a.framebufferRenderbuffer(a.FRAMEBUFFER,a.COLOR_ATTACHMENT0,a.RENDERBUFFER,l),d=0;6>d;d++)this.format!==a.DEPTH_COMPONENT?a.framebufferTexture2D(a.FRAMEBUFFER,a.COLOR_ATTACHMENT0,a.TEXTURE_CUBE_MAP_POSITIVE_X+d,this.handler,0):a.framebufferTexture2D(a.FRAMEBUFFER,a.DEPTH_ATTACHMENT,a.TEXTURE_CUBE_MAP_POSITIVE_X+
d,this.handler,0),g(this,d,c);this.data=null;a._current_texture_drawto=null;a._current_fbo_color=null;a._current_fbo_depth=null;a.bindFramebuffer(a.FRAMEBUFFER,f);a.bindRenderbuffer(a.RENDERBUFFER,null);a.viewport(b[0],b[1],b[2],b[3]);return this};Texture.drawTo=function(g,c,e){var a=-1,b=-1,d=null;if(!g&&!e)throw"Textures missing in drawTo";if(g&&g.length)for(var f=0;f<g.length;f++){var k=g[f];if(-1==a)a=k.width;else if(a!=k.width)throw"Cannot use Texture.drawTo if textures have different dimensions";
if(-1==b)b=k.height;else if(b!=k.height)throw"Cannot use Texture.drawTo if textures have different dimensions";if(null==d)d=k.type;else if(d!=k.type)throw"Cannot use Texture.drawTo if textures have different data type, all must have the same type";}else a=e.width,b=e.height;var l=gl.extensions.WEBGL_draw_buffers;if(!l&&g&&1<g.length)throw"Rendering to several textures not supported";d=gl.getViewport();gl._framebuffer=gl._framebuffer||gl.createFramebuffer();gl.bindFramebuffer(gl.FRAMEBUFFER,gl._framebuffer);
gl.viewport(0,0,a,b);f=null;if(e&&e.format!==gl.DEPTH_COMPONENT||e.type!=gl.UNSIGNED_INT)throw"Depth texture must be of format: gl.DEPTH_COMPONENT and type: gl.UNSIGNED_INT";e?gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.DEPTH_ATTACHMENT,gl.TEXTURE_2D,e.handler,0):(f=gl._renderbuffer=gl._renderbuffer||gl.createRenderbuffer(),f.width=a,f.height=b,gl.bindRenderbuffer(gl.RENDERBUFFER,f),gl.renderbufferStorage(gl.RENDERBUFFER,gl.DEPTH_COMPONENT16,a,b),gl.framebufferRenderbuffer(gl.FRAMEBUFFER,gl.DEPTH_ATTACHMENT,
gl.RENDERBUFFER,f));if(g){a=[];for(f=0;f<g.length;f++)k=g[f],gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0+f,gl.TEXTURE_2D,k.handler,0),a.push(gl.COLOR_ATTACHMENT0+f);1<g.length&&l.drawBuffersWEBGL(a)}else e=this._color_renderbuffer=this._color_renderbuffer||gl.createRenderbuffer(),e.width=a,e.height=b,gl.bindRenderbuffer(gl.RENDERBUFFER,e),gl.renderbufferStorage(gl.RENDERBUFFER,gl.RGBA4,a,b),gl.framebufferRenderbuffer(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0,gl.RENDERBUFFER,e);a=gl.checkFramebufferStatus(gl.FRAMEBUFFER);
if(a!==gl.FRAMEBUFFER_COMPLETE)throw"FBO not complete: "+a;c();if(g.length)for(f=0;f<g.length;++f)g[f].data=null;gl.bindFramebuffer(gl.FRAMEBUFFER,null);gl.viewport(d[0],d[1],d[2],d[3])};Texture.drawToColorAndDepth=function(g,c,e){var a=g.gl;if(c.width!=g.width||c.height!=g.height)throw"Different size between color texture and depth texture";var b=a.getViewport();a._framebuffer=a._framebuffer||a.createFramebuffer();a.bindFramebuffer(a.FRAMEBUFFER,a._framebuffer);a.viewport(0,0,g.width,g.height);a.framebufferTexture2D(a.FRAMEBUFFER,
a.COLOR_ATTACHMENT0,a.TEXTURE_2D,g.handler,0);a.framebufferTexture2D(a.FRAMEBUFFER,a.DEPTH_ATTACHMENT,a.TEXTURE_2D,c.handler,0);e();g.data=null;c.data=null;a.bindFramebuffer(a.FRAMEBUFFER,null);a.viewport(b[0],b[1],b[2],b[3])};Texture.prototype.copyTo=function(g,c,e){var a=this.gl,b=a.getParameter(a.FRAMEBUFFER_BINDING),d=a.getViewport();c||(c=this.texture_type==a.TEXTURE_2D?q.Shader.getScreenShader():q.Shader.getCubemapCopyShader());a.disable(a.BLEND);a.disable(a.DEPTH_TEST);c&&e&&c.uniforms(e);
(e=a.__copy_fbo)||(e=a.__copy_fbo=a.createFramebuffer());a.bindFramebuffer(a.FRAMEBUFFER,e);a.viewport(0,0,g.width,g.height);if(this.texture_type==a.TEXTURE_2D)a.framebufferTexture2D(a.FRAMEBUFFER,a.COLOR_ATTACHMENT0,a.TEXTURE_2D,g.handler,0),this.toViewport(c);else if(this.texture_type==a.TEXTURE_CUBE_MAP){c.uniforms({u_texture:0});e=q.temp_mat3;for(var f=0;6>f;f++){a.framebufferTexture2D(a.FRAMEBUFFER,a.COLOR_ATTACHMENT0,a.TEXTURE_CUBE_MAP_POSITIVE_X+f,g.handler,0);var k=q.Texture.cubemap_camera_parameters[f];
mat3.identity(e);e.set(k.right,0);e.set(k.up,3);e.set(k.dir,6);this.toViewport(c,{u_rotation:e})}}a.setViewport(d);a.bindFramebuffer(a.FRAMEBUFFER,b);g.minFilter&&g.minFilter!=a.NEAREST&&g.minFilter!=a.LINEAR&&(g.bind(),a.generateMipmap(g.texture_type),g.has_mipmaps=!0);g.data=null;a.bindTexture(g.texture_type,null);return this};Texture.prototype.toViewport=function(g,c){g=g||Shader.getScreenShader();var e=Mesh.getScreenQuad();this.bind(0);c&&g.uniforms(c);g.draw(e,gl.TRIANGLES)};Texture.prototype.fill=
function(g){var c=gl.getParameter(gl.COLOR_CLEAR_VALUE);gl.clearColor(g[0],g[1],g[2],g[3]);this.drawTo(function(){gl.clear(gl.COLOR_BUFFER_BIT)});gl.clearColor(c[0],c[1],c[2],c[3])};Texture.prototype.renderQuad=function(){var g=mat3.create(),c=vec2.create(),e=vec2.create(),a=vec4.fromValues(1,1,1,1);return function(b,d,f,k,l,m){c[0]=b;c[1]=d;e[0]=f;e[1]=k;l=l||Shader.getQuadShader(this.gl);b=Mesh.getScreenQuad(this.gl);this.bind(0);l.uniforms({u_texture:0,u_position:c,u_color:a,u_size:e,u_viewport:gl.viewport_data.subarray(2,
4),u_transform:g});m&&l.uniforms(m);l.draw(b,gl.TRIANGLES)}}();Texture.prototype.applyBlur=function(g,c,e,a,b){var d=this.gl;void 0===g&&(g=1);void 0===c&&(c=1);g/=this.width;c/=this.height;d.disable(d.DEPTH_TEST);d.disable(d.BLEND);if(this===b&&this.texture_type===d.TEXTURE_CUBE_MAP)throw"cannot use applyBlur in a texture with itself when blurring a CUBE_MAP";if(b&&this.texture_type!==b.texture_type)throw"cannot use applyBlur with textures of different texture_type";var f=null,k=d.getParameter(d.FRAMEBUFFER_BINDING),
l=d.getViewport(),m=d.__copy_fbo;m||(m=d.__copy_fbo=d.createFramebuffer());d.bindFramebuffer(d.FRAMEBUFFER,m);d.viewport(0,0,this.width,this.height);if(this.texture_type===d.TEXTURE_2D)f=q.Shader.getBlurShader(),a||(a=new q.Texture(this.width,this.height,this.getProperties())),d.framebufferTexture2D(d.FRAMEBUFFER,d.COLOR_ATTACHMENT0,d.TEXTURE_2D,a.handler,0),this.toViewport(f,{u_texture:0,u_intensity:e,u_offset:[0,c]}),b=b||this,d.framebufferTexture2D(d.FRAMEBUFFER,d.COLOR_ATTACHMENT0,d.TEXTURE_2D,
b.handler,0),a.toViewport(f,{u_intensity:e,u_offset:[g,0]}),f=a;else if(this.texture_type===d.TEXTURE_CUBE_MAP){f=q.Shader.getCubemapBlurShader();f.uniforms({u_texture:0,u_intensity:e,u_offset:[g,c]});this.bind(0);g=Mesh.getScreenQuad();g.bindBuffers(f);f.bind();b||(b=new q.Texture(this.width,this.height,this.getProperties()));c=q.temp_mat3;for(e=0;6>e;++e)d.framebufferTexture2D(d.FRAMEBUFFER,d.COLOR_ATTACHMENT0,d.TEXTURE_CUBE_MAP_POSITIVE_X+e,b.handler,0),a=q.Texture.cubemap_camera_parameters[e],
mat3.identity(c),c.set(a.right,0),c.set(a.up,3),c.set(a.dir,6),f._setUniform("u_rotation",c),d.drawArrays(d.TRIANGLES,0,6);g.unbindBuffers(f);f=b}d.setViewport(l);d.bindFramebuffer(d.FRAMEBUFFER,k);b.data=null;b.minFilter&&b.minFilter!=d.NEAREST&&b.minFilter!=d.LINEAR&&(b.bind(),d.generateMipmap(b.texture_type),b.has_mipmaps=!0);d.bindTexture(b.texture_type,null);return f};Texture.fromURL=function(g,c,e,a){a=a||z.gl;c=c||{};c=Object.create(c);var b=c.texture||new q.Texture(1,1,c,a);64>g.length&&(b.url=
g);b.bind();var d=c.temp_color||Texture.loading_color;a.pixelStorei(a.UNPACK_ALIGNMENT,4);d=c.type==a.FLOAT?new Float32Array(d):new Uint8Array(d);a.texImage2D(a.TEXTURE_2D,0,b.format,b.width,b.height,0,b.format,b.type,d);a.bindTexture(b.texture_type,null);b.ready=!1;if(-1!=g.toLowerCase().indexOf(".dds")){d=a.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc")||a.getExtension("WEBGL_compressed_texture_s3tc");var f=new q.Texture(0,0,c,a);S.loadDDSTextureEx(a,d,g,f.handler,!0,function(k){b.texture_type=
k.texture_type;b.handler=k;delete b.ready;e&&e(b,g)})}else a=new Image,a.src=g,a.onload=function(){c.texture=b;q.Texture.fromImage(this,c);delete b.ready;e&&e(b,g)},a.onerror=function(){e&&e(null)};return b};Texture.fromImage=function(g,c){c=c||{};var e=c.texture||new q.Texture(g.width,g.height,c);e.uploadImage(g,c);e.bind();gl.texParameteri(e.texture_type,gl.TEXTURE_MAG_FILTER,e.magFilter);gl.texParameteri(e.texture_type,gl.TEXTURE_MIN_FILTER,e.minFilter);gl.texParameteri(e.texture_type,gl.TEXTURE_WRAP_S,
e.wrapS);gl.texParameteri(e.texture_type,gl.TEXTURE_WRAP_T,e.wrapT);q.isPowerOfTwo(e.width)&&q.isPowerOfTwo(e.height)&&c.minFilter&&c.minFilter!=gl.NEAREST&&c.minFilter!=gl.LINEAR&&(e.bind(),gl.generateMipmap(e.texture_type),e.has_mipmaps=!0);gl.bindTexture(e.texture_type,null);e.data=g;c.keep_image&&(e.img=g);return e};Texture.fromVideo=function(g,c){c=c||{};var e=c.texture||new q.Texture(g.videoWidth,g.videoHeight,c);e.bind();e.uploadImage(g,c);c.minFilter&&c.minFilter!=gl.NEAREST&&c.minFilter!=
gl.LINEAR&&(e.bind(),gl.generateMipmap(e.texture_type),e.has_mipmaps=!0,e.data=g);gl.bindTexture(e.texture_type,null);return e};Texture.fromTexture=function(g,c){c=c||{};c=new q.Texture(g.width,g.height,c);g.copyTo(c);return c};Texture.prototype.clone=function(g){var c=this.getProperties();if(g)for(var e in g)c[e]=g[e];return Texture.fromTexture(this,c)};Texture.fromMemory=function(g,c,e,a){a=a||{};var b=a.texture||new q.Texture(g,c,a);Texture.setUploadOptions(a);b.bind();try{gl.texImage2D(gl.TEXTURE_2D,
0,b.format,g,c,0,b.format,b.type,e),b.data=e}catch(d){if("file:"==location.protocol)throw'image not loaded for security reasons (serve this page over "http://" instead)';throw"image not loaded for security reasons (image must originate from the same domain as this page or use Cross-Origin Resource Sharing)";}a.minFilter&&a.minFilter!=gl.NEAREST&&a.minFilter!=gl.LINEAR&&(gl.generateMipmap(gl.TEXTURE_2D),b.has_mipmaps=!0);gl.bindTexture(b.texture_type,null);return b};Texture.fromDDSInMemory=function(g,
c){c=c||{};var e=c.texture||new q.Texture(0,0,c);q.Texture.setUploadOptions(c);e.bind();c=gl.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc")||gl.getExtension("WEBGL_compressed_texture_s3tc");S.loadDDSTextureFromMemoryEx(gl,c,g,e,!0);gl.bindTexture(e.texture_type,null);return e};Texture.fromShader=function(g,c,e,a){a=a||{};g=new q.Texture(g,c,a);g.drawTo(function(){gl.disable(gl.BLEND);gl.disable(gl.DEPTH_TEST);gl.disable(gl.CULL_FACE);var b=Mesh.getScreenQuad();e.draw(b)});return g};Texture.cubemapFromImages=
function(g,c){c=c||{};if(6!=g.length)throw"missing images to create cubemap";var e=g[0].width,a=g[0].height;c.texture_type=gl.TEXTURE_CUBE_MAP;var b=null;c.texture?(b=c.texture,b.width=e,b.height=a):b=new q.Texture(e,a,c);Texture.setUploadOptions(c);b.bind();try{for(e=0;6>e;e++)gl.texImage2D(gl.TEXTURE_CUBE_MAP_POSITIVE_X+e,0,b.format,b.format,b.type,g[e]);b.data=g}catch(d){if("file:"==location.protocol)throw'image not loaded for security reasons (serve this page over "http://" instead)';throw"image not loaded for security reasons (image must originate from the same domain as this page or use Cross-Origin Resource Sharing)";
}c.minFilter&&c.minFilter!=gl.NEAREST&&c.minFilter!=gl.LINEAR&&(gl.generateMipmap(gl.TEXTURE_CUBE_MAP),b.has_mipmaps=!0);b.unbind();return b};Texture.cubemapFromImage=function(g,c){c=c||{};if(g.width!=g.height/6&&0!=g.height%6&&!c.faces)return console.error("Cubemap image not valid, only 1x6 (vertical) or 6x3 (cross) formats. Check size:",g.width,g.height),null;var e=g.width,a=g.height;void 0!==c.is_cross?(c.faces=Texture.generateCubemapCrossFacesInfo(g.width,c.is_cross),e=a=g.width/4):c.faces?(e=
c.width||c.faces[0].width,a=c.height||c.faces[0].height):a/=6;if(e!=a)return console.log("Texture not valid, width and height for every face must be square"),null;var b=e;c.no_flip=!0;for(var d=[],f=0;6>f;f++){var k=createCanvas(b,b),l=k.getContext("2d");c.faces?l.drawImage(g,c.faces[f].x,c.faces[f].y,c.faces[f].width||b,c.faces[f].height||b,0,0,b,b):l.drawImage(g,0,a*f,e,a,0,0,b,b);d.push(k)}e=Texture.cubemapFromImages(d,c);c.keep_image&&(e.img=g);return e};Texture.generateCubemapCrossFacesInfo=
function(g,c){void 0===c&&(c=1);g/=4;return[{x:2*g,y:g,width:g,height:g},{x:0,y:g,width:g,height:g},{x:c*g,y:0,width:g,height:g},{x:c*g,y:2*g,width:g,height:g},{x:g,y:g,width:g,height:g},{x:3*g,y:g,width:g,height:g}]};Texture.cubemapFromURL=function(g,c,e){c=c||{};c.texture_type=gl.TEXTURE_CUBE_MAP;var a=c.texture||new q.Texture(1,1,c);c=Object.create(c);a.bind();Texture.setUploadOptions(c);var b=c.temp_color||[0,0,0,255];b=c.type==gl.FLOAT?new Float32Array(b):new Uint8Array(b);for(var d=0;6>d;d++)gl.texImage2D(gl.TEXTURE_CUBE_MAP_POSITIVE_X+
d,0,a.format,1,1,0,a.format,a.type,b);gl.bindTexture(a.texture_type,null);a.ready=!1;b=new Image;b.src=g;b.onload=function(){c.texture=a;(a=q.Texture.cubemapFromImage(this,c))&&delete a.ready;e&&e(a)};return a};Texture.prototype.getPixels=function(g,c,e){c=this.gl;var a=c.getViewport(),b=c.getParameter(c.FRAMEBUFFER_BINDING);g=g||this.type;if(this.format==c.DEPTH_COMPONENT)throw"cannot use getPixels in depth textures";c.disable(c.DEPTH_TEST);var d=c.__copy_fbo;d||(d=c.__copy_fbo=c.createFramebuffer());
c.bindFramebuffer(c.FRAMEBUFFER,d);c.viewport(0,0,this.width,this.height);this.texture_type==c.TEXTURE_2D?c.framebufferTexture2D(c.FRAMEBUFFER,c.COLOR_ATTACHMENT0,c.TEXTURE_2D,this.handler,0):this.texture_type==c.TEXTURE_CUBE_MAP&&c.framebufferTexture2D(c.FRAMEBUFFER,c.COLOR_ATTACHMENT0,c.TEXTURE_CUBE_MAP_POSITIVE_X+(e||0),this.handler,0);e=4;d=g==c.UNSIGNED_BYTE?new Uint8Array(this.width*this.height*e):new Float32Array(this.width*this.height*e);c.readPixels(0,0,this.width,this.height,3==e?c.RGB:
c.RGBA,g,d);c.bindFramebuffer(c.FRAMEBUFFER,b);c.viewport(a[0],a[1],a[2],a[3]);return d};Texture.prototype.toCanvas=function(g,c,e){e=e||8192;var a=this.gl,b=Math.min(this.width,e),d=Math.min(this.height,e);this.texture_type==a.TEXTURE_CUBE_MAP&&(b*=4,d*=3);g=g||createCanvas(b,d);g.width!=b&&(g.width=b);g.height!=d&&(g.height=d);var f=null;if(this.texture_type==a.TEXTURE_2D){this.width!=b||this.height!=d?(f=new q.Texture(b,d,{format:a.RGBA,filter:a.NEAREST}),this.copyTo(f),f=f.getPixels(a.UNSIGNED_BYTE,
!0)):f=this.getPixels(a.UNSIGNED_BYTE,!0);e=g.getContext("2d");var k=e.getImageData(0,0,b,d);k.data.set(f);e.putImageData(k,0,0);c&&(f=createCanvas(b,d),c=f.getContext("2d"),c.translate(0,f.height),c.scale(1,-1),c.drawImage(g,0,0,f.width,f.height),e.drawImage(f,0,0))}else if(this.texture_type==a.TEXTURE_CUBE_MAP){b=createCanvas(this.width,this.height);c=b.getContext("2d");d=q.Texture.generateCubemapCrossFacesInfo(g.width,1);e=g.getContext("2d");e.fillStyle="black";e.fillRect(0,0,g.width,g.height);
for(var l=0;6>l;l++)f=this.getPixels(a.UNSIGNED_BYTE,!0,l),k=c.getImageData(0,0,b.width,b.height),k.data.set(f),c.putImageData(k,0,0),e.drawImage(b,d[l].x,d[l].y,b.width,b.height)}return g};Texture.prototype.toBlob=function(g,c){g=this.toCanvas(null,g).toDataURL(c);var e=g.indexOf(",");g=g.substr(e+1);g=atob(g);e=g.length;for(var a=new Uint8Array(e),b=0;b<e;++b)a[b]=g.charCodeAt(b);return new Blob([a],{type:c||"image/png"})};Texture.prototype.toBlobAsync=function(g,c,e){var a=this.toCanvas(null,g);
a.toBlob?a.toBlob(e,c):(g=this.toBlob(g,c),e&&e(g))};Texture.prototype.toBase64=function(g){var c=this.width,e=this.height,a=this.getPixels(),b=createCanvas(c,e),d=b.getContext("2d"),f=d.getImageData(0,0,c,e);f.data.set(a);d.putImageData(f,0,0);g&&(g=createCanvas(c,e),c=g.getContext("2d"),c.translate(0,e),c.scale(1,-1),c.drawImage(b,0,0),b=g);return b.toDataURL("image/png")};Texture.prototype.generateMetadata=function(){var g={};g.width=this.width;g.height=this.height;this.metadata=g};Texture.compareFormats=
function(g,c){return g&&c?g==c?!0:g.width!=c.width||g.height!=c.height||g.type!=c.type||g.format!=c.format||g.texture_type!=c.texture_type?!1:!0:!1};Texture.blend=function(g,c,e,a){if(!g||!c)return!1;if(g==c)return a?g.copyTo(a):g.toViewport(),!0;gl.disable(gl.BLEND);gl.disable(gl.DEPTH_TEST);gl.disable(gl.CULL_FACE);var b=q.Shader.getBlendShader(),d=q.Mesh.getScreenQuad();c.bind(1);b.uniforms({u_texture:0,u_texture2:1,u_factor:e});if(a)return a.drawTo(function(){if(g==a||c==a)throw"Blend output cannot be the same as the input";
g.bind(0);b.draw(d,gl.TRIANGLES)}),!0;g.bind(0);b.draw(d,gl.TRIANGLES);return!0};Texture.getWhiteTexture=function(g){g=g||z.gl;var c=g.textures[":white"];if(c)return c;c=new Uint8Array([255,255,255,255]);return g.textures[":white"]=new q.Texture(1,1,{pixel_data:c})};Texture.getBlackTexture=function(g){g=g||z.gl;var c=g.textures[":black"];if(c)return c;c=new Uint8Array([0,0,0,255]);return g.textures[":black"]=new q.Texture(1,1,{pixel_data:c})};Texture.getTemporary=function(g,c,e){Texture.temporary_pool||
(Texture.temporary_pool=[]);var a=Texture.temporary_pool,b=q.TEXTURE_2D,d=Texture.DEFAULT_TYPE,f=Texture.DEFAULT_FORMAT;e&&(e.texture_type&&(b=e.texture_type),e.type&&(d=e.type),e.format&&(f=e.format));for(e=0;e<a.length;++e){var k=a[e];if(k.width==g&&k.height==c&&k.type==d&&k.texture_type==b&&k.format==f)return a.splice(e,1),k}return new q.Texture(g,c,{type:d,texture_type:b,format:f})};Texture.releaseTemporary=function(g){Texture.temporary_pool||(Texture.temporary_pool=[]);Texture.temporary_pool.push(g)};
Texture.nextPOT=function(g){return Math.pow(2,Math.ceil(Math.log(g)/Math.log(2)))};q.FBO=M;M.prototype.setTextures=function(g,c,e){if(c&&(c.format!==gl.DEPTH_COMPONENT||c.type!=gl.UNSIGNED_INT))throw"FBO Depth texture must be of format: gl.DEPTH_COMPONENT and type: gl.UNSIGNED_INT";var a=this.depth_texture==c;if(a&&g)if(g.length==this.color_textures.length)for(var b=0;b<g.length;++b){if(g[b]!=this.color_textures[b]){a=!1;break}}else a=!1;this._stencil_enabled!==this.stencil&&(a=!1);if(!a){this.color_textures.length=
g?g.length:0;if(g)for(b=0;b<g.length;++b)this.color_textures[b]=g[b];this.depth_texture=c;this.update(e)}};M.prototype.update=function(g){this._old_fbo=gl.getParameter(gl.FRAMEBUFFER_BINDING);this.handler||(this.handler=gl.createFramebuffer());var c=-1,e=-1,a=null,b=this.color_textures,d=this.depth_texture;if(b&&b.length)for(var f=0;f<b.length;f++){var k=b[f];if(-1==c)c=k.width;else if(c!=k.width)throw"Cannot bind textures with different dimensions";if(-1==e)e=k.height;else if(e!=k.height)throw"Cannot bind textures with different dimensions";
if(null==a)a=k.type;else if(a!=k.type)throw"Cannot bind textures to a FBO with different pixel formats";if(k.texture_type!=gl.TEXTURE_2D)throw"Cannot bind a Cubemap to a FBO";}else c=d.width,e=d.height;this.width=c;this.height=e;gl.bindFramebuffer(gl.FRAMEBUFFER,this.handler);if(d&&!gl.extensions.WEBGL_depth_texture)throw"Rendering to depth texture not supported by your browser";a=gl.extensions.WEBGL_draw_buffers;if(!a&&b&&1<b.length)throw"Rendering to several textures not supported by your browser";
d?gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.DEPTH_ATTACHMENT,gl.TEXTURE_2D,d.handler,0):(f=this._renderbuffer=this._renderbuffer||gl.createRenderbuffer(),f.width=c,f.height=e,gl.bindRenderbuffer(gl.RENDERBUFFER,f),gl.renderbufferStorage(gl.RENDERBUFFER,gl.DEPTH_COMPONENT16,c,e),gl.framebufferRenderbuffer(gl.FRAMEBUFFER,gl.DEPTH_ATTACHMENT,gl.RENDERBUFFER,f));if(b&&b.length)for(this.order=[],f=0;f<b.length;f++)k=b[f],gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0+f,gl.TEXTURE_2D,k.handler,
0),this.order.push(gl.COLOR_ATTACHMENT0+f);else f=this._renderbuffer=this._renderbuffer||gl.createRenderbuffer(),f.width=c,f.height=e,gl.bindRenderbuffer(gl.RENDERBUFFER,f),gl.renderbufferStorage(gl.RENDERBUFFER,gl.RGBA4,c,e),gl.framebufferRenderbuffer(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0,gl.RENDERBUFFER,f);for(f=d=b?b.length:0;f<this._num_binded_textures;++f)gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0+f,gl.TEXTURE_2D,null,0);this._num_binded_textures=d;this.stencil?(f=this._stencil_buffer=
this._stencil_buffer||gl.createRenderbuffer(),gl.bindRenderbuffer(gl.RENDERBUFFER,f),gl.renderbufferStorage(gl.RENDERBUFFER,gl.STENCIL_INDEX8,c,e),gl.framebufferRenderbuffer(gl.FRAMEBUFFER,gl.STENCIL_ATTACHMENT,gl.RENDERBUFFER,f),this._stencil_enabled=!0):this._stencil_enabled=!1;b&&1<b.length&&a.drawBuffersWEBGL(this.order);c=gl.checkFramebufferStatus(gl.FRAMEBUFFER);if(c!==gl.FRAMEBUFFER_COMPLETE)throw"FBO not complete: "+c;gl.bindTexture(gl.TEXTURE_2D,null);gl.bindRenderbuffer(gl.RENDERBUFFER,
null);g||gl.bindFramebuffer(gl.FRAMEBUFFER,this._old_fbo)};M.prototype.bind=function(g){if(!this.color_textures.length&&!this.depth_texture)throw"FBO: no textures attached to FBO";this._old_viewport.set(gl.viewport_data);this._old_fbo=g?gl.getParameter(gl.FRAMEBUFFER_BINDING):null;this._old_fbo!=this.handler&&gl.bindFramebuffer(gl.FRAMEBUFFER,this.handler);gl.viewport(0,0,this.width,this.height)};M.prototype.unbind=function(){gl.bindFramebuffer(gl.FRAMEBUFFER,this._old_fbo);this._old_fbo=null;gl.setViewport(this._old_viewport)};
z.Shader=q.Shader=function b(c,e,a){q.debug&&console.log("GL.Shader created");this._context_id=z.gl.context_id;var d=this.gl=z.gl;a=b.expandMacros(a);this.program=d.createProgram();c=c.constructor===String?q.Shader.compileSource(d.VERTEX_SHADER,a+c):c;e=e.constructor===String?q.Shader.compileSource(d.FRAGMENT_SHADER,a+e):e;d.attachShader(this.program,c,d);d.attachShader(this.program,e,d);d.linkProgram(this.program);if(!d.getProgramParameter(this.program,d.LINK_STATUS))throw"link error: "+d.getProgramInfoLog(this.program);
this.vs_shader=c;this.fs_shader=e;this.attributes={};this.uniformInfo={};this.samplers={};this.extractShaderInfo()};Shader.expandMacros=function(c){var e="";if(c)for(var a in c)e+="#define "+a+" "+(c[a]?c[a]:"")+"\n";return e};Shader.compileSource=function(c,e,a,b){a=a||z.gl;b=b||a.createShader(c);a.shaderSource(b,e);a.compileShader(b);if(!a.getShaderParameter(b,a.COMPILE_STATUS))throw(c==a.VERTEX_SHADER?"Vertex":"Fragment")+" shader compile error: "+a.getShaderInfoLog(b);return b};Shader.prototype.updateShader=
function(c,e,a){var b=this.gl||z.gl;a=Shader.expandMacros(a);this.program&&(this.program=b.createProgram());c=c.constructor===String?q.Shader.compileSource(b.VERTEX_SHADER,a+c,b,this.vs_shader):c;e=e.constructor===String?q.Shader.compileSource(b.FRAGMENT_SHADER,a+e,b,this.fs_shader):e;b.attachShader(this.program,c,b);b.attachShader(this.program,e,b);b.linkProgram(this.program);if(!b.getProgramParameter(this.program,b.LINK_STATUS))throw"link error: "+b.getProgramInfoLog(this.program);this.vs_shader=
c;this.fs_shader=e;this.attributes={};this.uniformInfo={};this.samplers={};this.extractShaderInfo()};Shader.prototype.extractShaderInfo=function(){for(var c=this.gl,e=c.getProgramParameter(this.program,c.ACTIVE_UNIFORMS),a=0;a<e;++a){var b=c.getActiveUniform(this.program,a);if(!b)break;var d=b.name,f=d.indexOf("[");-1!=f&&-1==d.indexOf("].")&&(d=d.substr(0,f));if(b.type==c.SAMPLER_2D||b.type==c.SAMPLER_CUBE)this.samplers[d]=b.type;f=Shader.getUniformFunc(b);var k=!1;if(b.type==c.FLOAT_MAT2||b.type==
c.FLOAT_MAT3||b.type==c.FLOAT_MAT4)k=!0;this.uniformInfo[d]={type:b.type,func:f,size:b.size,is_matrix:k,loc:c.getUniformLocation(this.program,d)}}a=0;for(e=c.getProgramParameter(this.program,c.ACTIVE_ATTRIBUTES);a<e;++a){b=c.getActiveAttrib(this.program,a);if(!b)break;f=Shader.getUniformFunc(b);this.uniformInfo[b.name]={type:b.type,func:f,size:b.size,loc:null};this.attributes[b.name]=c.getAttribLocation(this.program,b.name)}};Shader.prototype.hasUniform=function(c){return this.uniformInfo[c]};Shader.prototype.hasAttribute=
function(c){return this.attributes[c]};Shader.getUniformFunc=function(c){switch(c.type){case gl.FLOAT:c=1==c.size?gl.uniform1f:gl.uniform1fv;break;case gl.FLOAT_MAT2:c=gl.uniformMatrix2fv;break;case gl.FLOAT_MAT3:c=gl.uniformMatrix3fv;break;case gl.FLOAT_MAT4:c=gl.uniformMatrix4fv;break;case gl.FLOAT_VEC2:c=gl.uniform2fv;break;case gl.FLOAT_VEC3:c=gl.uniform3fv;break;case gl.FLOAT_VEC4:c=gl.uniform4fv;break;case gl.UNSIGNED_INT:case gl.INT:c=1==c.size?gl.uniform1i:gl.uniform1iv;break;case gl.INT_VEC2:c=
gl.uniform2iv;break;case gl.INT_VEC3:c=gl.uniform3iv;break;case gl.INT_VEC4:c=gl.uniform4iv;break;case gl.SAMPLER_2D:case gl.SAMPLER_CUBE:c=gl.uniform1i;break;default:c=gl.uniform1f}return c};Shader.fromURL=function(c,e,a){function b(){var l=new q.Shader(f,k),m;for(m in l)d[m]=l[m];d.ready=!0}var d=new q.Shader("\n\t\t\tprecision highp float;\n\t\t\tattribute vec3 a_vertex;\n\t\t\tattribute mat4 u_mvp;\n\t\t\tvoid main() { \n\t\t\t\tgl_Position = u_mvp * vec4(a_vertex,1.0); \n\t\t\t}\n\t\t","\n\t\t\tprecision highp float;\n\t\t\tvoid main() {\n\t\t\t\tgl_FragColor = vec4(0.0, 0.0, 0.0, 1.0);\n\t\t\t}\n\t\t\t");
d.ready=!1;var f=null,k=null;HttpRequest(c,null,function(l){f=l;k&&b()});HttpRequest(e,null,function(l){k=l;f&&b()});return d};Shader.prototype.bind=function(){var c=this.gl;c.useProgram(this.program);c._current_shader=this};Shader.prototype.getLocation=function(c){return this.uniformInfo[c]?this.uniformInfo[c].loc:null};Shader._temp_uniform=new Float32Array(16);Shader.prototype.uniforms=function(c){var e=this.gl;e.useProgram(this.program);e._current_shader=this;for(var a in c)this.uniformInfo[a]&&
this._setUniform(a,c[a]);return this};Shader.prototype.uniformsArray=function(c){var e=this.gl;e.useProgram(this.program);e._current_shader=this;e=0;for(var a=c.length;e<a;++e){var b=c[e],d;for(d in b)this._setUniform(d,b[d])}return this};Shader.prototype.setUniform=function(c,e){this.gl._current_shader!=this&&this.bind();(c=this.uniformInfo[c])&&null!==c.loc&&null!=e&&(e.constructor===Array&&(e=new Float32Array(e)),c.is_matrix?c.func.call(this.gl,c.loc,!1,e):c.func.call(this.gl,c.loc,e))};Shader.prototype._setUniform=
function(c,e){(c=this.uniformInfo[c])&&null!==c.loc&&null!=e&&(e.constructor===Array&&(e=new Float32Array(e)),c.is_matrix?c.func.call(this.gl,c.loc,!1,e):c.func.call(this.gl,c.loc,e))};Shader.prototype.draw=function(c,e,a){a=void 0===a?e==gl.LINES?"lines":"triangles":a;this.drawBuffers(c.vertexBuffers,a?c.indexBuffers[a]:null,2>arguments.length?gl.TRIANGLES:e)};Shader.prototype.drawRange=function(c,e,a,b,d){d=void 0===d?e==gl.LINES?"lines":"triangles":d;this.drawBuffers(c.vertexBuffers,d?c.indexBuffers[d]:
null,e,a,b)};var V=new Uint8Array(16),Y=new Uint8Array(16);Shader.prototype.drawBuffers=function(c,e,a,b,d){if(0!=d){var f=this.gl;f.useProgram(this.program);var k=0;V.set(Y);for(var l in c){var m=c[l],r=m.attribute||l,n=this.attributes[r];null!=n&&m.buffer&&(V[n]=1,f.bindBuffer(f.ARRAY_BUFFER,m.buffer),f.enableVertexAttribArray(n),f.vertexAttribPointer(n,m.buffer.spacing,m.buffer.gl_type,!1,0,0),k=m.buffer.length/m.buffer.spacing)}c=0;0<b&&(c=b*(e&&e.data?e.data.constructor.BYTES_PER_ELEMENT:1));
0<d?k=d:e&&(k=e.buffer.length-c);for(r in this.attributes)n=this.attributes[r],V[n]||f.disableVertexAttribArray(this.attributes[r]);!k||e&&!e.buffer||(e?(f.bindBuffer(f.ELEMENT_ARRAY_BUFFER,e.buffer),f.drawElements(a,k,e.buffer.gl_type,c),f.bindBuffer(f.ELEMENT_ARRAY_BUFFER,null)):f.drawArrays(a,c,k));return this}};Shader.expandImports=function(c,e){e=e||Shader.files;var a={};if(!e)throw"Shader.files not initialized, assign files there";return c.replace(/#import\s+"([a-zA-Z0-9_\.]+)"\s*\n/g,function(b){b=
b.split('"')[1];if(a[b])return"//already imported: "+b+"\n";var d=e[b];a[b]=!0;return d?d+"\n":"//import code not found: "+b+"\n"})};Shader.dumpErrorToConsole=function(c,e,a){console.error(c);c=(-1!=c.indexOf("Fragment")?a:e).split("\n");for(var b in c)c[b]=b+"| "+c[b];console.groupCollapsed("Shader code");console.log(c.join("\n"));console.groupEnd()};Shader.validateValue=function(c,e){if(null===c||void 0===c)return!1;switch(e.type){case q.INT:case q.FLOAT:case q.SAMPLER_2D:case q.SAMPLER_CUBE:return isNumber(c);
case q.INT_VEC2:case q.FLOAT_VEC2:return 2===c.length;case q.INT_VEC3:case q.FLOAT_VEC3:return 3===c.length;case q.INT_VEC4:case q.FLOAT_VEC4:case q.FLOAT_MAT2:return 4===c.length;case q.FLOAT_MAT3:return 8===c.length;case q.FLOAT_MAT4:return 16===c.length}return!0};Shader.SCREEN_VERTEX_SHADER="\n\t\t\tprecision highp float;\n\t\t\tattribute vec3 a_vertex;\n\t\t\tattribute vec2 a_coord;\n\t\t\tvarying vec2 v_coord;\n\t\t\tvoid main() { \n\t\t\t\tv_coord = a_coord; \n\t\t\t\tgl_Position = vec4(a_coord * 2.0 - 1.0, 0.0, 1.0); \n\t\t\t}\n\t\t\t";
Shader.SCREEN_FRAGMENT_SHADER="\n\t\t\tprecision highp float;\n\t\t\tuniform sampler2D u_texture;\n\t\t\tvarying vec2 v_coord;\n\t\t\tvoid main() {\n\t\t\t\tgl_FragColor = texture2D(u_texture, v_coord);\n\t\t\t}\n\t\t\t";Shader.SCREEN_FRAGMENT_FX="\n\t\t\tprecision highp float;\n\t\t\tuniform sampler2D u_texture;\n\t\t\tvarying vec2 v_coord;\n\t\t\t#ifdef FX_UNIFORMS\n\t\t\t\tFX_UNIFORMS\n\t\t\t#endif\n\t\t\tvoid main() {\n\t\t\t\tvec2 uv = v_coord;\n\t\t\t\tvec4 color = texture2D(u_texture, uv);\n\t\t\t\t#ifdef FX_CODE\n\t\t\t\t\tFX_CODE ;\n\t\t\t\t#endif\n\t\t\t\tgl_FragColor = color;\n\t\t\t}\n\t\t\t";
Shader.SCREEN_COLORED_FRAGMENT_SHADER="\n\t\t\tprecision highp float;\n\t\t\tuniform sampler2D u_texture;\n\t\t\tuniform vec4 u_color;\n\t\t\tvarying vec2 v_coord;\n\t\t\tvoid main() {\n\t\t\t\tgl_FragColor = u_color * texture2D(u_texture, v_coord);\n\t\t\t}\n\t\t\t";Shader.BLEND_FRAGMENT_SHADER="\n\t\t\tprecision highp float;\n\t\t\tuniform sampler2D u_texture;\n\t\t\tuniform sampler2D u_texture2;\n\t\t\tuniform float u_factor;\n\t\t\tvarying vec2 v_coord;\n\t\t\tvoid main() {\n\t\t\t\tgl_FragColor = mix( texture2D(u_texture, v_coord), texture2D(u_texture2, v_coord), u_factor);\n\t\t\t}\n\t\t\t";
Shader.SCREEN_FLAT_FRAGMENT_SHADER="\n\t\t\tprecision highp float;\n\t\t\tuniform vec4 u_color;\n\t\t\tvoid main() {\n\t\t\t\tgl_FragColor = u_color;\n\t\t\t}\n\t\t\t";Shader.QUAD_VERTEX_SHADER="\n\t\t\tprecision highp float;\n\t\t\tattribute vec3 a_vertex;\n\t\t\tattribute vec2 a_coord;\n\t\t\tvarying vec2 v_coord;\n\t\t\tuniform vec2 u_position;\n\t\t\tuniform vec2 u_size;\n\t\t\tuniform vec2 u_viewport;\n\t\t\tuniform mat3 u_transform;\n\t\t\tvoid main() { \n\t\t\t\tvec3 pos = vec3(u_position + vec2(a_coord.x,1.0 - a_coord.y)  * u_size, 1.0);\n\t\t\t\tv_coord = a_coord; \n\t\t\t\tpos = u_transform * pos;\n\t\t\t\tpos.z = 0.0;\n\t\t\t\t//normalize\n\t\t\t\tpos.x = (2.0 * pos.x / u_viewport.x) - 1.0;\n\t\t\t\tpos.y = -((2.0 * pos.y / u_viewport.y) - 1.0);\n\t\t\t\tgl_Position = vec4(pos, 1.0); \n\t\t\t}\n\t\t\t";
Shader.QUAD_FRAGMENT_SHADER="\n\t\t\tprecision highp float;\n\t\t\tuniform sampler2D u_texture;\n\t\t\tuniform vec4 u_color;\n\t\t\tvarying vec2 v_coord;\n\t\t\tvoid main() {\n\t\t\t\tgl_FragColor = u_color * texture2D(u_texture, v_coord);\n\t\t\t}\n\t\t\t";Shader.QUAD2_FRAGMENT_SHADER="\n\t\t\tprecision highp float;\n\t\t\tuniform sampler2D u_texture;\n\t\t\tuniform vec4 u_color;\n\t\t\tuniform vec4 u_texture_area;\n\t\t\tvarying vec2 v_coord;\n\t\t\tvoid main() {\n\t\t\t    vec2 uv = vec2( mix(u_texture_area.x, u_texture_area.z, v_coord.x), 1.0 - mix(u_texture_area.w, u_texture_area.y, v_coord.y) );\n\t\t\t\tgl_FragColor = u_color * texture2D(u_texture, uv);\n\t\t\t}\n\t\t\t";
Shader.PRIMITIVE2D_VERTEX_SHADER="\n\t\t\tprecision highp float;\n\t\t\tattribute vec3 a_vertex;\n\t\t\tuniform vec2 u_viewport;\n\t\t\tuniform mat3 u_transform;\n\t\t\tvoid main() { \n\t\t\t\tvec3 pos = a_vertex;\n\t\t\t\tpos = u_transform * pos;\n\t\t\t\tpos.z = 0.0;\n\t\t\t\t//normalize\n\t\t\t\tpos.x = (2.0 * pos.x / u_viewport.x) - 1.0;\n\t\t\t\tpos.y = -((2.0 * pos.y / u_viewport.y) - 1.0);\n\t\t\t\tgl_Position = vec4(pos, 1.0); \n\t\t\t}\n\t\t\t";Shader.FLAT_VERTEX_SHADER="\n\t\t\tprecision highp float;\n\t\t\tattribute vec3 a_vertex;\n\t\t\tuniform mat4 u_mvp;\n\t\t\tvoid main() { \n\t\t\t\tgl_Position = u_mvp * vec4(a_vertex,1.0); \n\t\t\t}\n\t\t\t";
Shader.FLAT_FRAGMENT_SHADER="\n\t\t\tprecision highp float;\n\t\t\tuniform vec4 u_color;\n\t\t\tvoid main() {\n\t\t\t\tgl_FragColor = u_color;\n\t\t\t}\n\t\t\t";Shader.createFX=function(c,e,a){c={FX_CODE:c,FX_UNIFORMS:e||""};if(!a)return new q.Shader(q.Shader.SCREEN_VERTEX_SHADER,q.Shader.SCREEN_FRAGMENT_FX,c);a.updateShader(q.Shader.SCREEN_VERTEX_SHADER,q.Shader.SCREEN_FRAGMENT_FX,c);return a};Shader.prototype.toViewport=function(c){var e=q.Mesh.getScreenQuad();c&&this.uniforms(c);this.draw(e)};
Shader.getScreenShader=function(c){c=c||z.gl;var e=c.shaders[":screen"];if(e)return e;e=c.shaders[":screen"]=new q.Shader(Shader.SCREEN_VERTEX_SHADER,Shader.SCREEN_FRAGMENT_SHADER);return e.uniforms({u_texture:0})};Shader.getColoredScreenShader=function(c){c=c||z.gl;var e=c.shaders[":colored_screen"];if(e)return e;e=c.shaders[":colored_screen"]=new q.Shader(Shader.SCREEN_VERTEX_SHADER,Shader.SCREEN_COLORED_FRAGMENT_SHADER);return e.uniforms({u_texture:0,u_color:vec4.fromValues(1,1,1,1)})};Shader.getQuadShader=
function(c){c=c||z.gl;var e=c.shaders[":quad"];return e?e:c.shaders[":quad"]=new q.Shader(Shader.QUAD_VERTEX_SHADER,Shader.QUAD_FRAGMENT_SHADER)};Shader.getPartialQuadShader=function(c){c=c||z.gl;var e=c.shaders[":quad2"];return e?e:c.shaders[":quad2"]=new q.Shader(Shader.QUAD_VERTEX_SHADER,Shader.QUAD2_FRAGMENT_SHADER)};Shader.getBlendShader=function(c){c=c||z.gl;var e=c.shaders[":blend"];return e?e:c.shaders[":blend"]=new q.Shader(Shader.SCREEN_VERTEX_SHADER,Shader.BLEND_FRAGMENT_SHADER)};Shader.getBlurShader=
function(c){c=c||z.gl;var e=c.shaders[":blur"];if(e)return e;e=new q.Shader(Shader.SCREEN_VERTEX_SHADER,"\n\t\t\tprecision highp float;\n\t\t\tvarying vec2 v_coord;\n\t\t\tuniform sampler2D u_texture;\n\t\t\tuniform vec2 u_offset;\n\t\t\tuniform float u_intensity;\n\t\t\tvoid main() {\n\t\t\t   vec4 sum = vec4(0.0);\n\t\t\t   sum += texture2D(u_texture, v_coord + u_offset * -4.0) * 0.05/0.98;\n\t\t\t   sum += texture2D(u_texture, v_coord + u_offset * -3.0) * 0.09/0.98;\n\t\t\t   sum += texture2D(u_texture, v_coord + u_offset * -2.0) * 0.12/0.98;\n\t\t\t   sum += texture2D(u_texture, v_coord + u_offset * -1.0) * 0.15/0.98;\n\t\t\t   sum += texture2D(u_texture, v_coord) * 0.16/0.98;\n\t\t\t   sum += texture2D(u_texture, v_coord + u_offset * 4.0) * 0.05/0.98;\n\t\t\t   sum += texture2D(u_texture, v_coord + u_offset * 3.0) * 0.09/0.98;\n\t\t\t   sum += texture2D(u_texture, v_coord + u_offset * 2.0) * 0.12/0.98;\n\t\t\t   sum += texture2D(u_texture, v_coord + u_offset * 1.0) * 0.15/0.98;\n\t\t\t   gl_FragColor = u_intensity * sum;\n\t\t\t}\n\t\t\t");
return c.shaders[":blur"]=e};Shader.getCubemapCopyShader=function(c){c=c||z.gl;var e=c.shaders[":copy_cubemap"];if(e)return e;e=new q.Shader(Shader.SCREEN_VERTEX_SHADER,"\n\t\t\tprecision highp float;\n\t\t\tvarying vec2 v_coord;\n\t\t\tuniform samplerCube u_texture;\n\t\t\tuniform mat3 u_rotation;\n\t\t\tvoid main() {\n\t\t\t\tvec2 uv = vec2( v_coord.x, 1.0 - v_coord.y );\n\t\t\t\tvec3 dir = vec3( uv - vec2(0.5), 0.5 );\n\t\t\t\tdir = u_rotation * dir;\n\t\t\t   gl_FragColor = textureCube( u_texture, dir );\n\t\t\t}\n\t\t\t");
return c.shaders[":copy_cubemap"]=e};Shader.getCubemapBlurShader=function(c){c=c||z.gl;var e=c.shaders[":blur_cubemap"];if(e)return e;e=new q.Shader(Shader.SCREEN_VERTEX_SHADER,"\n\t\t\t#ifndef NUM_SAMPLES\n\t\t\t\t#define NUM_SAMPLES 4\n\t\t\t#endif\n\t\t\t\n\t\t\tprecision highp float;\n\t\t\tvarying vec2 v_coord;\n\t\t\tuniform samplerCube u_texture;\n\t\t\tuniform mat3 u_rotation;\n\t\t\tuniform vec2 u_offset;\n\t\t\tuniform float u_intensity;\n\t\t\tvoid main() {\n\t\t\t\tvec4 sum = vec4(0.0);\n\t\t\t\tvec2 uv = vec2( v_coord.x, 1.0 - v_coord.y ) - vec2(0.5);\n\t\t\t\tvec3 dir = vec3(0.0);\n\t\t\t\tvec4 color = vec4(0.0);\n\t\t\t\tfor( int x = -2; x <= 2; x++ )\n\t\t\t\t{\n\t\t\t\t\tfor( int y = -2; y <= 2; y++ )\n\t\t\t\t\t{\n\t\t\t\t\t\tdir.xy = uv + vec2( u_offset.x * float(x), u_offset.y * float(y)) * 0.5;\n\t\t\t\t\t\tdir.z = 0.5;\n\t\t\t\t\t\tdir = u_rotation * dir;\n\t\t\t\t\t\tcolor = textureCube( u_texture, dir );\n\t\t\t\t\t\tcolor.xyz = color.xyz * color.xyz;/*linearize*/\n\t\t\t\t\t\tsum += color;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tsum /= 25.0;\n\t\t\t   gl_FragColor = vec4( sqrt( sum.xyz ), sum.w ) ;\n\t\t\t}\n\t\t\t");
return c.shaders[":blur_cubemap"]=e};Shader.FXAA_FUNC="\n\tuniform vec2 u_viewportSize;\n\tuniform vec2 u_iViewportSize;\n\t#define FXAA_REDUCE_MIN   (1.0/ 128.0)\n\t#define FXAA_REDUCE_MUL   (1.0 / 8.0)\n\t#define FXAA_SPAN_MAX     8.0\n\t\n\t/* from mitsuhiko/webgl-meincraft based on the code on geeks3d.com */\n\tvec4 applyFXAA(sampler2D tex, vec2 fragCoord)\n\t{\n\t\tvec4 color = vec4(0.0);\n\t\t/*vec2 u_iViewportSize = vec2(1.0 / u_viewportSize.x, 1.0 / u_viewportSize.y);*/\n\t\tvec3 rgbNW = texture2D(tex, (fragCoord + vec2(-1.0, -1.0)) * u_iViewportSize).xyz;\n\t\tvec3 rgbNE = texture2D(tex, (fragCoord + vec2(1.0, -1.0)) * u_iViewportSize).xyz;\n\t\tvec3 rgbSW = texture2D(tex, (fragCoord + vec2(-1.0, 1.0)) * u_iViewportSize).xyz;\n\t\tvec3 rgbSE = texture2D(tex, (fragCoord + vec2(1.0, 1.0)) * u_iViewportSize).xyz;\n\t\tvec3 rgbM  = texture2D(tex, fragCoord  * u_iViewportSize).xyz;\n\t\tvec3 luma = vec3(0.299, 0.587, 0.114);\n\t\tfloat lumaNW = dot(rgbNW, luma);\n\t\tfloat lumaNE = dot(rgbNE, luma);\n\t\tfloat lumaSW = dot(rgbSW, luma);\n\t\tfloat lumaSE = dot(rgbSE, luma);\n\t\tfloat lumaM  = dot(rgbM,  luma);\n\t\tfloat lumaMin = min(lumaM, min(min(lumaNW, lumaNE), min(lumaSW, lumaSE)));\n\t\tfloat lumaMax = max(lumaM, max(max(lumaNW, lumaNE), max(lumaSW, lumaSE)));\n\t\t\n\t\tvec2 dir;\n\t\tdir.x = -((lumaNW + lumaNE) - (lumaSW + lumaSE));\n\t\tdir.y =  ((lumaNW + lumaSW) - (lumaNE + lumaSE));\n\t\t\n\t\tfloat dirReduce = max((lumaNW + lumaNE + lumaSW + lumaSE) * (0.25 * FXAA_REDUCE_MUL), FXAA_REDUCE_MIN);\n\t\t\n\t\tfloat rcpDirMin = 1.0 / (min(abs(dir.x), abs(dir.y)) + dirReduce);\n\t\tdir = min(vec2(FXAA_SPAN_MAX, FXAA_SPAN_MAX), max(vec2(-FXAA_SPAN_MAX, -FXAA_SPAN_MAX), dir * rcpDirMin)) * u_iViewportSize;\n\t\t\n\t\tvec3 rgbA = 0.5 * (texture2D(tex, fragCoord * u_iViewportSize + dir * (1.0 / 3.0 - 0.5)).xyz + \n\t\t\ttexture2D(tex, fragCoord * u_iViewportSize + dir * (2.0 / 3.0 - 0.5)).xyz);\n\t\tvec3 rgbB = rgbA * 0.5 + 0.25 * (texture2D(tex, fragCoord * u_iViewportSize + dir * -0.5).xyz + \n\t\t\ttexture2D(tex, fragCoord * u_iViewportSize + dir * 0.5).xyz);\n\t\t\n\t\treturn vec4(rgbA,1.0);\n\t\tfloat lumaB = dot(rgbB, luma);\n\t\tif ((lumaB < lumaMin) || (lumaB > lumaMax))\n\t\t\tcolor = vec4(rgbA, 1.0);\n\t\telse\n\t\t\tcolor = vec4(rgbB, 1.0);\n\t\treturn color;\n\t}\n";
Shader.getFXAAShader=function(c){c=c||z.gl;var e=c.shaders[":fxaa"];if(e)return e;e=new q.Shader(Shader.SCREEN_VERTEX_SHADER,"\n\t\t\tprecision highp float;\n\t\t\tvarying vec2 v_coord;\n\t\t\tuniform sampler2D u_texture;\n\t\t\t"+Shader.FXAA_FUNC+"\n\t\t\t\n\t\t\tvoid main() {\n\t\t\t   gl_FragColor = applyFXAA( u_texture, v_coord * u_viewportSize) ;\n\t\t\t}\n\t\t\t");var a=vec2.fromValues(c.viewport_data[2],c.viewport_data[3]),b=vec2.fromValues(1/c.viewport_data[2],1/c.viewport_data[3]);e.setup=
function(){a[0]=c.viewport_data[2];a[1]=c.viewport_data[3];b[0]=1/c.viewport_data[2];b[1]=1/c.viewport_data[3];this.uniforms({u_viewportSize:a,u_iViewportSize:b})};return c.shaders[":fxaa"]=e};Shader.getFlatShader=function(c){c=c||z.gl;var e=c.shaders[":flat"];if(e)return e;e=new q.Shader(Shader.FLAT_VERTEX_SHADER,Shader.FLAT_FRAGMENT_SHADER);e.uniforms({u_color:[1,1,1,1]});return c.shaders[":flat"]=e};q.create=function(c){function e(n){var p=f.mouse.buttons;q.augmentEvent(n,d);n.eventType=n.eventType||
n.type;var w=getTime();l.dragging=n.dragging;l.position[0]=n.canvasx;l.position[1]=n.canvasy;l.x=n.canvasx;l.y=n.canvasy;l.clientx=n.mousex;l.clienty=n.mousey;l.left_button=l.buttons&1<<q.LEFT_MOUSE_BUTTON;l.middle_button=l.buttons&1<<q.MIDDLE_MOUSE_BUTTON;l.right_button=l.buttons&1<<q.RIGHT_MOUSE_BUTTON;if("mousedown"==n.eventType){0==p&&(d.removeEventListener("mousemove",e),p=d.ownerDocument,p.addEventListener("mousemove",e),p.addEventListener("mouseup",e));k=w;if(f.onmousedown)f.onmousedown(n);
L.trigger(f,"mousedown")}else if("mousemove"==n.eventType){if(f.onmousemove)f.onmousemove(n);L.trigger(f,"mousemove",n)}else if("mouseup"==n.eventType){0==f.mouse.buttons&&(d.addEventListener("mousemove",e),p=d.ownerDocument,p.removeEventListener("mousemove",e),p.removeEventListener("mouseup",e));n.click_time=w-k;if(f.onmouseup)f.onmouseup(n);L.trigger(f,"mouseup",n)}else if("mousewheel"==n.eventType||"wheel"==n.eventType||"DOMMouseScroll"==n.eventType){n.eventType="mousewheel";n.wheel="wheel"==n.type?
-n.deltaY:null!=n.wheelDeltaY?n.wheelDeltaY:-60*n.detail;n.delta=void 0!==n.wheelDelta?n.wheelDelta/40:n.deltaY?-n.deltaY/3:0;if(f.onmousewheel)f.onmousewheel(n);L.trigger(f,"mousewheel",n)}if(f.onmouse)f.onmouse(n);"mousemove"!=n.eventType&&n.stopPropagation();n.preventDefault();return!1}function a(n){var p=n.changedTouches,w=p[0];if(!(n.touches.length&&n.changedTouches[0].identifier!==n.touches[0].identifier||1<p)){switch(n.type){case "touchstart":var v="mousedown";break;case "touchmove":v="mousemove";
break;case "touchend":v="mouseup";break;default:return}p=document.createEvent("MouseEvent");p.initMouseEvent(v,!0,!0,window,1,w.screenX,w.screenY,w.clientX,w.clientY,!1,!1,!1,!1,0,null);w.target.dispatchEvent(p);n.preventDefault()}}function b(n){f.ongesture&&(n.eventType=n.type,f.ongesture(n));event.preventDefault()}c=c||{};var d=null;if(c.canvas)if("string"==typeof c.canvas){if(d=document.getElementById(c.canvas),!d)throw"Canvas element not found: "+c.canvas;}else d=c.canvas;else d=createCanvas(c.width||
800,c.height||600);"alpha"in c||(c.alpha=!1);try{z.gl=d.getContext("webgl",c)}catch(n){}try{z.gl=z.gl||d.getContext("experimental-webgl",c)}catch(n){}if(!z.gl)throw"WebGL not supported";var f=z.gl;d.is_webgl=!0;d.gl=f;f.context_id=this.last_context_id++;f.extensions={};f.extensions.OES_standard_derivatives=f.derivatives_supported=f.getExtension("OES_standard_derivatives")||!1;f.extensions.WEBGL_depth_texture=f.getExtension("WEBGL_depth_texture")||f.getExtension("WEBKIT_WEBGL_depth_texture")||f.getExtension("MOZ_WEBGL_depth_texture");
f.extensions.OES_element_index_uint=f.getExtension("OES_element_index_uint");f.extensions.WEBGL_draw_buffers=f.getExtension("WEBGL_draw_buffers");f.extensions.EXT_shader_texture_lod=f.getExtension("EXT_shader_texture_lod");f.extensions.EXT_sRGB=f.getExtension("EXT_sRGB");f.extensions.EXT_texture_filter_anisotropic=f.getExtension("EXT_texture_filter_anisotropic")||f.getExtension("WEBKIT_EXT_texture_filter_anisotropic")||f.getExtension("MOZ_EXT_texture_filter_anisotropic");f.extensions.EXT_frag_depth=
f.getExtension("EXT_frag_depth")||f.getExtension("WEBKIT_EXT_frag_depth")||f.getExtension("MOZ_EXT_frag_depth");f.extensions.WEBGL_lose_context=f.getExtension("WEBGL_lose_context")||f.getExtension("WEBKIT_WEBGL_lose_context")||f.getExtension("MOZ_WEBGL_lose_context");f.extensions.OES_texture_float_linear=f.getExtension("OES_texture_float_linear");f.extensions.OES_texture_float_linear&&(f.extensions.OES_texture_float=f.getExtension("OES_texture_float"));f.extensions.OES_texture_half_float_linear=f.getExtension("OES_texture_half_float_linear");
f.extensions.OES_texture_half_float_linear&&(f.extensions.OES_texture_half_float=f.getExtension("OES_texture_half_float"));f.HALF_FLOAT_OES=36193;f.extensions.OES_texture_half_float&&(f.HALF_FLOAT_OES=f.extensions.OES_texture_half_float.HALF_FLOAT_OES);f.HIGH_PRECISION_FORMAT=f.extensions.OES_texture_half_float?f.HALF_FLOAT_OES:f.extensions.OES_texture_float?f.FLOAT:f.UNSIGNED_BYTE;f.max_texture_units=f.getParameter(f.MAX_TEXTURE_IMAGE_UNITS);f._viewport_func=f.viewport;f.viewport_data=new Float32Array([0,
0,f.canvas.width,f.canvas.height]);f.viewport=function(n,p,w,v){var t=this.viewport_data;t[0]=n|0;t[1]=p|0;t[2]=w|0;t[3]=v|0;this._viewport_func(n,p,w,v)};f.getViewport=function(n){return n?(n[0]=f.viewport_data[0],n[1]=f.viewport_data[1],n[2]=f.viewport_data[2],n[3]=f.viewport_data[3],n):new Float32Array(f.viewport_data)};f.setViewport=function(n,p){f.viewport_data.set(n);p&&(f.viewport_data[1]=this.drawingBufferHeight-n[1]-n[3]);this._viewport_func(n[0],f.viewport_data[1],n[2],n[3])};if("undefined"==
typeof glMatrix)throw"glMatrix not found, LiteGL requires glMatrix to be included";var k=0;f.shaders={};f.textures={};f.meshes={};f.makeCurrent=function(){z.gl=this};f.execute=function(n){var p=z.gl;z.gl=this;n();z.gl=p};f.animate=function(n){function p(){if(!f.destroyed){t._requestFrame_id=w(p);var u=getTime(),x=.001*(u-v);if(t.onupdate)t.onupdate(x);L.trigger(f,"update",x);t.ondraw&&(x=z.gl,z.gl=t,t.ondraw(),L.trigger(f,"draw"),z.gl=x);v=u}}if(!1===n)z.cancelAnimationFrame(this._requestFrame_id),
this._requestFrame_id=null;else{var w=z.requestAnimationFrame,v=getTime(),t=this;this._requestFrame_id=w(p)}};f.destroy=function(){m&&(document.removeEventListener("keydown",m),document.removeEventListener("keyup",m));this.canvas.parentNode&&this.canvas.parentNode.removeChild(this.canvas);this.destroyed=!0;z.gl==this&&(z.gl=null)};var l=f.mouse={buttons:0,left_button:!1,middle_button:!1,right_button:!1,position:new Float32Array(2),x:0,y:0,deltax:0,deltay:0,clientx:0,clienty:0,isInsideRect:function(n,
p,w,v,t){var u=this.y;t&&(u=f.canvas.height-u);return this.x>n&&this.x<n+w&&u>p&&u<p+v?!0:!1},isButtonPressed:function(n){return this.buttons&1<<q.RIGHT_MOUSE_BUTTON}};f.captureMouse=function(n){d.addEventListener("mousedown",e);d.addEventListener("mousemove",e);n&&(d.addEventListener("mousewheel",e,!1),d.addEventListener("wheel",e,!1));d.addEventListener("contextmenu",function(p){p.preventDefault();return!1});d.addEventListener("touchstart",a,!0);d.addEventListener("touchmove",a,!0);d.addEventListener("touchend",
a,!0);d.addEventListener("touchcancel",a,!0);d.addEventListener("gesturestart",b);d.addEventListener("gesturechange",b);d.addEventListener("gestureend",b)};f.keys={};var m=null;f.captureKeys=function(n,p){function w(v){v.eventType=v.type;var t=v.target.nodeName.toLowerCase();if("input"!==t&&"textarea"!==t&&"select"!==t){v.character=String.fromCharCode(v.keyCode).toLowerCase();t=!1;var u=q.mapKeyCode(v.keyCode);u||(u=v.character);v.altKey||v.ctrlKey||v.metaKey||(u&&(f.keys[u]="keydown"==v.type),t=
f.keys[v.keyCode],f.keys[v.keyCode]="keydown"==v.type);if(t!=f.keys[v.keyCode]){if("keydown"==v.type&&f.onkeydown)f.onkeydown(v);else if("keyup"==v.type&&f.onkeyup)f.onkeyup(v);L.trigger(f,v.type,v)}if(f.onkey)f.onkey(v);n&&(v.isChar||q.blockable_keys[v.keyIdentifier||v.key])&&v.preventDefault()}}m||(f.keys={},document.addEventListener("keydown",w),document.addEventListener("keyup",w),m=w)};f.gamepads=null;f.captureGamepads=function(){var n=navigator.getGamepads||navigator.webkitGetGamepads||navigator.mozGetGamepads;
n&&(this.gamepads=n.call(navigator))};f.getGamepads=function(n){var p=navigator.getGamepads||navigator.webkitGetGamepads||navigator.mozGetGamepads;if(p){p=p.call(navigator);this.gamepads||(this.gamepads=[]);for(var w=0;4>w;w++){var v=p[w];if(v&&!n){var t=v,u={axes:[],buttons:{},hat:""};u.axes.lx=t.axes[0];u.axes.ly=t.axes[1];u.axes.rx=t.axes[2];u.axes.ry=t.axes[3];u.axes.triggers=t.axes[4];for(var x=0;x<t.buttons.length;x++)switch(x){case 0:u.buttons.a=t.buttons[x].pressed;break;case 1:u.buttons.b=
t.buttons[x].pressed;break;case 2:u.buttons.x=t.buttons[x].pressed;break;case 3:u.buttons.y=t.buttons[x].pressed;break;case 4:u.buttons.lb=t.buttons[x].pressed;break;case 5:u.buttons.rb=t.buttons[x].pressed;break;case 6:u.buttons.lt=t.buttons[x].pressed;break;case 7:u.buttons.rt=t.buttons[x].pressed;break;case 8:u.buttons.back=t.buttons[x].pressed;break;case 9:u.buttons.start=t.buttons[x].pressed;break;case 10:u.buttons.ls=t.buttons[x].pressed;break;case 11:u.buttons.rs=t.buttons[x].pressed;break;
case 12:t.buttons[x].pressed&&(u.hat+="up");break;case 13:t.buttons[x].pressed&&(u.hat+="down");break;case 14:t.buttons[x].pressed&&(u.hat+="left");break;case 15:t.buttons[x].pressed&&(u.hat+="right");break;case 16:u.buttons.home=t.buttons[x].pressed}t.xbox=u}t=this.gamepads[w];if(!t&&v){u=new CustomEvent("gamepadconnected");u.eventType=u.type;u.gamepad=v;if(this.ongamepadconnected)this.ongamepadconnected(u);L.trigger(f,"gamepadconnected",u)}else if(t&&!v){u=new CustomEvent("gamepaddisconnected");
u.eventType=u.type;u.gamepad=t;if(this.ongamepaddisconnected)this.ongamepaddisconnected(u);L.trigger(f,"gamepaddisconnected",u)}if(v)for(x=0;x<v.buttons.length;++x){var y=v.buttons[x];if(y.pressed&&(!t||!t.buttons[x].pressed)){u=new CustomEvent("gamepadButtonDown");u.eventType=u.type;u.button=y;u.which=x;u.gamepad=v;if(f.onbuttondown)f.onbuttondown(u);L.trigger(f,"buttondown",u)}else if(!y.pressed&&t&&t.buttons[x].pressed){u=new CustomEvent("gamepadButtonUp");u.eventType=u.type;u.button=y;u.which=
x;u.gamepad=v;if(f.onbuttondown)f.onbuttondown(u);L.trigger(f,"buttonup",u)}}}return this.gamepads=p}};f.fullscreen=function(){var n=this.canvas;n.requestFullScreen?n.requestFullScreen():n.webkitRequestFullScreen?n.webkitRequestFullScreen():n.mozRequestFullScreen?n.mozRequestFullScreen():console.error("Fullscreen not supported")};f.snapshot=function(n,p,w,v,t){var u=createCanvas(w,v),x=u.getContext("2d"),y=x.getImageData(0,0,u.width,u.height),B=new Uint8Array(w*v*4);f.readPixels(n,p,u.width,u.height,
f.RGBA,f.UNSIGNED_BYTE,B);y.data.set(B);x.putImageData(y,0,0);if(t)return u;n=createCanvas(w,v);x=n.getContext("2d");x.translate(0,v);x.scale(1,-1);x.drawImage(u,0,0);return n};var r={};f.loadTexture=function(n,p,w){if(this.textures[n])return this.textures[n];if(r[n])return null;var v=new Image;v.url=n;v.onload=function(){var t=q.Texture.fromImage(this,p);t.img=this;f.textures[this.url]=t;delete r[this.url];w&&w(t)};v.src=n;r[n]=!0;return null};f.drawTexture=function(){var n=mat3.create(),p=vec2.create(),
w=vec2.create(),v=vec4.create(),t=vec4.fromValues(1,1,1,1),u=vec2.create(),x={u_texture:0,u_position:p,u_color:t,u_size:w,u_texture_area:v,u_viewport:u,u_transform:n};return function(y,B,J,I,A,C,D,E,G,F,O){p[0]=B;p[1]=J;void 0===I&&(I=y.width);void 0===A&&(A=y.height);w[0]=I;w[1]=A;void 0===C&&(C=0);void 0===D&&(D=0);void 0===E&&(E=y.width);void 0===G&&(G=y.height);v[0]=C/y.width;v[1]=D/y.height;v[2]=(C+E)/y.width;v[3]=(D+G)/y.height;u[0]=this.viewport_data[2];u[1]=this.viewport_data[3];F=F||Shader.getPartialQuadShader(this);
B=Mesh.getScreenQuad(this);y.bind(0);F.uniforms(x);O&&F.uniforms(O);F.draw(B,f.TRIANGLES)}}();f.canvas.addEventListener("webglcontextlost",function(n){n.preventDefault();if(f.onlosecontext)f.onlosecontext(n)},!1);f.reset=function(){f.viewport(0,0,this.canvas.width,this.canvas.height);f.disable(f.BLEND);f.disable(f.CULL_FACE);f.disable(f.DEPTH_TEST);f.frontFace(f.CCW);f._current_texture_drawto=null;f._current_fbo_color=null;f._current_fbo_depth=null};f.reset();return f};q.mapKeyCode=function(c){return{8:"BACKSPACE",
9:"TAB",13:"ENTER",16:"SHIFT",17:"CTRL",27:"ESCAPE",32:"SPACE",37:"LEFT",38:"UP",39:"RIGHT",40:"DOWN"}[c]||(65<=c&&90>=c?String.fromCharCode(c):null)};q.dragging=!1;q.last_pos=[0,0];q.augmentEvent=function(c,e){var a=null;e=e||c.target||gl.canvas;a=e.getBoundingClientRect();c.mousex=c.clientX-a.left;c.mousey=c.clientY-a.top;c.canvasx=c.mousex;c.canvasy=a.height-c.mousey;c.deltax=0;c.deltay=0;"mousedown"==c.type?(this.dragging=!0,gl.mouse.buttons|=1<<c.which):"mousemove"!=c.type&&"mouseup"==c.type&&
(gl.mouse.buttons&=~(1<<c.which),0==gl.mouse.buttons&&(this.dragging=!1));c.deltax=c.mousex-this.last_pos[0];c.deltay=c.mousey-this.last_pos[1];this.last_pos[0]=c.mousex;this.last_pos[1]=c.mousey;c.dragging=this.dragging;c.buttons_mask=gl.mouse.buttons;c.leftButton=gl.mouse.buttons&1<<q.LEFT_MOUSE_BUTTON;c.middleButton=gl.mouse.buttons&1<<q.MIDDLE_MOUSE_BUTTON;c.rightButton=gl.mouse.buttons&1<<q.RIGHT_MOUSE_BUTTON;c.isButtonPressed=function(b){return this.buttons_mask&1<<b}};var L=z.LEvent=q.LEvent=
{bind:function(c,e,a,b){if(!c)throw"cannot bind event to null";if(!a)throw"cannot bind to null callback";if(c.constructor===String)throw"cannot bind event to a string";var d=c.__levents;d||(Object.defineProperty(c,"__levents",{value:{},enumerable:!1}),d=c.__levents);d.hasOwnProperty(e)?d[e].push([a,b]):d[e]=[[a,b]]},unbind:function(c,e,a,b){if(!c)throw"cannot unbind event to null";if(!a)throw"cannot unbind from null callback";if(c.constructor===String)throw"cannot bind event to a string";if((c=c.__levents)&&
c.hasOwnProperty(e)){for(var d=0,f=c[e].length;d<f;++d){var k=c[e][d];if(k[0]===a&&k[1]===b){c[e].splice(d,1);break}}0==c[e].length&&delete c[e]}},unbindAll:function(c,e,a){if(!c)throw"cannot unbind events in null";var b=c.__levents;if(b)if(e)for(var d in b){c=b[d];for(var f=c.length-1;0<=f;--f)c[f][1]!=e||a&&a!==c[f][0]||c.splice(f,1)}else delete c.__levents},unbindAllEvent:function(c,e){if(!c)throw"cannot unbind events in null";(c=c.__levents)&&delete c[e]},isBind:function(c,e,a,b){if(!c)throw"LEvent cannot have null as instance";
if(c=c.__levents){if(!c.hasOwnProperty(e))return!1;for(var d=0,f=c[e].length;d<f;++d){var k=c[e][d];if(k[0]===a&&k[1]===b)return!0}return!1}},hasBind:function(c,e){if(!c)throw"LEvent cannot have null as instance";return(c=c.__levents)&&c.hasOwnProperty(e)&&c[e].length?!0:!1},hasBindTo:function(c,e){if(!c)throw"LEvent cannot have null as instance";c=c.__levents;if(!c)return!1;for(var a in c)for(var b=c[a],d=0;d<b.length;++d)if(b[d][1]===e)return!0;return!1},trigger:function(c,e,a){if(!c)throw"cannot trigger event from null";
if(c.constructor===String)throw"cannot bind event to a string";c=c.__levents;if(!c||!c.hasOwnProperty(e))return!0;c=c[e];for(var b=0,d=c.length;b<d;++b){var f=c[b];if(f&&0==f[0].call(f[1],e,a))return!1}return!0},triggerArray:function(c,e,a){for(var b=0,d=c.length;b<d;++b){var f=c[b];if(!f)throw"cannot trigger event from null";if(f.constructor===String)throw"cannot bind event to a string";if((f=f.__levents)&&f.hasOwnProperty(e))for(var k=0,l=f[e].length;k<l;++k){var m=f[e][k];if(0==m[0].call(m[1],
e,a))break}}return!0},extendObject:function(c){c.on=function(e,a,b){if(!a)throw"cannot bind to null callback";var d=this.__levents;this||(Object.defineProperty(this,"__levents",{value:{},enumerable:!1}),d=this.__levents);d.hasOwnProperty(e)?d[e].push([a,b]):d[e]=[[a,b]]};c.trigger=function(e,a){var b=this.__levents;if(!b||!b.hasOwnProperty(e))return!0;b=b[e];for(var d=0,f=b.length;d<f;++d){var k=b[d];if(k&&0==k[0].call(k[1],e,a))return!1}return!0};c.unbind=function(e,a,b){if(!a)throw"cannot unbind from null callback";
var d=this.__levents;if(d&&d.hasOwnProperty(e)){for(var f=0,k=d[e].length;f<k;++f){var l=d[e][f];if(l[0]===a&&l[1]===b){d[e].splice(f,1);break}}0==d[e].length&&delete d[e]}}},extendClass:function(c){this.extendObject(c.prototype)}};z.CLIP_INSIDE=q.CLIP_INSIDE=0;z.CLIP_OUTSIDE=q.CLIP_OUTSIDE=1;z.CLIP_OVERLAP=q.CLIP_OVERLAP=2;z.geo={createPlane:function(c,e){return new Float32Array([e[0],e[1],e[2],-vec3.dot(c,e)])},distancePointToPlane:function(c,e){return(vec3.dot(c,e)+e[3])/Math.sqrt(e[0]*e[0]+e[1]*
e[1]+e[2]*e[2])},distance2PointToPlane:function(c,e){return(vec3.dot(c,e)+e[3])/(e[0]*e[0]+e[1]*e[1]+e[2]*e[2])},projectPointOnPlane:function(c,e,a,b){b=b||vec3.create();e=vec3.subtract(vec3.create(),c,e);e=vec3.dot(e,a);return vec3.subtract(b,c,vec3.scale(vec3.create(),a,e))},reflectPointInPlane:function(c,e,a){e=-(-1*(e[0]*a[0]+e[1]*a[1]+e[2]*a[2])+a[0]*c[0]+a[1]*c[1]+a[2]*c[2])/(a[0]*a[0]+a[1]*a[1]+a[2]*a[2]);return vec3.fromValues(c[0]+e*a[0]*2,c[1]+e*a[1]*2,c[2]+e*a[2]*2)},testRayPlane:function(c,
e,a,b,d){a=vec3.dot(a,b)-vec3.dot(b,c);b=vec3.dot(b,e);if(Math.abs(b)<EPSILON)return!1;b=a/b;if(0>b)return!1;d&&vec3.add(d,c,vec3.scale(d,e,b));return!0},testSegmentPlane:function(){var c=vec3.create();return function(e,a,b,d,f){b=vec3.dot(b,d)-vec3.dot(d,e);a=vec3.sub(c,a,e);d=vec3.dot(d,a);if(Math.abs(d)<EPSILON)return!1;d=b/d;if(0>d||1<d)return!1;f&&vec3.add(f,e,vec3.scale(f,a,d));return!0}}(),testRaySphere:function(){var c=vec3.create();return function(e,a,b,d,f,k){var l=vec3.subtract(c,e,b),
m=a[0]*a[0]+a[1]*a[1]+a[2]*a[2];b=2*l[0]*a[0]+2*l[1]*a[1]+2*l[2]*a[2];d=b*b-4*m*(l[0]*l[0]+l[1]*l[1]+l[2]*l[2]-d*d);if(0>d)return!1;if(f){d=Math.sqrt(d);l=1/(2*m);m=(-b+d)*l;b=(-b-d)*l;b=m<b?m:b;if(b>k)return!1;vec3.add(f,e,vec3.scale(f,a,b))}return!0}}(),testRayCylinder:function(c,e,a,b,d,f){var k=vec3.clone(c);c=vec3.add(vec3.create(),c,vec3.scale(vec3.create(),e,1E5));e=vec3.subtract(vec3.create(),b,a);var l=vec3.subtract(vec3.create(),k,a);a=vec3.subtract(vec3.create(),c,k);b=vec3.dot(l,e);c=
vec3.dot(a,e);e=vec3.dot(e,e);if(0>b&&0>b+c||b>e&&b+c>e)return!1;var m=vec3.dot(a,a),r=vec3.dot(l,a);var n=e*m-c*c;d=vec3.dot(l,l)-d*d;var p=e*d-b*b;if(Math.abs(n)<EPSILON){if(0<p)return!1;n=0>b?-r/m:b>e?(c-r)/m:0;f&&vec3.add(f,k,vec3.scale(vec3.create(),a,n));return!0}l=e*r-c*b;p=l*l-n*p;if(0>p)return!1;n=(-l-Math.sqrt(p))/n;if(0>n||1<n)return!1;if(0>b+n*c){if(0>=c)return!1;n=-b/c;f&&vec3.add(f,k,vec3.scale(vec3.create(),a,n));return 0>=d+2*n*(r+n*m)}if(b+n*c>e){if(0<=c)return!1;n=(e-b)/c;f&&vec3.add(f,
k,vec3.scale(vec3.create(),a,n));return 0>=d+e-2*b+n*(2*(r-c)+n*m)}f&&vec3.add(f,k,vec3.scale(vec3.create(),a,n));return!0},testRayBox:function(c,e,a,b,d,f){d=d||vec3.create();f=f||Number.MAX_VALUE;var k=!0,l=new Float32Array(3),m,r=new Float32Array(3),n=new Float32Array(3);for(m=0;3>m;++m)c[m]<a[m]?(l[m]=1,n[m]=a[m],k=!1):c[m]>b[m]?(l[m]=0,n[m]=b[m],k=!1):l[m]=2;if(k)return vec3.copy(d,c),!0;for(m=0;3>m;++m)r[m]=2!=l[m]&&0!=e[m]?(n[m]-c[m])/e[m]:-1;k=0;for(m=1;3>m;m++)r[k]<r[m]&&(k=m);if(0>r[k]||
r[k]>f)return!1;for(m=0;3>m;++m)if(k!=m){if(d[m]=c[m]+r[k]*e[m],d[m]<a[m]||d[m]>b[m])return!1}else d[m]=n[m];return!0},testRayBBox:function(c,e,a,b,d,f){if(b){var k=mat4.invert(mat4.create(),b);e=vec3.add(vec3.create(),c,e);c=vec3.transformMat4(vec3.create(),c,k);vec3.transformMat4(e,e,k);vec3.sub(e,e,c);e=vec3.normalize(e,e)}c=this.testRayBox(c,e,a.subarray(6,9),a.subarray(9,12),d,f);b&&vec3.transformMat4(d,d,b);return c},testPointBBox:function(c,e){return c[0]<e[6]||c[0]>e[9]||c[1]<e[7]||c[0]>e[10]||
c[2]<e[8]||c[0]>e[11]?!1:!0},testBBoxBBox:function(c,e){if(Math.abs(e[0]-c[0])>c[3]+e[3]||Math.abs(e[1]-c[1])>c[4]+e[4]||Math.abs(e[2]-c[2])>c[5]+e[5])return!1;var a=BBox.getMin(e);geo.testPointBBox(a,c)&&(a=BBox.getMax(e),geo.testPointBBox(a,c));return!0},testSphereBBox:function(c,e,a){for(var b=0,d=BBox.getMin(a),f=BBox.getMax(a),k=0;3>k;++k)c[k]<d[k]?(a=c[k]-d[k],b+=a*a):c[k]>f[k]&&(a=c[k]-f[k],b+=a*a);return b<=e*e?!0:!1},closestPointBetweenLines:function(c,e,a,b,d,f){e=vec3.subtract(vec3.create(),
e,c);b=vec3.subtract(vec3.create(),b,a);var k=vec3.subtract(vec3.create(),c,a),l=vec3.dot(e,e),m=vec3.dot(e,b),r=vec3.dot(b,b),n=vec3.dot(e,k),p=vec3.dot(b,k),w=l*r-m*m,v;w<EPSILON?(v=0,l=m>r?n/m:p/r):(v=(m*p-r*n)/w,l=(l*p-m*n)/w);d&&vec3.add(d,c,vec3.scale(vec3.create(),e,v));f&&vec3.add(f,a,vec3.scale(vec3.create(),b,l));c=vec3.add(vec3.create(),k,vec3.subtract(vec3.create(),vec3.scale(vec3.create(),e,v),vec3.scale(vec3.create(),b,l)));return vec3.length(c)},extractPlanes:function(c,e){function a(b){var d=
e.subarray(b,b+3);d=vec3.length(d);0!==d&&(d=1/d,e[b]*=d,e[b+1]*=d,e[b+2]*=d,e[b+3]*=d)}e=e||new Float32Array(24);e.set([c[3]-c[0],c[7]-c[4],c[11]-c[8],c[15]-c[12]],0);a(0);e.set([c[3]+c[0],c[7]+c[4],c[11]+c[8],c[15]+c[12]],4);a(4);e.set([c[3]+c[1],c[7]+c[5],c[11]+c[9],c[15]+c[13]],8);a(8);e.set([c[3]-c[1],c[7]-c[5],c[11]-c[9],c[15]-c[13]],12);a(12);e.set([c[3]-c[2],c[7]-c[6],c[11]-c[10],c[15]-c[14]],16);a(16);e.set([c[3]+c[2],c[7]+c[6],c[11]+c[10],c[15]+c[14]],20);a(20);return e},frustumTestBox:function(c,
e){var a=0;var b=planeBoxOverlap(c.subarray(0,4),e);if(b==CLIP_OUTSIDE)return CLIP_OUTSIDE;a+=b;b=planeBoxOverlap(c.subarray(4,8),e);if(b==CLIP_OUTSIDE)return CLIP_OUTSIDE;a+=b;b=planeBoxOverlap(c.subarray(8,12),e);if(b==CLIP_OUTSIDE)return CLIP_OUTSIDE;a+=b;b=planeBoxOverlap(c.subarray(12,16),e);if(b==CLIP_OUTSIDE)return CLIP_OUTSIDE;a+=b;b=planeBoxOverlap(c.subarray(16,20),e);if(b==CLIP_OUTSIDE)return CLIP_OUTSIDE;a+=b;b=planeBoxOverlap(c.subarray(20,24),e);return b==CLIP_OUTSIDE?CLIP_OUTSIDE:0==
a+b?CLIP_INSIDE:CLIP_OVERLAP},frustumTestSphere:function(c,e,a){var b=!1;var d=distanceToPlane(c.subarray(0,4),e);if(d<-a)return CLIP_OUTSIDE;d>=-a&&d<=a&&(b=!0);d=distanceToPlane(c.subarray(4,8),e);if(d<-a)return CLIP_OUTSIDE;d>=-a&&d<=a&&(b=!0);d=distanceToPlane(c.subarray(8,12),e);if(d<-a)return CLIP_OUTSIDE;d>=-a&&d<=a&&(b=!0);d=distanceToPlane(c.subarray(12,16),e);if(d<-a)return CLIP_OUTSIDE;d>=-a&&d<=a&&(b=!0);d=distanceToPlane(c.subarray(16,20),e);if(d<-a)return CLIP_OUTSIDE;d>=-a&&d<=a&&(b=
!0);d=distanceToPlane(c.subarray(20,24),e);if(d<-a)return CLIP_OUTSIDE;d>=-a&&d<=a&&(b=!0);return b?CLIP_OVERLAP:CLIP_INSIDE},testPoint2DInPolygon:function(c,e){for(var a=!1,b=-1,d=c.length,f=d-1;++b<d;f=b)(c[b][1]<=e[1]&&e[1]<c[f][1]||c[f][1]<=e[1]&&e[1]<c[b][1])&&e[0]<(c[f][0]-c[b][0])*(e[1]-c[b][1])/(c[f][1]-c[b][1])+c[b][0]&&(a=!a);return a}};z.BBox=q.BBox={center:0,halfsize:3,min:6,max:9,radius:12,data_length:13,corners:new Float32Array([1,1,1,1,1,-1,1,-1,1,1,-1,-1,-1,1,1,-1,1,-1,-1,-1,1,-1,
-1,-1]),tmp_corners:new Float32Array(24),create:function(){return new Float32Array(13)},clone:function(c){return new Float32Array(c)},copy:function(c,e){c.set(e);return c},fromPoint:function(c){var e=this.create();e.set(c,0);e.set(c,6);e.set(c,9);return e},fromMinMax:function(c,e){var a=this.create();this.setMinMax(a,c,e);return a},fromCenterHalfsize:function(c,e){var a=this.create();this.setCenterHalfsize(a,c,e);return a},fromPoints:function(c){var e=this.create();this.setFromPoints(e,c);return e},
setFromPoints:function(c,e){var a=c.subarray(6,9),b=c.subarray(9,12);a.set(e.subarray(0,3));b.set(a);for(var d,f=3,k=e.length;f<k;f+=3)d=e.subarray(f,f+3),vec3.min(a,d,a),vec3.max(b,d,b);a=vec3.add(c.subarray(0,3),a,b);vec3.scale(a,a,.5);vec3.subtract(c.subarray(3,6),b,a);c[12]=vec3.length(c.subarray(3,6));return c},setMinMax:function(c,e,a){c[6]=e[0];c[7]=e[1];c[8]=e[2];c[9]=a[0];c[10]=a[1];c[11]=a[2];var b=c.subarray(3,6);vec3.sub(b,a,e);vec3.scale(b,b,.5);c[0]=a[0]-b[0];c[1]=a[1]-b[1];c[2]=a[2]-
b[2];c[12]=vec3.length(c.subarray(3,6));return c},setCenterHalfsize:function(c,e,a,b){c[0]=e[0];c[1]=e[1];c[2]=e[2];c[3]=a[0];c[4]=a[1];c[5]=a[2];vec3.sub(c.subarray(6,9),c.subarray(0,3),c.subarray(3,6));vec3.add(c.subarray(9,12),c.subarray(0,3),c.subarray(3,6));c[12]=b?b:vec3.length(a);return c},transformMat4:function(c,e,a){var b=e.subarray(3,6),d=this.tmp_corners;d.set(this.corners);for(var f=0;8>f;++f){var k=d.subarray(3*f,3*f+3);vec3.multiply(k,b,k);vec3.add(k,k,e);mat4.multiplyVec3(k,a,k)}return this.setFromPoints(c,
d)},getCorners:function(c,e){var a=c.subarray(3,6),b=null;e?(e.set(this.corners),b=e):b=new Float32Array(this.corners);for(e=0;8>e;++e){var d=b.subarray(3*e,3*e+3);vec3.multiply(d,a,d);vec3.add(d,d,c)}return b},merge:function(c,e,a){var b=c.subarray(6,9),d=c.subarray(9,12);vec3.min(b,e.subarray(6,9),a.subarray(6,9));vec3.max(d,e.subarray(9,12),a.subarray(9,12));return BBox.setMinMax(c,b,d)},extendToPoint:function(c,e){e[0]<c[6]?c[6]=e[0]:e[0]>c[9]&&(c[9]=e[0]);e[1]<c[7]?c[7]=e[1]:e[1]>c[10]&&(c[10]=
e[1]);e[2]<c[8]?c[8]=e[2]:e[2]>c[11]&&(c[11]=e[2]);e=c.subarray(6,9);var a=c.subarray(9,12);e=vec3.add(c.subarray(0,3),e,a);vec3.scale(e,e,.5);vec3.subtract(c.subarray(3,6),a,e);c[12]=vec3.length(c.subarray(3,6));return c},getCenter:function(c){return c.subarray(0,3)},getHalfsize:function(c){return c.subarray(3,6)},getMin:function(c){return c.subarray(6,9)},getMax:function(c){return c.subarray(9,12)},getRadius:function(c){return c[12]}};z.distanceToPlane=q.distanceToPlane=function(c,e){return vec3.dot(c,
e)+c[3]};z.planeBoxOverlap=q.planeBoxOverlap=function(c,e){var a=c[3],b=vec3.fromValues(Math.abs(e[3]*c[0]),Math.abs(e[4]*c[1]),Math.abs(e[5]*c[2]));b=b[0]+b[1]+b[2];a=vec3.dot(c,e)+a;return a<=-b?CLIP_OUTSIDE:a<=b?CLIP_OVERLAP:CLIP_INSIDE};z.Octree=q.Octree=function(c){this.root=null;this.total_nodes=this.total_depth=0;c&&(this.buildFromMesh(c),this.total_nodes=this.trim())};Octree.MAX_NODE_TRIANGLES_RATIO=.1;Octree.MAX_OCTREE_DEPTH=8;Octree.OCTREE_MARGIN_RATIO=.01;Octree.OCTREE_MIN_MARGIN=.1;Octree.prototype.buildFromMesh=
function(c){this.total_nodes=this.total_depth=0;var e=c.getBuffer("vertices").data;if(c=c.getIndexBuffer("triangles"))c=c.data;var a=this.computeAABB(e);this.root=a;this.total_nodes=1;this.total_triangles=c?c.length/3:e.length/9;this.max_node_triangles=this.total_triangles*Octree.MAX_NODE_TRIANGLES_RATIO;var b=vec3.create();vec3.scale(b,a.size,Octree.OCTREE_MARGIN_RATIO);b[0]<Octree.OCTREE_MIN_MARGIN&&(b[0]=Octree.OCTREE_MIN_MARGIN);b[1]<Octree.OCTREE_MIN_MARGIN&&(b[1]=Octree.OCTREE_MIN_MARGIN);b[2]<
Octree.OCTREE_MIN_MARGIN&&(b[2]=Octree.OCTREE_MIN_MARGIN);vec3.sub(a.min,a.min,b);vec3.add(a.max,a.max,b);a.faces=[];a.inside=0;if(c)for(b=0;b<c.length;b+=3){var d=new Float32Array([e[3*c[b]],e[3*c[b]+1],e[3*c[b]+2],e[3*c[b+1]],e[3*c[b+1]+1],e[3*c[b+1]+2],e[3*c[b+2]],e[3*c[b+2]+1],e[3*c[b+2]+2]]);this.addToNode(d,a,0)}else for(b=0;b<e.length;b+=9)d=new Float32Array(e.subarray(b,b+9)),this.addToNode(d,a,0);return a};Octree.prototype.addToNode=function(c,e,a){e.inside+=1;if(e.c){var b=this.computeAABB(c),
d=!1,f;for(f in e.c){var k=e.c[f];if(Octree.isInsideAABB(b,k)){this.addToNode(c,k,a+1);d=!0;break}}d||(null==e.faces&&(e.faces=[]),e.faces.push(c))}else if(null==e.faces&&(e.faces=[]),e.faces.push(c),e.faces.length>this.max_node_triangles&&a<Octree.MAX_OCTREE_DEPTH){this.splitNode(e);this.total_depth<a+1&&(this.total_depth=a+1);var l=e.faces.concat();e.faces=null;for(f in l){c=l[f];b=this.computeAABB(c);d=!1;for(var m in e.c)if(k=e.c[m],Octree.isInsideAABB(b,k)){this.addToNode(c,k,a+1);d=!0;break}d||
(null==e.faces&&(e.faces=[]),e.faces.push(c))}}};Octree.prototype.octree_pos_ref=[[0,0,0],[0,0,1],[0,1,0],[0,1,1],[1,0,0],[1,0,1],[1,1,0],[1,1,1]];Octree.prototype.splitNode=function(c){c.c=[];var e=[.5*(c.max[0]-c.min[0]),.5*(c.max[1]-c.min[1]),.5*(c.max[2]-c.min[2])],a;for(a in this.octree_pos_ref){var b=this.octree_pos_ref[a],d={};this.total_nodes+=1;d.min=[c.min[0]+e[0]*b[0],c.min[1]+e[1]*b[1],c.min[2]+e[2]*b[2]];d.max=[d.min[0]+e[0],d.min[1]+e[1],d.min[2]+e[2]];d.faces=null;d.inside=0;c.c.push(d)}};
Octree.prototype.computeAABB=function(c){for(var e=new Float32Array([c[0],c[1],c[2]]),a=new Float32Array([c[0],c[1],c[2]]),b=0;b<c.length;b+=3)for(var d=0;3>d;d++)e[d]>c[b+d]&&(e[d]=c[b+d]),a[d]<c[b+d]&&(a[d]=c[b+d]);return{min:e,max:a,size:vec3.sub(vec3.create(),a,e)}};Octree.prototype.trim=function(c){c=c||this.root;if(!c.c)return 1;for(var e=1,a=[],b=c.c,d=0;d<b.length;++d)b[d].inside&&(a.push(b[d]),e+=this.trim(b[d]));c.c=a;return e};Octree.prototype.testRay=function(){var c=vec3.create(),e=vec3.create(),
a=vec3.create(),b=vec3.create();return function(d,f,k,l){if(!this.root)throw"Error: octree not build";c.set(d);e.set(f);a.set(this.root.min);b.set(this.root.max);k=Octree.hitTestBox(c,e,a,b);if(!k)return null;k=Octree.testRayInNode(this.root,c,e);return null!=k?(f=vec3.scale(vec3.create(),f,k.t),vec3.add(f,f,d),k.pos=f,k):null}}();Octree.prototype.testSphere=function(c,e){c=vec3.clone(c);if(!this.root)throw"Error: octree not build";e*=e;return Octree.testSphereBox(c,e,vec3.clone(this.root.min),vec3.clone(this.root.max))?
Octree.testSphereInNode(this.root,c,e):!1};Octree.testRayInNode=function(c,e,a){var b=null;if(c.faces)for(var d=0,f=c.faces.length;d<f;++d){var k=c.faces[d];var l=Octree.hitTestTriangle(e,a,k.subarray(0,3),k.subarray(3,6),k.subarray(6,9));null!=l&&(l.face=k,b?b.mergeWith(l):b=l)}f=vec3.create();k=vec3.create();if(c.c)for(d=0;d<c.c.length;++d){var m=c.c[d];f.set(m.min);k.set(m.max);l=Octree.hitTestBox(e,a,f,k);null==l||b&&l.t>b.t||(l=Octree.testRayInNode(m,e,a),null!=l&&(b?b.mergeWith(l):b=l))}return b};
Octree.testSphereInNode=function(c,e,a){if(c.faces)for(var b=0,d=c.faces.length;b<d;++b){var f=c.faces[b];if(Octree.testSphereTriangle(e,a,f.subarray(0,3),f.subarray(3,6),f.subarray(6,9)))return!0}d=vec3.create();f=vec3.create();var k;if(c.c)for(b=0;b<c.c.length;++b)if(k=c.c[b],d.set(k.min),f.set(k.max),Octree.testSphereBox(e,a,d,f)&&Octree.testSphereInNode(k,e,a))return!0;return!1};Octree.isInsideAABB=function(c,e){return c.min[0]<e.min[0]||c.min[1]<e.min[1]||c.min[2]<e.min[2]||c.max[0]>e.max[0]||
c.max[1]>e.max[1]||c.max[2]>e.max[2]?!1:!0};Octree.hitTestBox=function(){var c=vec3.create(),e=vec3.create(),a=vec3.create(),b=vec3.create(),d=vec3.create(),f=vec3.create(),k=vec3.fromValues(1E-6,1E-6,1E-6);return function(l,m,r,n){vec3.subtract(c,r,l);vec3.subtract(e,n,l);if(0>vec3.maxValue(c)&&0<vec3.minValue(e))return new HitTest(0,l,m);a[0]=1/m[0];a[1]=1/m[1];a[2]=1/m[2];vec3.multiply(c,c,a);vec3.multiply(e,e,a);vec3.min(b,c,e);vec3.max(d,c,e);var p=vec3.maxValue(b),w=vec3.minValue(d);return 0<
p&&p<w?(l=vec3.add(vec3.create(),vec3.scale(f,m,p),l),vec3.add(r,r,k),vec3.subtract(r,r,k),new HitTest(p,l,vec3.fromValues((l[0]>n[0])-(l[0]<r[0]),(l[1]>n[1])-(l[1]<r[1]),(l[2]>n[2])-(l[2]<r[2])))):null}}();Octree.hitTestTriangle=function(){var c=vec3.create(),e=vec3.create(),a=vec3.create(),b=vec3.create();return function(d,f,k,l,m){vec3.subtract(c,l,k);vec3.subtract(e,m,k);l=vec3.cross(vec3.create(),c,e);vec3.normalize(l,l);if(0<vec3.dot(l,f))return null;m=vec3.dot(l,vec3.subtract(b,k,d))/vec3.dot(l,
f);if(0<m){f=vec3.scale(vec3.create(),f,m);vec3.add(f,f,d);vec3.subtract(a,f,k);d=vec3.dot(e,e);k=vec3.dot(e,c);var r=vec3.dot(e,a),n=vec3.dot(c,c),p=vec3.dot(c,a),w=d*n-k*k;n=(n*r-k*p)/w;d=(d*p-k*r)/w;if(0<=n&&0<=d&&1>=n+d)return new HitTest(m,f,l)}return null}}();Octree.testSphereTriangle=function(){var c=vec3.create(),e=vec3.create(),a=vec3.create(),b=vec3.create(),d=vec3.create(),f=vec3.create(),k=vec3.create(),l=vec3.create();return function(m,r,n,p,w){vec3.sub(c,n,m);vec3.sub(e,p,m);vec3.sub(a,
w,m);vec3.sub(b,e,c);vec3.sub(d,a,c);vec3.cross(l,b,d);m=vec3.dot(c,l);n=vec3.dot(l,l);m=m*m>r*n;var v=vec3.dot(c,c),t=vec3.dot(c,e),u=vec3.dot(c,a),x=vec3.dot(e,e),y=vec3.dot(e,a),B=vec3.dot(a,a);n=v>r&t>v&u>v;p=x>r&t>x&y>x;w=B>r&u>B&y>B;v=t-v;t=y-x;var J=u-B;vec3.sub(f,a,e);vec3.sub(k,c,a);x=vec3.dot(b,b);B=vec3.dot(f,f);u=vec3.dot(k,k);y=vec3.scale(vec3.create(),c,x);vec3.sub(y,y,vec3.scale(vec3.create(),b,v));v=vec3.scale(vec3.create(),e,B);vec3.sub(v,v,vec3.scale(vec3.create(),f,t));t=vec3.scale(vec3.create(),
a,u);vec3.sub(t,t,vec3.scale(vec3.create(),k,J));var I=vec3.scale(vec3.create(),a,x);I=vec3.sub(I,I,y);var A=vec3.scale(vec3.create(),c,B);A=vec3.sub(A,A,v);J=vec3.scale(vec3.create(),e,u);J=vec3.sub(J,J,t);x=vec3.dot(y,y)>r*x*x&0<vec3.dot(y,I);B=vec3.dot(v,v)>r*B*B&0<vec3.dot(v,A);r=vec3.dot(t,t)>r*u*u&0<vec3.dot(t,J);return!(m|n|p|w|x|B|r)}}();Octree.testSphereBox=function(c,e,a,b){for(var d,f=0,k=0;3>k;++k)c[k]<a[k]?(d=c[k]-a[k],f+=d*d):c[k]>b[k]&&(d=c[k]-b[k],f+=d*d);return f<=e?!0:!1};z.HitTest=
q.HitTest=function(c,e,a){this.t=arguments.length?c:Number.MAX_VALUE;this.hit=e;this.normal=a;this.face=null};HitTest.prototype={mergeWith:function(c){0<c.t&&c.t<this.t&&(this.t=c.t,this.hit=c.hit,this.normal=c.normal,this.face=c.face)}};z.Raytracer=q.Raytracer=function(c,e){this.viewport=vec4.create();this.ray00=vec3.create();this.ray10=vec3.create();this.ray01=vec3.create();this.ray11=vec3.create();this.eye=vec3.create();this.setup(c,e)};Raytracer.prototype.setup=function(c,e){e=e||gl.viewport_data;
this.viewport.set(e);var a=e[0],b=a+e[2],d=e[1],f=d+e[3];vec3.set(this.ray00,a,d,1);vec3.set(this.ray10,b,d,1);vec3.set(this.ray01,a,f,1);vec3.set(this.ray11,b,f,1);vec3.unproject(this.ray00,this.ray00,c,e);vec3.unproject(this.ray10,this.ray10,c,e);vec3.unproject(this.ray01,this.ray01,c,e);vec3.unproject(this.ray11,this.ray11,c,e);a=this.eye;vec3.unproject(a,a,c,e);vec3.subtract(this.ray00,this.ray00,a);vec3.subtract(this.ray10,this.ray10,a);vec3.subtract(this.ray01,this.ray01,a);vec3.subtract(this.ray11,
this.ray11,a)};Raytracer.prototype.getRayForPixel=function(){var c=vec3.create(),e=vec3.create();return function(a,b,d){d=d||vec3.create();a=(a-this.viewport[0])/this.viewport[2];b=1-(b-this.viewport[1])/this.viewport[3];vec3._lerp(c,this.ray00,this.ray10,a);vec3._lerp(e,this.ray01,this.ray11,a);vec3._lerp(d,c,e,b);return vec3.normalize(d,d)}}();var N=mat4.create();Raytracer.hitTestBox=function(c,e,a,b,d){var f=new Float32Array(30);d&&(d=mat4.invert(N,d),c=mat4.multiplyVec3(f.subarray(3,6),d,c),e=
mat4.rotateVec3(f.subarray(6,9),d,e));var k=vec3.subtract(f.subarray(9,12),a,c);vec3.divide(k,k,e);var l=vec3.subtract(f.subarray(12,15),b,c);vec3.divide(l,l,e);d=vec3.min(f.subarray(15,18),k,l);k=vec3.max(f.subarray(18,21),k,l);d=vec3.maxValue(d);k=vec3.minValue(k);return 0<d&&d<=k?(e=vec3.scale(f.subarray(21,24),e,d),vec3.add(e,c,e),vec3.addValue(f.subarray(24,27),a,1E-6),vec3.subValue(f.subarray(27,30),b,1E-6),new HitTest(d,e,vec3.fromValues((e[0]>b[0])-(e[0]<a[0]),(e[1]>b[1])-(e[1]<a[1]),(e[2]>
b[2])-(e[2]<a[2])))):null};Raytracer.hitTestSphere=function(c,e,a,b){var d=vec3.subtract(vec3.create(),c,a),f=vec3.dot(e,e),k=2*vec3.dot(e,d);d=vec3.dot(d,d)-b*b;d=k*k-4*f*d;return 0<d?(f=(-k-Math.sqrt(d))/(2*f),c=vec3.add(vec3.create(),c,vec3.scale(vec3.create(),e,f)),new HitTest(f,c,vec3.scale(vec3.create(),vec3.subtract(vec3.create(),c,a),1/b))):null};Raytracer.hitTestTriangle=function(c,e,a,b,d){var f=vec3.subtract(vec3.create(),b,a),k=vec3.subtract(vec3.create(),d,a);d=vec3.cross(vec3.create(),
f,k);vec3.normalize(d,d);b=vec3.dot(d,vec3.subtract(vec3.create(),a,c))/vec3.dot(d,e);if(0<b){c=vec3.add(vec3.create(),c,vec3.scale(vec3.create(),e,b));var l=vec3.subtract(vec3.create(),c,a);a=vec3.dot(k,k);e=vec3.dot(k,f);k=vec3.dot(k,l);var m=vec3.dot(f,f);f=vec3.dot(f,l);l=a*m-e*e;m=(m*k-e*f)/l;f=(a*f-e*k)/l;if(0<=m&&0<=f&&1>=m+f)return new HitTest(b,c,d)}return null};Mesh.parseOBJ=function(c,e){e=e||{};for(var a=[],b=[],d=[],f=[],k=[],l=[],m=[],r={},n=0,p=null,w=0,v,t=0,u,x,y=null,B=!1,J=!1,I=
!1,A=!1,C=0,D=e.noindex?e.noindex:1E7<c.length?!0:!1,E=e.flipAxis,G=E||e.flipNormals,F=null,O=[],Q=c.split("\n"),R=Q.length,T=0;T<R;++T)if(p=Q[T].replace(/[ \t]+/g," ").replace(/\s\s*$/,""),"#"!=p[0]&&""!=p)if(y=p.split(" "),A&&"v"==y[0]&&(A=!1),"v"==y[0])E?k.push(-1*parseFloat(y[1]),parseFloat(y[3]),parseFloat(y[2])):k.push(parseFloat(y[1]),parseFloat(y[2]),parseFloat(y[3]));else if("vt"==y[0])l.push(parseFloat(y[1]),parseFloat(y[2]));else if("vn"==y[0])G?m.push(-parseFloat(y[2]),-parseFloat(y[3]),
parseFloat(y[1])):m.push(parseFloat(y[1]),parseFloat(y[2]),parseFloat(y[3]));else if("f"==y[0]){if(A=!0,!(4>y.length)){var H=[];for(p=1;p<y.length;++p){if(!(y[p]in r)||D){c=y[p].split("/");if(1==c.length)c=v=w=parseInt(c[0])-1;else if(2==c.length)w=parseInt(c[0])-1,v=parseInt(c[1])-1,c=-1;else if(3==c.length)w=parseInt(c[0])-1,v=parseInt(c[1])-1,c=parseInt(c[2])-1;else return console.err("Problem parsing: unknown number of values per face"),!1;3<p&&D&&(t=a.length,a.push(a[t-9*(p-3)],a[t-9*(p-3)+1],
a[t-9*(p-3)+2]),a.push(a[t-3],a[t-2],a[t-1]),t=b.length,b.push(b[t-6*(p-3)],b[t-6*(p-3)+1]),b.push(b[t-2],b[t-1]),t=d.length,d.push(d[t-9*(p-3)],d[t-9*(p-3)+1],d[t-9*(p-3)+2]),d.push(d[t-3],d[t-2],d[t-1]));x=u=t=0;3*w+2<k.length&&(B=!0,t=k[3*w],u=k[3*w+1],x=k[3*w+2]);a.push(t,u,x);u=t=0;2*v+1<l.length&&(J=!0,t=l[2*v],u=l[2*v+1]);b.push(t,u);u=t=0;x=1;-1!=c&&(3*c+2<m.length&&(I=!0,t=m[3*c],u=m[3*c+1],x=m[3*c+2]),d.push(t,u,x));D||(r[y[p]]=n++)}D||(w=r[y[p]],H.push(w),C<w&&(C=w))}if(!D)for(p=2;p<H.length;p++)f.push(H[0],
H[p-1],H[p])}}else"g"==y[0]||"usemtl"==y[0]?1<y.length&&(null!=F&&(F.length=f.length-F.start,0<F.length&&O.push(F)),F={name:y[1],start:f.length,length:-1,material:""}):"usemtl"==y[0]&&F&&(F.material=y[1]);if(!k.length)return console.error("OBJ doesnt have vertices, maybe the file is not a OBJ"),null;F&&1<f.length-F.start&&(F.length=f.length-F.start,O.push(F));if((65536<C||D)&&0<f.length){console.log("Deindexing mesh...");k=new Float32Array(3*f.length);l=d&&d.length?new Float32Array(3*f.length):null;
m=b&&b.length?new Float32Array(2*f.length):null;for(p=0;p<f.length;p+=1)k.set(a.slice(3*f[p],3*f[p]+3),3*p),l&&l.set(d.slice(3*f[p],3*f[p]+3),3*p),m&&m.set(b.slice(2*f[p],2*f[p]+2),2*p);a=k;l&&(d=l);m&&(b=m);f=null}p={};B&&(p.vertices=new Float32Array(a));I&&0<d.length&&(p.normals=new Float32Array(d));J&&0<b.length&&(p.coords=new Float32Array(b));f&&0<f.length&&(p.triangles=new Uint16Array(f));a={};1<O.length&&(a.groups=O);p.info=a;O=Mesh.load(p,null,e.mesh);O.updateBounding();return O};Mesh.parsers.obj=
Mesh.parseOBJ.bind(Mesh);Mesh.encoders.obj=function(c,e){e=c.getBuffer("vertices");if(!e)return null;var a="# Generated with liteGL.js by Javi Agenjo\n\n";e=e.data;for(var b=0;b<e.length;b+=3)a+="v "+e[b].toFixed(4)+" "+e[b+1].toFixed(4)+" "+e[b+2].toFixed(4)+"\n";if(b=c.getBuffer("normals")){a+="\n";var d=b.data;for(b=0;b<d.length;b+=3)a+="vn "+d[b].toFixed(4)+" "+d[b+1].toFixed(4)+" "+d[b+2].toFixed(4)+"\n"}if(b=c.getBuffer("coords"))for(a+="\n",d=b.data,b=0;b<d.length;b+=2)a+="vt "+d[b].toFixed(4)+
" "+d[b+1].toFixed(4)+"  0.0000\n";a+="\ng mesh\n";if(b=c.getIndexBuffer("triangles"))for(e=b.data,b=0;b<e.length;b+=3)a+="f "+(e[b]+1)+"/"+(e[b]+1)+"/"+(e[b]+1)+" "+(e[b+1]+1)+"/"+(e[b+1]+1)+"/"+(e[b+1]+1)+" "+(e[b+2]+1)+"/"+(e[b+2]+1)+"/"+(e[b+2]+1)+"\n";else for(b=0;b<e.length/3;b+=3)a+="f "+(b+1)+"/"+(b+1)+"/"+(b+1)+" "+(b+2)+"/"+(b+2)+"/"+(b+2)+" "+(b+3)+"/"+(b+3)+"/"+(b+3)+"\n";return a}})("undefined"!=typeof window?window:"undefined"!=typeof self?self:global);
